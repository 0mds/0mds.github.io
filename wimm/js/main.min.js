const datasets=[{label:"People",backgroundColor:"#20ED3D"},{label:"Food",backgroundColor:"#AFFF5F"},{label:"Living",backgroundColor:"#FFFF59"},{label:"Travel",backgroundColor:"#FFA953"},{label:"Entertainment",backgroundColor:"#FF4D4D"}];let stats=localStorage.stats?JSON.parse(atob(localStorage.stats))||{}:{};const categories=Object.values(datasets).map(a=>a.label);let chart;const sum=(b,a=a=>a)=>b.reduce((b,c)=>b+a(c),0),is_empty=a=>0===Object.entries(a).length,add=(a,b)=>+(a+b).toFixed(2),parse=str=>{try{return eval(str.replace(/[^0-9\.\+\-\*\/\(\)]/g,""))}catch(a){return NaN}},highlight=a=>{a.classList.add("transition","highlight"),setTimeout(()=>a.classList.remove("highlight"),500)},expand=(a,b=!0)=>{let c=document.querySelectorAll(".expanded"),d=!Array.from(c).includes(a),e=!b&&a?a.querySelector(".graph"):null;c.forEach(a=>a.classList.remove("expanded")),d&&a&&(!b&&e&&e.classList.add("no_transition"),a.classList.add("expanded"),!b&&e&&(e.offsetHeight,e.classList.remove("no_transition")))},save_stats=(a=null)=>{is_empty(stats)?localStorage.removeItem("stats"):localStorage.stats=btoa(JSON.stringify(stats)),is_empty(stats)?document.querySelector(".list").innerHTML="":show_stats(a)},show_stats=(a=null)=>{let b=document.querySelector(".list"),c=!1;for(let[e,f]of Object.entries(stats).sort((c,a)=>c[0]-a[0]))if(!document.querySelector(".y_"+e)){b.insertAdjacentHTML("afterbegin",`<div class='year y_${e}'><div class='title'><span class='date'>${e}</span><span class='sum'>Spent: ${sum(Object.values(f),a=>sum(Object.values(a)))}</span></div><div class='graph'><div><canvas></canvas></div></div></div>`);let a=[],d={};for(let a of categories)d[a]=Array.from({length:12},()=>0);for(let b=0;12>b;b++){if(f[b])for(let[a,c]of Object.entries(f[b]))d[a]&&(d[a][b]=add(d[a][b],c));a.push(new Date(e,b).toLocaleString("default",{month:"long"}))}let g=document.querySelector(`.y_${e} canvas`).getContext("2d");chart=new Chart(g,{type:"bar",data:{labels:a,datasets:datasets.map(a=>Object.assign({barPercentage:.9,categoryPercentage:1,data:d[a.label]},a))},options:{maintainAspectRatio:!1,scales:{xAxes:[{stacked:!0}],yAxes:[{stacked:!0,ticks:{beginAtZero:!0}}]}}})}else if(a&&e==new Date().getFullYear()){let b=chart.data.datasets.find(b=>b.label===a.category).data;b[new Date().getMonth()]=add(b[new Date().getMonth()],a.price),chart.update(),document.querySelector(`.y_${e} .sum`).innerHTML="Spent: "+sum(Object.values(f),a=>sum(Object.values(a))),c=!0}a&&(!a||c)||expand(document.querySelector(".year"),!!a)};document.getElementById("entry_add").addEventListener("click",()=>{let a=parse(document.getElementById("entry_price").value),b=document.getElementById("entry_category").value;if(a=add(a,0),!(a&&0!=a))highlight(document.getElementById("entry_price"));else if(categories.includes(b)){let c=new Date,d=c.getFullYear(),e=c.getMonth();stats[d]?stats[d][e]?stats[d][e][b]?(stats[d][e][b]=add(stats[d][e][b],a),0==stats[d][e][b]&&(delete stats[d][e][b],is_empty(stats[d][e])&&delete stats[d][e])):stats[d][e][b]=a:stats[d][e]={[b]:a}:stats[d]={[e]:{[b]:a}},save_stats({price:a,category:b})}else highlight(document.getElementById("entry_category"));document.getElementById("entry_price").value=""}),document.getElementById("reset").addEventListener("click",()=>{stats={},save_stats()}),document.querySelector(".list").addEventListener("click",a=>a.target.closest(".graph")?"":expand(a.target.closest(".year"))),document.querySelector("#entry_category").insertAdjacentHTML("beforeend",categories.reduce((a,b)=>a+`<option value='${b}'>${b}</option>`,"")),show_stats();