//! Copyright 2023 0mds
"use strict";(()=>{var $=class{};var w=class{constructor(t){this.angle=0;this.sin=0;this.cos=1;this.tan=0;this.set(t)}set(t){this.angle=t,this.sin=Math.sin(t),this.cos=Math.cos(t),this.tan=Math.tan(t)}};function st(m,t,e){return t<m.length?m.reduce((i,s,r)=>(r!=t?i.push(s):i.push(e,s),i),[]):[...m,e]}function rt(m,t){let e=m.slice(t,m.length);return e.push(...m.slice(0,t)),e}var nt=1e-5;function ht(m,t){return m===t?!0:m==null||t==null||m.length!==t.length?!1:(m=[...m].sort(),t=[...t].sort(),m.every((e,i)=>e===t[i]))}function B(m,t){return Math.abs(m-t)<nt}function G(m,t){return m<=t+nt}var F=class{constructor(...t){let e=this.constructor.dimensions;if(e>0&&t.length!=e)throw new Error("Invalid number of dimensions");this.values=t}ct(t){return new this.constructor(...t)}static parse(t){return new this(...t.split("_").map(e=>parseInt(e)))}static _(t=0){return new this(...Array(this.dimensions||t).fill(0))}static ee(t){let e=t.split("_").map(i=>parseInt(i));return typeof t=="string"&&(this.dimensions<=0||e.length===this.dimensions)&&e.every(i=>!isNaN(i))}S(){return this.ct(this.values)}map(t){return this.ct(this.values.map(t))}l(t){return this.map(e=>t*e)}add(t){if(this.values.length!=t.values.length)throw new Error("Vectors of differing dimensionality");return this.ct(this.values.map((e,i)=>e+t.values[i]))}L(t){if(this.values.length!=t.values.length)throw new Error("Vectors of differing dimensionality");return t.add(this.l(-1))}isEqual(t){return this.values.length===t.values.length&&this.values.every((e,i)=>B(e,t.values[i]))}get length(){return Math.sqrt(this.values.reduce((t,e)=>t+Math.pow(e,2),0))}get Ot(){return Math.max(...this.values.map(Math.abs))}toString(){return this.values.join("_")}};F.dimensions=0;var y=class extends F{get x(){return this.values[0]}set x(t){this.values[0]=t}get y(){return this.values[1]}set y(t){this.values[1]=t}};y.dimensions=2;var c=class extends F{static angle(t,e){return new this(-t.sin*e.cos,e.sin,t.cos*e.cos)}Ee(t){return this.ct([this.values[1]*t.values[2]-this.values[2]*t.values[1],this.values[2]*t.values[0]-this.values[0]*t.values[2],this.values[0]*t.values[1]-this.values[1]*t.values[0]])}Pe(t,e){let i=this.S();return i[t]+=e,i}Z(t){return this.x+=t,this}ut(t){return this.y+=t,this}G(t){return this.z+=t,this}get x(){return this.values[0]}set x(t){this.values[0]=t}get y(){return this.values[1]}set y(t){this.values[1]=t}get z(){return this.values[2]}set z(t){this.values[2]=t}};c.dimensions=3;var I=class{constructor(t,e){this.range=[0,1];this.start=t,this.end=e,this.p=t.L(e)}Oe(t,e){return this.range=[t,e],this}kt(t){return t>=this.range[0]&&t<=this.range[1]}l(t){return this.start.add(this.p.l(t))}ie(t){let e=[...Array(3).keys()].find((s,r)=>!B(this.p.values[r],0));if(typeof e!="number")return!1;let i=(t.values[e]-this.start.values[e])/this.p.values[e];return this.kt(i)&&this.l(i).isEqual(t)}ke(t){let e=[...Array(3).keys()].find((r,n,h)=>n<h.length-1&&!B(this.p.values[n+1]*t.p.values[n],this.p.values[n]*t.p.values[n+1]));if(typeof e!="number")return!1;let i=(this.p.values[e]*(t.start.values[e+1]-this.start.values[e+1])-this.p.values[e+1]*(t.start.values[e]-this.start.values[e]))/(this.p.values[e+1]*t.p.values[e]-this.p.values[e]*t.p.values[e+1]),s=t.l(i);return t.kt(i)&&this.ie(s)?s:!1}se(t){let e=t.bt(this.start.L(t.start))/t.bt(this.p);return this.kt(e)?this.l(e):!1}De(t){let e=this.se(t.Dt);return e&&t.Ae(e)?e:!1}},A=class{constructor(t,e,i){this.start=t,this.re=[e,i],this.At=this.re.map(t.L,t),this.ne=this.At[0].Ee(this.At[1])}bt(t){return this.ne.values.reduce((e,i,s)=>e+i*t.values[s],0)}Te(t){return B(this.bt(t),this.bt(this.start))}},Y=class{constructor(...t){if(t.length<3)throw new Error("Not enough vertices");this.Tt=t.map((e,i,s)=>new I(e,s[(i+1)%s.length])),this.Dt=new A(t[1],t[0],t[2]),this.h=t.reduce((e,i)=>e.add(i),t[0].l(0)).l(1/t.length)}Ae(t){let e=new I(t,this.h);return e.range=[0,1/0],this.Dt.Te(t)&&(this.Tt.some(i=>i.ie(t))||!!this.Tt.reduce((i,s)=>s.ke(e)?i^1:i,0))}};var z=class{constructor(t){this.It=0;this.St=0;this.he=!1;this.Ie=0;this.v=0;this.F={It:{name:"Sensitivity",dt:"Mouse sensitivity when looking around",type:"number",min:.1,max:10,round:!1,default:1},St:{name:"Render Distance",dt:"Distance in which objects are visible (in worlds with more than 512 cubes)",type:"number",min:10,max:30,round:!0,default:18,ft:()=>this.model.views.forEach(t=>t.oe())},he:{name:"Dark Mode",dt:"The all present question",type:"boolean",default:!1,ft:t=>this.model.views.forEach(e=>e.ae(t))},Ie:{name:"FOV",dt:"Field of view of character",type:"number",min:30,max:60,round:!0,default:45,ft:t=>{this.v=(1-t/100)*g.t,this.model.views.forEach(e=>e.Se())}}};this.Ce=Object.fromEntries(Object.entries(this.F).map(([t,e])=>[e.name,t]));this.set=(t,e=!0)=>{if(!t)return;let i=!1;for(let[s,r]of Object.entries(t)){let n=this.F[s];if(n&&typeof r===n.type){if(this[s]===r)continue;if(n.type==="number")if((!n.min||r>=n.min)&&(!n.max||r<=n.max))this[s]=n.round?Math.ceil(r):r;else continue;else this[s]=r;i=!0,n.ft&&n.ft(r)}}e&&i&&this.model.db.Re(Object.fromEntries(Object.entries(this.get()).map(([s,r])=>[this.F[s].name,r])))};this.model=t,this.reset(!1)}reset(t=!0){this.set(Object.fromEntries(Object.entries(this.F).map(([e,i])=>[e,i.default])),t)}get(){return Object.fromEntries(Object.keys(this.F).map(t=>[t,this[t]]))}};var u=class{constructor(t){this.Ct=3*u.t/1e3;this.I=1.75;this.tt=.125;this.j=1/8;this.H=-10*u.t;this.qe=5*u.t;this.coords=new c(0,this.I*u.t,0);this.m=new w(0);this.pitch=new w(0);this.g=0;this.Rt=[S,C,R,q];this.gt=0;this.M={};this.status="menu";this.views=[];this.N=[];this.B=-1;this.o=new z(this);this.yt=()=>{var t;(t=this.qt)==null||t.wt.yt(this.o.get(),this.o.set)};this.ce=t=>{let e=t.x%u.t/u.t-Math.sign(t.x)*.5,i=t.z%u.t/u.t-Math.sign(t.z)*.5,s=[this.et(t)];return Math.abs(e)>.5-this.j&&s.push(s[0].S().Z(Math.sign(e))),Math.abs(i)>.5-this.j&&s.push(s[0].S().G(Math.sign(i))),Math.abs(e)>.5-this.j&&Math.abs(i)>.5-this.j&&s.push(s[0].S().Z(Math.sign(e)).G(Math.sign(i))),s};this.db=t,this.db.getSettings().then(e=>this.o.set(Object.fromEntries(Object.entries(e).map(([i,s])=>[this.o.Ce[i],s])),!1))}get qt(){if(this.views.length)return this.views[0]}async Lt(){return await this.db.Lt()}async Le(t){this.B=t;let[e,i,s,r,n]=await this.db.He(t);this.coords=c.parse(e),this.g=i,this.m=new w(s),this.pitch=new w(r);for(let[h,o]of n)this.M[h]=new o(c.parse(h));this.pause()}Be(){this.B=-1,this.M={}}async Ht(){await this.db.Ht(new c(0,this.I*u.t,0)),this.views.forEach(t=>t.P())}async Bt(t){var i;let e=async s=>{s&&(await this.db.Bt(t),this.views.forEach(r=>r.P()))};(i=this.qt)==null||i.wt.Fe("Delete World","Are you sure you want to delete this world?",e)}async Ft(t){var i;let e=async s=>{s&&(await this.db.Ft(t,s.toString()),this.views.forEach(r=>r.P()))};(i=this.qt)==null||i.wt.Ne("Rename World","New name:",e)}Nt(t){return this.db.Nt(t)}async Wt(t){try{if(!ht(Object.keys(t),["name","lastPlayed","pos","yVelocity","yaw","pitch","objects"]))throw new Error("Corrupt File");if(!(typeof t.name=="string"&&t.name.length>0&&t.name.length<=69))throw new Error("Invalid name");if(!(typeof t.lastPlayed=="string"&&t.lastPlayed.length===24&&(e=>!isNaN(e)&&e.toISOString()===t.lastPlayed)(new Date(t.lastPlayed))))throw new Error("Invalid lastPlayed");if(!(c.ee(t.pos)&&parseInt(t.pos.split("_")[1])>=this.I*u.t))throw new Error("Invalid pos");if(typeof t.yVelocity!="number")throw new Error("Invalid yVelocity");if(!(typeof t.yaw=="number"&&t.yaw<=2*Math.PI&&t.yaw>=-2*Math.PI))throw new Error("Invalid yaw");if(!(typeof t.pitch=="number"&&t.pitch<=Math.PI/2&&t.pitch>=-Math.PI/2))throw new Error("Invalid pitch");if(!(typeof t.objects=="object"&&Object.keys(t.objects).every(e=>c.ee(e))&&Object.values(t.objects).every(e=>typeof e=="number"&&e===Math.floor(e)&&e>=0&&e<N.length)))throw new Error("Invalid objects");await this.db.Wt(t),this.views.forEach(e=>e.P())}catch(e){console.error(`Import Error: ${e}`)}}We(t){this.views.push(t)}$e(t){this.N.push(t)}Ye(t){this.move(t)}start(){this.status!=="running"&&(this.status="running",this.N.forEach(t=>t.start()),this.views.forEach(t=>t.start()))}pause(){this.status!=="paused"&&(this.db.$t(this.B,this.coords,this.g,this.m,this.pitch),this.status="paused",this.N.forEach(t=>t.pause()),this.views.forEach(t=>t.pause()))}P(){this.status==="paused"&&(this.Be(),this.status="menu",this.N.forEach(t=>t.P()),this.views.forEach(t=>t.P()))}le(t){return t.map(e=>e*u.t)}et(t){return t.map(e=>Math.floor(e/u.t))}W(t){let e=t.y-this.I*u.t;return this.g<=0&&e%u.t===0&&(e===0||this.ce(new c(t.x,e,t.z)).some(i=>this.M[i.ut(-1).toString()]))}ue(t,e,i,s,r){if(this.W(new c(s,this.coords.y,r)))return this.coords.y;let n=(i-t)*e/1e3;return Math.round(this.coords.y+.5*this.H*Math.pow(n,2)+this.g*n)}me(t,e,i,s,r){let n;if(this.W(new c(s,this.coords.y,r)))n=[s,r].map((h,o)=>((1+Math.sign(i.values[2*o])*this.j)%1*u.t-(u.t+h)%u.t)/i.values[2*o]);else{let h=(Math.floor(this.coords.y/u.t+this.tt)+1)*u.t,o=Math.floor((this.coords.y-1)/u.t-this.I)*u.t,a=Math.sqrt(Math.pow(this.g/this.H,2)-2*(this.coords.y+this.tt*u.t-h)/this.H);(isNaN(a)||this.g<0)&&(a=Math.sqrt(Math.pow(this.g/this.H,2)-2*(this.coords.y-this.I*u.t-o)/this.H)),n=[-1,1].map(d=>1e3*(-this.g/this.H+d*a)/e)}return{axis:1,O:Math.min(...n.filter(h=>h>=0))+t}}move(t){let e=this.N.some(l=>l.Yt),[i,s]=this.N.map(l=>l.ze()).flat().reduce(([l,b],[f,p])=>f==="x"?[l+p,b]:[l,b+p],[0,0]);t=u.t*Math.min(1/Math.sqrt(Math.pow(i,2)+Math.pow(s,2)),t*this.Ct/u.t)/this.Ct;let r=t*this.Ct,n=new c(i*this.m.cos-s*this.m.sin,0,i*this.m.sin+s*this.m.cos).map(l=>~~(l*r));e&&this.W(this.coords)&&(this.g=5*u.t);let h=this.coords.x+n.values[0],o=this.coords.z+n.values[2],a=0,d=[0,2].map(l=>({axis:l,O:((Math.sign(this.coords.values[l])-Math.sign(n.values[l])*this.j)%1*u.t-this.coords.values[l]%u.t)/n.values[l]}));for(d.push(this.me(a,t,n,this.coords.x,this.coords.z)),d.sort(({O:l},{O:b})=>l-b);d.length&&d[0].O<=1;){let{axis:l,O:b}=d.shift();if(b<0)continue;let f=h===this.coords.x+n.values[0]?this.coords.x+b*n.values[0]:h,p=o===this.coords.z+n.values[2]?this.coords.z+b*n.values[2]:o,M=this.ue(a,t,b,f,p);if(l!=1){let x=l===0?p:f,P=x%u.t/u.t-Math.sign(x)*.5,O=Math.floor(M/u.t+this.tt)-Math.floor(M/u.t-this.I)+1,v=this.et(new c(x,M-this.I*u.t,this.coords.values[l])).ut(-1).G(Math.sign(n.values[l])),V=v.S().Z(Math.sign(P)),D=[v];Math.abs(P)>.5-this.j&&D.push(V),[...Array(O)].some((k,H)=>D.some(L=>this.M[l==0?`${L.z}_${L.y+H+1}_${L.x}`:L.ut(1).toString()]))?l==0?h=f:o=p:Math.abs(P)===.5-this.j&&Math.sign(P)*n.values[2-l]>0&&[...Array(O)].some((k,H)=>this.M[l==0?`${V.z}_${V.y+H+1}_${V.x}`:V.ut(1).toString()])&&(l==2?h=f:o=p)}else{let x=this.g<0&&this.W(new c(f,M,p)),P=this.g>0&&this.ce(new c(f,M+this.tt*u.t,p)).some(v=>this.M[v.toString()]),O=this.g===0&&!this.W(new c(f,M,p));(x||P||O)&&(a=b,this.g=0,this.coords.y=M,d.push(this.me(a,t,n,f,p)),d.sort(({O:v},{O:V})=>v-V))}}this.coords.x=h,this.coords.z=o,this.coords.y=this.ue(a,t,1,this.coords.x,this.coords.z),this.W(this.coords)||(this.g+=this.H*(1-a)*t/1e3)}turn(t,e){this.m.set((this.m.angle-t)%(2*Math.PI)),this.pitch.set(Math.max(Math.min(this.pitch.angle+e,1/2*Math.PI),-1/2*Math.PI))}zt(){let t=c.angle(this.m,this.pitch).l(this.qe);return[0,1,2].map(e=>{let i=(u.t-Math.sign(t.values[e])*(this.coords.values[e]%u.t))%u.t/Math.abs(t.values[e]),s=Math.floor((1-i)*Math.abs(t.values[e])/u.t);return i<=1?[...Array(s+1)].map((r,n)=>({axis:e,O:i+n*u.t/Math.abs(t.values[e])})):[]}).flat().sort(({O:e},{O:i})=>e-i).map(({axis:e,O:i})=>({u:this.et(this.coords.add(t.l(i)).map(Math.round)).map((s,r)=>r==e&&t.values[r]<0?s-1:s),axis:e,dir:-Math.sign(t.values[e])})).find(({u:e})=>e.y<0||this.M[e.toString()])}Ke(t){t>=0&&t<this.Rt.length&&(this.gt=Math.floor(t))}Ue(t,e){this.M[t.toString()]||(this.M[t.toString()]=new e(t),this.db.Je(this.B,t,e),this.db.$t(this.B,this.coords,this.g,this.m,this.pitch))}Xe(){let t=this.zt();t&&this.M[t.u.toString()]&&(delete this.M[t.u.toString()],this.db._e(this.B,t.u),this.db.$t(this.B,this.coords,this.g,this.m,this.pitch))}Qe(){let t=this.zt();t&&(t.u.values[t.axis]+=t.dir,(this.coords.x<=(t.u.x-this.j)*u.t||this.coords.x>=(t.u.x+1+this.j)*u.t||this.coords.z<=(t.u.z-this.j)*u.t||this.coords.z>=(t.u.z+1+this.j)*u.t||this.coords.y<=(t.u.y-this.tt)*u.t||this.coords.y>=(t.u.y+1+this.I)*u.t)&&this.Ue(t.u,this.Rt[this.gt]))}},g=u;g.t=1024;var j=class{constructor(t,e=g.t){this.it=[];this.position=t}get st(){return this.constructor.st}get rt(){return this.constructor.rt}get be(){return this.constructor.$}get k(){return this.constructor.k}};j.C=[[0,0,0],[1,0,0],[0,0,1],[1,0,1],[0,1,0],[1,1,0],[0,1,1],[1,1,1]],j.st=[],j.rt=[],j.$=[],j.k=!0;var E=class extends j{constructor(t,e=g.t){super(t);let i=t.x*e,s=t.y*e,r=t.z*e;this.it=[new c(i,s,r+e),new c(i,s,r),new c(i+e,s,r),new c(i+e,s,r+e),new c(i+e,s+e,r+e),new c(i+e,s+e,r),new c(i,s+e,r),new c(i,s+e,r+e)]}};E.st=[[0,1,2,3],[3,2,5,4],[4,5,6,7],[7,6,1,0],[7,0,3,4],[1,6,5,2]],E.rt=[[-1,"y"],[1,"x"],[1,"y"],[-1,"x"],[1,"z"],[-1,"z"]],E.$=["rgba(0, 150, 255, 0.3)","rgba(0, 150, 255, 0.3)","rgba(0, 150, 255, 0.3)","rgba(0, 150, 255, 0.3)","rgba(0, 150, 255, 0.3)","rgba(0, 150, 255, 0.3)"],E.k=!0;var S=class extends E{};S.$=["rgb(107, 84, 40)","rgb(107, 84, 40)","#408000","rgb(107, 84, 40)","rgb(107, 84, 40)","rgb(107, 84, 40)"],S.k=!0;var C=class extends E{};C.$=["rgb(140, 140, 140)","rgb(140, 140, 140)","rgb(140, 140, 140)","rgb(140, 140, 140)","rgb(140, 140, 140)","rgb(140, 140, 140)"],C.k=!0;var R=class extends E{};R.$=["rgba(0, 0, 0, 0.15)","rgba(0, 0, 0, 0.15)","rgba(0, 0, 0, 0.15)","rgba(0, 0, 0, 0.15)","rgba(0, 0, 0, 0.15)","rgba(0, 0, 0, 0.15)"],R.k=!1;var q=class extends E{};q.$=["#c4ac5c","#c4ac5c","#c4ac5c","#c4ac5c","#c4ac5c","#c4ac5c"],q.k=!0;var N=[S,C,R,q];var K=class extends ${constructor(){super();this.ready=new Promise((e,i)=>{let s=indexedDB.open("WorldsDB");s.onerror=r=>{console.error(`IndexedDB error: ${s.error}`,r),i(s.error)},s.onsuccess=r=>{this.db=r.target.result,e()},s.onupgradeneeded=r=>{this.db=r.target.result,this.db.onerror=o=>{console.error(`Database error: ${o.target.errorCode}`)};let n=this.db.createObjectStore("worlds",{keyPath:"id",autoIncrement:!0}),h=this.db.createObjectStore("settings",{autoIncrement:!1});h.transaction.oncomplete=()=>{let o=this.db.transaction("settings","readwrite").objectStore("settings").add({},1);o.onerror=()=>i(o.error),o.onsuccess=()=>e()}}})}async Lt(){return new Promise((e,i)=>{let s=this.db.transaction("worlds").objectStore("worlds").getAll();s.onerror=()=>i(s.error),s.onsuccess=()=>e(s.result.map(r=>[r.id,r.name,r.lastPlayed]))})}async He(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds").objectStore("worlds").get(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i([r.result.pos,r.result.yVelocity,r.result.yaw,r.result.pitch,Object.entries(r.result.objects).map(([n,h])=>[n,N[h]])])})}async $t(e,i,s,r,n){let h=this.db.transaction("worlds","readwrite").objectStore("worlds");h.get(e).onsuccess=o=>{let a=o.target.result;a.lastPlayed=new Date().toISOString(),a.pos=i.toString(),a.yVelocity=s,a.yaw=r.angle,a.pitch=n.angle,h.put(a)}}async Je(e,i,s){let r=this.db.transaction("worlds","readwrite").objectStore("worlds");r.get(e).onsuccess=n=>{let h=n.target.result;h.objects[i.toString()]=N.indexOf(s),r.put(h)}}async _e(e,i){let s=this.db.transaction("worlds","readwrite").objectStore("worlds");s.get(e).onsuccess=r=>{let n=r.target.result;delete n.objects[i.toString()],s.put(n)}}async Ht(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").add({name:"New World",lastPlayed:new Date().toISOString(),pos:e.toString(),yVelocity:0,yaw:0,pitch:0,objects:{}});r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async Bt(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").delete(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async Ft(e,i){return new Promise((s,r)=>{let n=this.db.transaction("worlds","readwrite").objectStore("worlds"),h=n.get(e);h.onerror=()=>r(h.error),h.onsuccess=o=>{let a=o.target.result;a.name=i.slice(0,69);let d=n.put(a);d.onerror=()=>r(d.error),d.onsuccess=()=>s()}})}async Nt(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds").objectStore("worlds").get(e);r.onerror=()=>s(r.error),r.onsuccess=()=>{delete r.result.id,i(r.result)}})}async Wt(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").add(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async Re(e){let i=this.db.transaction("settings","readwrite").objectStore("settings");i.get(1).onsuccess=s=>{let r=s.target.result;for(let[n,h]of Object.entries(e))r[n]=h;i.put(r,1)}}async getSettings(){return new Promise((e,i)=>{let s=this.db.transaction("settings").objectStore("settings").get(1);s.onerror=()=>i(s.error),s.onsuccess=()=>e(s.result)})}};var U=class{constructor(t){this.Yt=!1;this.model=t,this.model.$e(this)}init(){this.model.status==="running"&&this.start(),this.model.status==="paused"&&this.pause(),this.model.status==="menu"&&this.P()}};var J=class{constructor(t){this.model=t}};var X=class extends J{constructor(e){super(e);this.Y=document.getElementById("info-modal");this.Ze=this.Y.querySelector(".close");this.Ge=document.getElementById("modal-cancel");this.K=document.getElementById("modal-confirm");this.Kt=document.getElementById("modal-reset");this.Ut=document.getElementById("modal-text");this.nt=document.getElementById("modal-input");this.Mt=document.getElementById("modal-settings");this.ti={number:this.Y.querySelector(".template.input"),boolean:this.Y.querySelector(".template.check")};this.mode="confirm";this.Jt=e=>{};this.de=()=>{this.K.classList.contains("disabled")||(this.mode==="confirm"?this.U(!0):this.mode==="input"?this.U(this.nt.value):this.mode==="settings"&&(this.Jt(Object.fromEntries(this.Xt().map(([e,i])=>[e,i.type==="range"?parseFloat(i.value):i.checked]))),this.K.classList.add("disabled")))};this.fe=e=>{e.key==="Escape"?this.U(!1):e.key==="Enter"&&this.de()};for(let[i,s]of Object.entries(this.model.o.F)){let r=this.ti[s.type].cloneNode(!0);if(r.childNodes[0].childNodes[0].textContent=s.name,r.childNodes[0].childNodes[1].textContent=s.dt,s.type==="number"){let n=r.childNodes[1].childNodes[0];n.min=s.min.toString(),n.max=s.max.toString(),n.step=(s.round?1:.05).toString()}r.dataset.id=i,r.classList.remove("template"),this.Mt.appendChild(r)}this.Ze.addEventListener("click",()=>this.U(!1)),this.Ge.addEventListener("click",()=>this.U(!1)),this.Kt.addEventListener("click",()=>{this.model.o.reset(),this.model.yt()}),window.addEventListener("click",i=>{i.target==this.Y&&this.U(!1)}),[this.nt,...this.Xt().map(i=>i[1])].forEach(i=>{i.addEventListener("input",()=>this.K.classList.remove("disabled"))}),this.K.addEventListener("click",this.de)}Xt(){return[...this.Mt.querySelectorAll("div.setting[data-id]")].map(e=>[e.dataset.id,e.querySelector("input")])}U(e){this.Jt(e),this.Vt()}_t(e,i,s,r){this.mode=e,this.Jt=r,document.getElementById("modal-title").textContent=i,this.Ut.textContent=s,this.mode!="confirm"&&this.K.classList.add("disabled"),this.Y.style.display="flex",document.addEventListener("keydown",this.fe)}Fe(e,i,s){this.Vt(),this._t("confirm",e,i,s)}Ne(e,i,s){this.Vt(),this.nt.style.display="block",this._t("input",e,i,s)}yt(e,i){this.Vt(),this.Ut.style.display="none";for(let[s,r]of this.Xt())r.type==="checkbox"?r.checked=e[s]:r.value=e[s],r.type==="range"&&(r.nextElementSibling.textContent=e[s]);this.Kt.style.display="block",this.Mt.style.display="block",this._t("settings","Settings","",i)}Vt(){this.Y.style.display="none",this.Ut.style.display="block",this.nt.style.display="none",this.nt.value="",this.Mt.style.display="none",this.Kt.style.display="none",this.K.classList.remove("disabled"),document.removeEventListener("keydown",this.fe)}};var _=class{constructor(t,e){this.width=16;this.height=9;this.D=this.width/2;this.A=this.height/2;this.h=new y(0,0);this.ht=60;this.ot=3;this.ge=10;this.T=0;this.pe=[];this.C=[];this.model=t,this.wt=e,this.model.We(this),this.ae(this.model.o.he),this.resize(16,9)}ei(){this.model.status==="running"&&this.start(),this.model.status==="paused"&&this.pause(),this.model.status==="menu"&&this.P()}ye(){let t=new c(-this.D,this.A,this.model.o.v),e=new c(this.D,this.A,this.model.o.v),i=new c(this.D,-this.A,this.model.o.v),s=new c(-this.D,-this.A,this.model.o.v);this.pe=[new A(c._(),t,e),new A(c._(),e,i),new A(c._(),i,s),new A(c._(),s,t)];let r=[[-1,1],[1,1],[1,-1],[-1,-1]].map(n=>new y(n[0]*this.D,n[1]*this.A));this.C=r.map((n,h)=>({R:n,e:new I(c._(),new c(n.x,n.y,this.model.o.v)).Oe(0,1/0),V:h}))}resize(t,e){this.width=t,this.height=e,this.D=t/2-this.T,this.A=e/2-this.T,this.ye()}Se(){this.ye(),this.oe()}xt(t,e=this.model.coords,i=this.model.m,s=this.model.pitch){let r=new c(t.x-e.x,t.y-e.y,t.z-e.z);return new c(r.x*i.cos+r.z*i.sin,r.x*i.sin*s.sin+r.y*s.cos-r.z*i.cos*s.sin,-r.x*i.sin*s.cos+r.y*s.sin+r.z*i.cos*s.cos)}ii(t){return t.x>-this.D&&t.x<this.D&&t.y>-this.A&&t.y<this.A}Qt(t,e=!1,i=!0){let s=e?t:this.xt(t),r=this.model.o.v/s.z,n=new y(s.x*r,s.y*r);return i&&(r<0||!this.ii(n))?s:n}si(t,e){return this.pe.reduce((i,s,r)=>{let n=t.se(s);if(n&&n.z>=0){let h=n.z/this.model.o.v;G(Math.abs(n.x),h*this.D)&&G(Math.abs(n.y),h*this.A)&&i.push({R:n,V:r,ri:e})}return i},[]).sort(({R:i},{R:s})=>i.L(t.start).length-s.L(t.start).length).map(({R:i,V:s,ri:r},n,h)=>({R:this.Qt(i,!0,!1),V:s,ni:r||h.length%2===0&&n%2===1}))}hi(t,e){let i=t.map((r,n)=>({vt:r,V:n})).filter(({vt:r})=>!(r instanceof y));i.length&&!i[0].vt.ni&&i.unshift(i.pop());let s=[];return i.forEach(({vt:r,V:n},h,o)=>{if(h%2)return;let a=o[h+1].vt;if(r.V==a.V)return;let d=rt(this.C,(r.V+1)%this.C.length),l=[...Array(2)].map(()=>(d.reverse(),d.slice(0,[...Array(d.length).keys()].find(b=>a.V==d[b].V||(a.V+1)%this.C.length==d[b].V)+1))).find(b=>b.every(f=>e[f.V]));l&&s.push(...l.map(b=>({c:b.R,V:n+1})))}),s.reduce((r,{c:n,V:h},o)=>st(r,h+o,n),t).map(r=>r instanceof y?r:r.R)}we(t,e,i){let s=t.map(a=>i[a]);if(s.every(a=>a instanceof y))return s;let r=s.map((a,d)=>a instanceof c?a:this.xt(e[t[d]])),n=new Y(...r),h=this.C.map(({e:a})=>!!a.De(n)),o=s.map((a,d,l)=>{let b=l[(d+1)%l.length];if(a instanceof y&&b instanceof y)return[a];let f=new I(r[d],r[(d+1)%r.length]),p=a instanceof y?[a]:[];return p.push(...this.si(f,a instanceof y)),p}).flat();return o.length?this.hi(o,h):h.every(Boolean)?this.C.map(({R:a})=>a):[]}oi(t){if(j.C.every(s=>this.xt(this.model.le(t.position.map((r,n)=>r+s[n]))).z<0))return[];let e=t.it.map(s=>this.Qt(s)),i=[];return t.st.filter((s,r)=>{let[n,h]=t.rt[r];if(t.k&&this.model.coords[h]*n<t.it[s[0]][h]*n)return!1;let o=this.model.M[t.position.Pe(h,n).toString()];return o&&t.k===o.k?!1:(i.push(t.be[r]),!0)}).map((s,r)=>[this.we(s,t.it,e),i[r]]).filter(([s])=>s.length)}ai(t){let e=this.model.et(this.model.coords),i=[],s=this.model.zt();if(s&&s.u.y<0){s.u.values[s.axis]+=s.dir;let r=[s.u,s.u.S().Z(1),s.u.S().Z(1).G(1),s.u.S().G(1)].map(this.model.le);t(this.we([0,1,2,3],r,r.map(n=>this.Qt(n))),"transparent")}if(Object.keys(this.model.M).length>512){let r=new w(this.model.m.angle+Math.PI/2),n=new w(this.model.pitch.angle+Math.PI/2),h=c.angle(this.model.m,this.model.pitch),o=c.angle(r,new w(0)),a=c.angle(this.model.m,n),d=new w(this.model.m.angle-Math.floor((2*Math.PI+this.model.m.angle+Math.PI/4)%(2*Math.PI)/(Math.PI/2))*(Math.PI/2)),l=g.t/o.Ot,b,f,p,M;Math.abs(this.model.pitch.angle)<=Math.PI/4?(b=d.cos*g.t*this.model.pitch.cos,f=g.t/a.Ot,p=d.tan/this.model.pitch.cos*b/g.t,M=this.model.pitch.tan*b/g.t):(b=g.t/h.Ot,f=d.cos*g.t*Math.abs(this.model.pitch.sin),p=-Math.sign(this.model.pitch.angle)*d.tan/Math.abs(this.model.pitch.sin)*f/g.t,M=Math.sign(this.model.pitch.angle)*Math.tan(Math.PI/2-Math.abs(this.model.pitch.angle))*f/g.t);let x=Math.ceil(this.model.o.St*g.t/b),P=this.D/this.model.o.v*x*b,O=this.A/this.model.o.v*x*b;for(let[v]of Array(x+2).entries()){let V=(x-v)*b,D=this.D/this.model.o.v*V+3*g.t,k=this.A/this.model.o.v*V+3*g.t;Math.abs(this.model.pitch.angle)<=Math.PI/4&&(D+=(l+(P+v*p*g.t-D)%l)%l,k+=(f+(O+v*M*g.t-k)%f)%f);let H=this.model.coords.add(h.l(V)).add(a.l(k)).add(o.l(D)),L=Math.ceil(2*D/l)+1,at=Math.ceil(2*k/f)+1;for(let[Z]of Array(at).entries()){let W=H.add(a.l(-Z*f));if(Math.abs(this.model.pitch.angle)>Math.PI/4&&(W=W.add(o.l((l+((Math.floor((O-k)/f)+Z)*p*g.t+P-D)%l)%l)).add(h.l((b+(Math.floor((O-k)/f)+Z)*M*g.t%b)%b)).add(a.l((f+(O-k)%f)%f))),W.y<0)break;for(let[lt]of Array(L).entries()){let ct=W.add(o.l(-lt*l)),tt=this.model.et(ct),et=tt.L(e).length;if(et>this.model.o.St)continue;let it=this.model.M[tt.toString()];it&&i.push([et,it])}}}}else i=Object.values(this.model.M).map(r=>[e.L(r.position).length,r]);for(let[r,n]of i.sort((h,o)=>o[0]-h[0]))for(let[h,o]of this.oi(n))t(h,o)}li(){let t=-this.model.pitch.tan*this.model.o.v;return[t,Math.max(Math.min(t,this.height/2),-this.height/2)]}ci(t){let e=new w(-Math.PI/4),i=new w(-Math.PI/6),s=-i.cos,n=(e.sin-e.cos)*i.sin-s,h=n/2-Math.abs(s),o=this.xt(t,new c(0,1,0),e,i);return new y(o.x/n*.8*this.ht,(o.y-h)/n*.8*this.ht)}ui(t){let e=new t(new c(0,0,0),1),i=e.it.map(this.ci,this);return e.st.map((s,r)=>[s.map(n=>i[n]),e.be[r]]).filter((s,r)=>{let[n,h]=e.rt[r];return!e.k||n<0&&["x","z"].includes(h)||n>0&&h==="y"})}};var T=class extends _{constructor(e){super(e,new X(e));this.Zt=document.getElementById("pause_screen");this.lt=document.getElementById("menu_screen");this.J=this.lt.querySelector("#world_list");this.mi=this.lt.querySelector("#world_template");this.bi=document.getElementById("fps");this.jt=1;this.Et=[...Array(this.jt)].map(e=>0);this.q=0;this.fi=(e,i)=>{this.i.fillStyle=i,this.i.beginPath();let s=e[0];this.i.moveTo(Math.round(s.x+this.h.x),Math.round(this.h.y-s.y));for(let r of e.slice(1))this.i.lineTo(Math.round(r.x+this.h.x),Math.round(this.h.y-r.y));this.i.closePath(),this.i.fill(),this.i.stroke()};this.te=e=>{let i=this.di(),s=(e-this.Et[0])/this.jt;s<=0&&(this.jt+=5),this.Et.length>=this.jt&&this.Et.shift(),this.Et.push(e),this.bi.textContent=Math.round(1e3/s).toString(),this.model.status==="running"?(this.model.Ye(s),this.Gt(),this.gi(),this.pi()):i&&this.Ve(),this.q=requestAnimationFrame(this.te)};this.i=T.getContext("canvas"),this.ei()}ae(e){let i=document.body.classList;e?i.add("dark"):i.remove("dark")}oe(){this.model.status==="paused"&&this.Gt()}transform(){this.i.resetTransform(),this.i.translate(0,.5),this.i.lineJoin="bevel"}static Me(e){let i=document.getElementById(e);if(!(i instanceof HTMLCanvasElement))throw new Error(`The element of id "${e}" is not a HTMLCanvasElement.`);return i}static getContext(e){let i=this.Me(e).getContext("2d");if(i===null)throw new Error("This browser does not support 2-dimensional canvas rendering contexts.");return i}di(){let e=this.i.canvas.clientWidth,i=this.i.canvas.clientHeight;return this.i.canvas.width!=e||this.i.canvas.height!=i?(this.i.canvas.width=e,this.i.canvas.height=i,this.h.x=e/2,this.h.y=i/2,this.resize(e,i),this.transform(),!0):!1}Gt(){this.i.clearRect(0,0,this.width,this.height),this.i.lineWidth=.5,this.i.strokeStyle="#444";let[e,i]=this.li(),s=this.i.createLinearGradient(0,this.h.y-e,0,0);s.addColorStop(0,"#b3bdc1"),s.addColorStop(1,"#80b7de"),this.i.fillStyle=s,this.h.y>e&&this.i.fillRect(0,0,this.width,this.h.y-i),s=this.i.createLinearGradient(0,this.h.y-e,0,this.height),s.addColorStop(0,"#578000"),s.addColorStop(Math.pow(.97,this.model.coords.y/g.t*this.model.I),"#408000"),this.i.fillStyle=s,e>-this.h.y&&this.i.fillRect(0,this.h.y-i,this.width,this.h.y+i),this.ai(this.fi),this.T>0&&(this.i.beginPath(),this.i.moveTo(this.T,this.T),this.i.lineTo(this.width-this.T,this.T),this.i.lineTo(this.width-this.T,this.height-this.T),this.i.lineTo(this.T,this.height-this.T),this.i.closePath(),this.i.stroke())}gi(){let e=20,i=2;this.i.fillStyle="black",this.i.fillRect(this.h.x-i/2,this.h.y-e/2,i,e),this.i.fillRect(this.h.x-e/2,this.h.y-i/2,e,i)}pi(){let e=this.height-(this.ht+1.5*this.ot)-this.ge,i=this.ht+this.ot,s=[0,e,0,e+i],r=this.i.createLinearGradient(...s);r.addColorStop(0,"#bbb"),r.addColorStop(1,"#a0a0a0");let n=this.i.createLinearGradient(...s);n.addColorStop(0,"#ccc"),n.addColorStop(1,"#b0b0b0"),this.i.resetTransform();for(let[h]of Array(10).entries()){let o=this.model.Rt[h];if(this.i.fillStyle=this.model.gt===h?n:r,this.i.lineWidth=this.ot,this.i.strokeStyle="#848999",this.i.beginPath(),this.i.rect(this.h.x+(h-5)*i,e,i,i),this.i.fill(),this.i.stroke(),o){this.i.lineWidth=.5,this.i.strokeStyle="#444";for(let[a,d]of this.ui(o)){this.i.fillStyle=d,this.i.beginPath();let l=a[0],b=new y(this.h.x+(h-4.5)*i,this.height-this.ht/2-this.ot-this.ge);this.i.moveTo(l.x+b.x,b.y-l.y);for(let f of a.slice(1))this.i.lineTo(f.x+b.x,b.y-f.y);this.i.closePath(),this.i.fill(),this.i.stroke()}}}this.i.lineWidth=this.ot+2,this.i.strokeStyle="#e0dddd",this.i.strokeRect(this.h.x+(this.model.gt-5)*i,e,i,i),this.transform()}Ve(){this.model.status==="paused"&&(this.Gt(),this.Zt.classList.add("active"),this.lt.classList.remove("active"))}async yi(){if(this.model.status==="menu"){this.J.replaceChildren();for(let[e,i,s]of(await this.model.Lt()).sort((r,n)=>new Date(n[2]).getTime()-new Date(r[2]).getTime())){let r=this.mi.cloneNode(!0);r.childNodes[1].childNodes[0].textContent=i,r.childNodes[1].childNodes[1].textContent=new Date(s).toLocaleString([],{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),r.removeAttribute("id"),r.dataset.id=e.toString(),this.J.appendChild(r)}if(!this.J.childElementCount){let e=document.createElement("div");e.appendChild(document.createTextNode("No worlds yet...")),e.setAttribute("id","worlds_placeholder"),this.J.appendChild(e)}this.Zt.classList.remove("active"),this.lt.classList.add("active")}}start(){this.q||(this.q=requestAnimationFrame(this.te)),this.Zt.classList.remove("active"),this.lt.classList.remove("active")}pause(){this.q||(this.q=requestAnimationFrame(this.te)),this.Ve()}P(){this.q&&cancelAnimationFrame(this.q),this.q=0,this.yi()}};var Q=class extends U{constructor(e){super(e);this.X={};this.xi=0;this.canvas=T.Me("canvas");this.wi=document.getElementById("menu_return");this.J=document.getElementById("world_list");this.Mi=document.getElementById("create_world");this.xe=document.getElementById("world_upload");this.ve=e=>{this.model.turn(e.movementX/100*this.model.o.It,-e.movementY/100*this.model.o.It)};this.je=e=>{e.button===0?this.model.Xe():e.button===2&&this.model.Qe()};this.Pt=e=>{e.type==="keyup"?(this.X[e.code]&&delete this.X[e.code],/^Digit[0-9]$/.test(e.code)&&this.model.Ke((10+parseInt(e.code[5])-1)%10)):(this.X[e.code]||(this.X[e.code]=!0),e.code==="Space"&&(this.Yt=!0))};this.Vi(),this.init()}ze(){this.Yt=!1;let e=["KeyA","KeyD","KeyS","KeyW"];return[["x",-1],["x",1],["z",-1],["z",1]].filter((s,r)=>this.X[e[r]])}Vi(){var e,i,s,r;document.addEventListener("pointerlockchange",n=>{document.pointerLockElement&&this.model.status==="paused"?this.model.start():this.model.pause()},!1),(e=this.wi)==null||e.addEventListener("click",()=>this.model.P()),(i=this.Mi)==null||i.addEventListener("click",()=>this.model.Ht()),(s=this.xe)==null||s.addEventListener("change",async()=>{var h;let n=(h=this.xe)==null?void 0:h.files;if(!(n.length<=0))for(let o of n)o.type==="application/json"&&this.model.Wt(JSON.parse(await o.text()))}),(r=this.J)==null||r.addEventListener("click",async n=>{let h=n.target,o=h.closest(".world");if(h.tagName!=="A"&&o&&(h=o),h.classList.contains("world")&&h.dataset.id)this.model.Le(parseInt(h.dataset.id));else if(h.classList.contains("remove")&&o.dataset.id)this.model.Bt(parseInt(o.dataset.id));else if(h.classList.contains("export")&&o.dataset.id){let a=await this.model.Nt(parseInt(o.dataset.id)),d=new Blob([JSON.stringify(a)],{type:"application/json"}),l=URL.createObjectURL(d),b=document.createElement("a");b.href=l,b.download=`[ProjectCubes] ${a.name.replace(/[\/\\:*?"<>]/g,"")}.json`,b.style.display="none",document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(l)}else h.classList.contains("rename")&&o.dataset.id&&this.model.Ft(parseInt(o.dataset.id))}),document.querySelectorAll(".settings").forEach(n=>n.addEventListener("click",this.model.yt))}start(){document.addEventListener("mousemove",this.ve,!1),document.addEventListener("mousedown",this.je,!1),this.canvas.addEventListener("keyup",this.Pt),this.canvas.addEventListener("keydown",this.Pt),this.canvas.removeEventListener("click",this.canvas.requestPointerLock)}pause(){this.X={},document.removeEventListener("mousemove",this.ve,!1),document.removeEventListener("mousedown",this.je,!1),this.canvas.removeEventListener("keyup",this.Pt),this.canvas.removeEventListener("keydown",this.Pt),this.canvas.addEventListener("click",this.canvas.requestPointerLock)}P(){this.canvas.removeEventListener("click",this.canvas.requestPointerLock)}};var ut=document.getElementById("error_screen"),ot=new K;ot.ready.then(()=>{let m=new g(ot);new Q(m),new T(m)}).catch(m=>(console.error(m),ut.style.display="flex"));})();
