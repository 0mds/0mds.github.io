//! Copyright 2023 0mds
"use strict";(()=>{var x=class{constructor(t){this.angle=0;this.sin=0;this.cos=1;this.tan=0;this.set(t)}set(t){this.angle=t,this.sin=Math.sin(t),this.cos=Math.cos(t),this.tan=Math.tan(t)}};function D(b){return Array(b).fill(void 0)}function C(b){return Array(b).keys()}function ft(b,t,e){return t<b.length?b.reduce((i,s,r)=>(r!=t?i.push(s):i.push(e,s),i),[]):[...b,e]}function dt(b,t){let e=b.slice(t,b.length);return e.push(...b.slice(0,t)),e}function J(b,t,e){return Math.max(Math.min(b,t),e!=null?e:-t)}var pt=1e-5;function yt(b,t){return b===t?!0:b==null||t==null||b.length!==t.length?!1:(b=[...b].sort(),t=[...t].sort(),b.every((e,i)=>e===t[i]))}function W(b,t){return Math.abs(b-t)<pt}function ut(b,t){return b<=t+pt}var $=class{constructor(...t){let e=this.constructor.dimensions;if(e>0&&t.length!=e)throw new Error("Invalid number of dimensions");this.values=t}kt(t){return new this.constructor(...t)}static parse(t){return new this(...t.split("_").map(e=>parseInt(e)))}static it(t=0){return new this(...Array(this.dimensions||t).fill(0))}static je(t){let e=t.split("_").map(i=>parseInt(i));return typeof t=="string"&&(this.dimensions<=0||e.length===this.dimensions)&&e.every(i=>!isNaN(i))}O(){return this.kt(this.values)}map(t){return this.kt(this.values.map(t))}o(t){return this.map(e=>t*e)}add(t){if(this.values.length!=t.values.length)throw new Error("Vectors of differing dimensionality");return this.kt(this.values.map((e,i)=>e+t.values[i]))}st(t){if(this.values.length!=t.values.length)throw new Error("Vectors of differing dimensionality");return t.add(this.o(-1))}isEqual(t){return this.values.length===t.values.length&&this.values.every((e,i)=>W(e,t.values[i]))}It(t){return this.values.reduce((e,i,s)=>e+Math.abs(i-t.values[s]),0)}si(t){return this.st(t).length}get length(){return Math.sqrt(this.values.reduce((t,e)=>t+Math.pow(e,2),0))}get Jt(){return Math.max(...this.values.map(Math.abs))}toString(){return this.values.join("_")}};$.dimensions=0;var g=class extends ${get x(){return this.values[0]}set x(t){this.values[0]=t}get y(){return this.values[1]}set y(t){this.values[1]=t}};g.dimensions=2;var m=class extends ${static angle(t,e){return new this(-t.sin*e.cos,e.sin,t.cos*e.cos)}ri(t){return this.kt([this.values[1]*t.values[2]-this.values[2]*t.values[1],this.values[2]*t.values[0]-this.values[0]*t.values[2],this.values[0]*t.values[1]-this.values[1]*t.values[0]])}ni(t,e){let i=this.O();return i[t]+=e,i}N(t){return this.x+=t,this}q(t){return this.y+=t,this}U(t){return this.z+=t,this}get x(){return this.values[0]}set x(t){this.values[0]=t}get y(){return this.values[1]}set y(t){this.values[1]=t}get z(){return this.values[2]}set z(t){this.values[2]=t}};m.dimensions=3;var S=class{constructor(t,e){this.range=[0,1];this.start=t,this.end=e,this.V=t.st(e)}hi(t,e){return this.range=[t,e],this}Xt(t){return t>=this.range[0]&&t<=this.range[1]}o(t){return this.start.add(this.V.o(t))}Oe(t){let e=[...C(3)].find((s,r)=>!W(this.V.values[r],0));if(typeof e!="number")return!1;let i=(t.values[e]-this.start.values[e])/this.V.values[e];return this.Xt(i)&&this.o(i).isEqual(t)}oi(t){let e=[...C(3)].find((r,n,h)=>n<h.length-1&&!W(this.V.values[n+1]*t.V.values[n],this.V.values[n]*t.V.values[n+1]));if(typeof e!="number")return!1;let i=(this.V.values[e]*(t.start.values[e+1]-this.start.values[e+1])-this.V.values[e+1]*(t.start.values[e]-this.start.values[e]))/(this.V.values[e+1]*t.V.values[e]-this.V.values[e]*t.V.values[e+1]),s=t.o(i);return t.Xt(i)&&this.Oe(s)?s:!1}Pe(t){let e=t.Dt(this.start.st(t.start))/t.Dt(this.V);return this.Xt(e)?this.o(e):!1}ai(t){let e=this.Pe(t.Qt);return e&&t.li(e)?e:!1}},R=class{constructor(t,e,i){this.start=t,this.ve=[e,i],this.Zt=this.ve.map(t.st,t),this._e=this.Zt[0].ri(this.Zt[1])}Dt(t){return this._e.values.reduce((e,i,s)=>e+i*t.values[s],0)}ci(t){return W(this.Dt(t),this.Dt(this.start))}},X=class{constructor(...t){if(t.length<3)throw new Error("Not enough vertices");this.Gt=t.map((e,i,s)=>new S(e,s[(i+1)%s.length])),this.Qt=new R(t[1],t[0],t[2]),this.h=t.reduce((e,i)=>e.add(i),t[0].o(0)).o(1/t.length)}li(t){let e=new S(t,this.h);return e.range=[0,1/0],this.Qt.ci(t)&&(this.Gt.some(i=>i.Oe(t))||!!this.Gt.reduce((i,s)=>s.oi(e)?i^1:i,0))}};var o=1024,P=class{constructor(t,e=o){this.rt=[];this.position=t}get nt(){return this.constructor.nt}get ht(){return this.constructor.ht}get Ce(){return this.constructor.H}get F(){return this.constructor.F}};P.Y=[[0,0,0],[1,0,0],[0,0,1],[1,0,1],[0,1,0],[1,1,0],[0,1,1],[1,1,1]],P.nt=[],P.ht=[],P.H=[],P.F=!0;var E=class extends P{};E.nt=[[0,1,2,3],[3,2,5,4],[4,5,6,7],[7,6,1,0],[7,0,3,4],[1,6,5,2]],E.ht=[[-1,"y"],[1,"x"],[1,"y"],[-1,"x"],[1,"z"],[-1,"z"]],E.H=Array(6).fill("rgb(0, 150, 255)"),E.F=!0;var M=class extends P{constructor(t,e=o){super(t);let i=t.x*e,s=t.y*e,r=t.z*e;this.rt=[new m(i,s,r+e),new m(i,s,r),new m(i+e,s,r),new m(i+e,s,r+e),new m(i+e,s+e,r+e),new m(i+e,s+e,r),new m(i,s+e,r),new m(i,s+e,r+e)]}};M.nt=[[0,1,2,3],[3,2,5,4],[4,5,6,7],[7,6,1,0],[7,0,3,4],[1,6,5,2]],M.ht=[[-1,"y"],[1,"x"],[1,"y"],[-1,"x"],[1,"z"],[-1,"z"]],M.H=Array(6).fill("#cc0066"),M.F=!0;var N=class extends M{};N.H=["rgb(107, 84, 40)","rgb(107, 84, 40)","#408000","rgb(107, 84, 40)","rgb(107, 84, 40)","rgb(107, 84, 40)"];var q=class extends M{};q.H=Array(6).fill("rgb(140, 140, 140)");var L=class extends M{};L.H=Array(6).fill("rgba(0, 0, 0, 0.15)"),L.F=!1;var H=class extends M{};H.H=Array(6).fill("#c4ac5c");var F=class extends M{};F.H=Array(6).fill("#a32929");var z=class extends M{};z.H=Array(6).fill("#1d161d");var T=[N,q,L,H,F,z];var mt=class{constructor(t={yaw:0,pitch:0,x:0,y:mt.g*o,z:0,yVelocity:0}){this.m=new x(t.yaw),this.pitch=new x(t.pitch),this.coords=new m(t.x,t.y,t.z),this.p=t.yVelocity}get G(){return{yaw:this.m.angle,pitch:this.pitch.angle,x:this.coords.x,y:this.coords.y,z:this.coords.z,yVelocity:this.p}}set t(t){this.m=t.m,this.pitch=t.pitch,this.coords=t.coords,this.p=t.p}},l=mt;l.g=1.75,l.C=.125,l.P=1/8,l.te=3*o/1e3,l.Z=-12*o,l.ui=5*o,l.mi=5.25*o;var U=class extends l{constructor(e){var i;super(e);this.ot=new E(this.coords.o(1/o)),this.name=(i=e.name)!=null?i:"Peer",this.Ee()}Ee(){let e=l.P*o;this.ot.rt=[new m(this.coords.x-e,this.coords.y-l.g*o,this.coords.z+e),new m(this.coords.x-e,this.coords.y-l.g*o,this.coords.z-e),new m(this.coords.x+e,this.coords.y-l.g*o,this.coords.z-e),new m(this.coords.x+e,this.coords.y-l.g*o,this.coords.z+e),new m(this.coords.x+e,this.coords.y+l.C*o,this.coords.z+e),new m(this.coords.x+e,this.coords.y+l.C*o,this.coords.z-e),new m(this.coords.x-e,this.coords.y+l.C*o,this.coords.z-e),new m(this.coords.x-e,this.coords.y+l.C*o,this.coords.z+e)],this.ot.position=this.coords.o(1/o)}get G(){return{...super.G,name:this.name}}set t(e){super.t=e,this.Ee()}};var Q=class{constructor(t){this.model=t}};var Z=class extends Q{constructor(e){super(e);this.lt=document.getElementById("info-modal");this.bi=this.lt.querySelector(".close");this.fi=document.getElementById("modal-cancel");this.ct=document.getElementById("modal-confirm");this.ee=document.getElementById("modal-reset");this.Rt=document.getElementById("modal-text");this.ut=document.getElementById("modal-input");this.xt=document.getElementById("modal-copy");this.Tt=document.getElementById("modal-settings");this.di={number:this.lt.querySelector(".template.input"),boolean:this.lt.querySelector(".template.check")};this.ie=document.querySelector("#modal-warning > span");this.mode="confirm";this.tt=()=>{};this.ke=()=>{this.ct.classList.contains("disabled")||(this.mode==="confirm"?this.ft(!0):this.mode==="input"?this.ft(this.ut.value):this.mode==="settings"&&(this.tt(Object.fromEntries(this.se().map(([e,i])=>[e,i.type==="range"?parseFloat(i.value):i.checked]))),this.ct.classList.add("disabled")))};this.Ie=e=>{e.key==="Escape"?this.ft(!1):e.key==="Enter"&&this.ke()};for(let[i,s]of Object.entries(this.model.l.bt)){let r=this.di[s.type].cloneNode(!0);if(r.childNodes[0].childNodes[0].textContent=s.name,r.childNodes[0].childNodes[1].textContent=s.At,s.type==="number"){let n=r.childNodes[1].childNodes[0];n.min=s.min.toString(),n.max=s.max.toString(),n.step=(s.round?1:.05).toString()}r.dataset.id=i,r.classList.remove("template"),this.Tt.appendChild(r)}this.bi.addEventListener("click",()=>this.ft(!1)),this.fi.addEventListener("click",()=>this.ft(!1)),this.ee.addEventListener("click",()=>{this.model.l.reset(),this.model.St()}),window.addEventListener("click",i=>{i.target==this.lt&&this.ft(!1)});for(let i of[this.ut,...this.se().map(s=>s[1])])i.addEventListener("input",()=>this.ct.classList.remove("disabled"));this.ct.addEventListener("click",this.ke),this.xt.addEventListener("click",()=>{let i=this.Rt.textContent;i&&navigator.clipboard.writeText(i).then(()=>this.jt()).catch(()=>{this.xt.style.setProperty("background-image","linear-gradient(to right, red, red)","important"),setTimeout(()=>{this.xt.style.backgroundImage=""},250)})})}se(){return[...this.Tt.querySelectorAll("div.setting[data-id]")].map(e=>[e.dataset.id,e.querySelector("input")])}ft(e){this.tt(e),this.jt()}re(e,i,s,r,n){this.mode=e,this.tt=r,document.getElementById("modal-title").textContent=i,this.Rt.textContent=s,this.mode!="confirm"&&this.ct.classList.add("disabled"),n&&(this.ie.textContent=n,this.ie.parentElement.style.display="flex"),this.lt.style.display="flex",document.addEventListener("keydown",this.Ie)}Ot(e,i,s,r=!1,n){this.jt(),r&&(this.xt.style.display="block"),this.re("confirm",e,i,s,n)}ne(e,i,s,r){this.jt(),this.ut.style.display="block",this.re("input",e,i,s,r),this.ut.focus()}St(e,i,s){this.jt(),this.Rt.style.display="none";for(let[r,n]of this.se())n.type==="checkbox"?n.checked=e[r]:n.value=e[r],n.type==="range"&&(n.nextElementSibling.textContent=e[r]);this.ee.style.display="block",this.Tt.style.display="block",this.re("settings","Settings","",i,s)}jt(){this.lt.style.display="none",this.Rt.style.display="block",this.ut.style.display="none",this.ut.value="",this.xt.style.display="none",this.Tt.style.display="none",this.ee.style.display="none",this.ct.classList.remove("disabled"),this.ie.parentElement.style.display="none",document.removeEventListener("keydown",this.Ie)}};var G=class{constructor(t,e){this.width=16;this.height=9;this.R=this.width/2;this.T=this.height/2;this.h=new g(0,0);this.Pt=60;this.vt=3;this.De=10;this.A=0;this.Re=[];this.Y=[];this.model=t,this.B=e,this.model.pi(this),this.Te(this.model.l.Ae),this.resize(16,9)}yi(){this.model.status==="running"&&this.start(),this.model.status==="paused"&&this.pause(),this.model.status==="menu"&&this.k()}Se(){let t=new m(-this.R,this.T,this.model.l.v),e=new m(this.R,this.T,this.model.l.v),i=new m(this.R,-this.T,this.model.l.v),s=new m(-this.R,-this.T,this.model.l.v);this.Re=[new R(m.it(),t,e),new R(m.it(),e,i),new R(m.it(),i,s),new R(m.it(),s,t)];let r=[[-1,1],[1,1],[1,-1],[-1,-1]].map(n=>new g(n[0]*this.R,n[1]*this.T));this.Y=r.map((n,h)=>({J:n,e:new S(m.it(),new m(n.x,n.y,this.model.l.v)).hi(0,1/0),j:h}))}resize(t,e){this.width=t,this.height=e,this.R=t/2-this.A,this.T=e/2-this.A,this.Se()}gi(){this.Se(),this.Le()}Lt(t,e=this.model.t.coords,i=this.model.t.m,s=this.model.t.pitch){let r=new m(t.x-e.x,t.y-e.y,t.z-e.z);return new m(r.x*i.cos+r.z*i.sin,r.x*i.sin*s.sin+r.y*s.cos-r.z*i.cos*s.sin,-r.x*i.sin*s.cos+r.y*s.sin+r.z*i.cos*s.cos)}wi(t){return t.x>-this.R&&t.x<this.R&&t.y>-this.T&&t.y<this.T}Bt(t,e=!1,i=!0){let s=e?t:this.Lt(t),r=this.model.l.v/s.z,n=new g(s.x*r,s.y*r);return i&&(r<0||!this.wi(n))?s:n}Mi(t,e){return this.Re.reduce((i,s,r)=>{let n=t.Pe(s);if(n&&n.z>=0){let h=n.z/this.model.l.v;ut(Math.abs(n.x),h*this.R)&&ut(Math.abs(n.y),h*this.T)&&i.push({J:n,j:r,Vi:e})}return i},[]).sort(({J:i},{J:s})=>i.st(t.start).length-s.st(t.start).length).map(({J:i,j:s,Vi:r},n,h)=>({J:this.Bt(i,!0,!1),j:s,xi:r||h.length%2===0&&n%2===1}))}ji(t,e){let i=t.map((r,n)=>({Nt:r,j:n})).filter(({Nt:r})=>!(r instanceof g));i.length&&!i[0].Nt.xi&&i.unshift(i.pop());let s=[];return i.forEach(({Nt:r,j:n},h,u)=>{if(h%2)return;let a=u[h+1].Nt;if(r.j==a.j)return;let f=dt(this.Y,(r.j+1)%this.Y.length),p=D(2).map(()=>(f.reverse(),f.slice(0,[...C(f.length)].find(c=>a.j==f[c].j||(a.j+1)%this.Y.length==f[c].j)+1))).find(c=>c.every(d=>e[d.j]));p&&s.push(...p.map(c=>({c:c.J,j:n+1})))}),s.reduce((r,{c:n,j:h},u)=>ft(r,h+u,n),t).map(r=>r instanceof g?r:r.J)}Be(t,e,i){let s=t.map(a=>i[a]);if(s.every(a=>a instanceof g))return s;let r=s.map((a,f)=>a instanceof m?a:this.Lt(e[t[f]])),n=new X(...r),h=this.Y.map(({e:a})=>!!a.ai(n)),u=s.map((a,f,p)=>{let c=p[(f+1)%p.length];if(a instanceof g&&c instanceof g)return[a];let d=new S(r[f],r[(f+1)%r.length]),y=a instanceof g?[a]:[];return y.push(...this.Mi(d,a instanceof g)),y}).flat();return u.length?this.ji(u,h):h.every(Boolean)?this.Y.map(({J:a})=>a):[]}Oi(t){if(P.Y.every(s=>this.Lt(this.model.Ne(t.position.map((r,n)=>r+s[n]))).z<0))return[];let e=t.rt.map(s=>this.Bt(s)),i=[];return t.nt.filter((s,r)=>{let[n,h]=t.ht[r];if(t.F&&this.model.t.coords[h]*n<t.rt[s[0]][h]*n)return!1;let u=this.model.M[t.position.ni(h,n).toString()];return!(t instanceof E)&&u&&t.F===u.F?!1:(i.push(t.Ce[r]),!0)}).map((s,r)=>[this.Be(s,t.rt,e),i[r]]).filter(([s])=>s.length)}qt(t,e){for(let[i,s]of this.Oi(t))e(i,s)}Ht(t,e){let i=this.model.I.add(t.o(-1));return this.model.I.add(e.o(-1)).values.every((r,n)=>Math.sign(r)*(r-i.values[n])<=0)}Pi(t){let e=Object.values(this.model.K).map((r,n)=>{let h=l.P-10*Number.EPSILON,u=(l.g+l.C)/2-10*Number.EPSILON,a=r.ot.position.O().q((l.C-l.g)/2),f=this.model.t.coords.o(1/o).add(a.o(-1)),p=a.O().N(J(f.x,h)).q(J(f.y,u)).U(J(f.z,h)).map(Math.floor),c=a.O().N((Math.abs(f.x)<h&&this.model.I.x!=Math.floor(a.x+Math.sign(f.x)*h)?1:-1)*Math.sign(f.x)*h).q((Math.abs(f.y)<u&&this.model.I.y!=Math.floor(a.y+Math.sign(f.y)*u)?1:-1)*Math.sign(f.y)*u).U((Math.abs(f.z)<h&&this.model.I.z!=Math.floor(a.z+Math.sign(f.z)*h)?1:-1)*Math.sign(f.z)*h).map(Math.floor);return[[this.model.I.It(p),r.ot,p,c,n.toString()],[this.model.I.It(c),r.ot,p,c,n.toString()]]}).flat(),i=this.model.he();if(i&&i.D.y<0){i.D.values[i.axis]+=i.dir;let r=[i.D,i.D.O().N(1),i.D.O().N(1).U(1),i.D.O().U(1)].map(this.model.Ne);t(this.Be([0,1,2,3],r,r.map(n=>this.Bt(n))),"transparent")}if(Object.keys(this.model.M).length>512){let r=new x(this.model.t.m.angle+Math.PI/2),n=new x(this.model.t.pitch.angle+Math.PI/2),h=m.angle(this.model.t.m,this.model.t.pitch),u=m.angle(r,new x(0)),a=m.angle(this.model.t.m,n),f=new x(this.model.t.m.angle-Math.floor((2*Math.PI+this.model.t.m.angle+Math.PI/4)%(2*Math.PI)/(Math.PI/2))*(Math.PI/2)),p=o/u.Jt,c,d,y,w;Math.abs(this.model.t.pitch.angle)<=Math.PI/4?(c=f.cos*o*this.model.t.pitch.cos,d=o/a.Jt,y=f.tan/this.model.t.pitch.cos*c/o,w=this.model.t.pitch.tan*c/o):(c=o/h.Jt,d=f.cos*o*Math.abs(this.model.t.pitch.sin),y=-Math.sign(this.model.t.pitch.angle)*f.tan/Math.abs(this.model.t.pitch.sin)*d/o,w=Math.sign(this.model.t.pitch.angle)*Math.tan(Math.PI/2-Math.abs(this.model.t.pitch.angle))*d/o);let j=Math.ceil(this.model.l.oe*o/c),k=this.R/this.model.l.v*j*c,O=this.T/this.model.l.v*j*c;for(let I of C(j+2)){let v=(j-I)*c,V=this.R/this.model.l.v*v+3*o,_=this.T/this.model.l.v*v+3*o;Math.abs(this.model.t.pitch.angle)<=Math.PI/4&&(V+=(p+(k+I*y*o-V)%p)%p,_+=(d+(O+I*w*o-_)%d)%d);let at=this.model.t.coords.add(h.o(v)).add(a.o(_)).add(u.o(V)),K=Math.ceil(2*V/p)+1,B=Math.ceil(2*_/d)+1;for(let lt of C(B)){let Y=at.add(a.o(-lt*d));if(Math.abs(this.model.t.pitch.angle)>Math.PI/4&&(Y=Y.add(u.o((p+((Math.floor((O-_)/d)+lt)*y*o+k-V)%p)%p)).add(h.o((c+(Math.floor((O-_)/d)+lt)*w*o%c)%c)).add(a.o((d+(O-_)%d)%d))),Y.y<0)break;for(let Vt of C(K)){let xt=Y.add(u.o(-Vt*p)),ct=this.model.et(xt);if(this.model.I.si(ct)>this.model.l.oe)continue;let bt=this.model.M[ct.toString()];bt&&e.push([this.model.I.It(ct),bt])}}}}else e.push(...Object.values(this.model.M).map(r=>[this.model.I.It(r.position),r]));let s={};t:for(let[r,n,h,u,a]of e.sort(([f],[p])=>p-f))if(!h||!u||!a)if(!Object.keys(s).length)this.qt(n,t);else{for(let{ae:f,min:p,max:c}of Object.values(s))if(this.Ht(p,n.position)||this.Ht(c,n.position)){f.push(n);continue t}this.qt(n,t)}else if(!s[a])s[a]={ae:[],min:h,max:u};else{this.qt(n,t);let f=Object.keys(s).indexOf(a);e:for(let p of s[a].ae){for(let{ae:c,min:d,max:y}of Object.values(s).slice(f+1))if(this.Ht(d,p.position)||this.Ht(y,p.position)){c.push(p);continue e}this.qt(p,t)}delete s[a]}}vi(){let t=-this.model.t.pitch.tan*this.model.l.v;return[t,Math.max(Math.min(t,this.height/2),-this.height/2)]}_i(t){let e=new x(-Math.PI/4),i=new x(-Math.PI/6),s=-i.cos,n=(e.sin-e.cos)*i.sin-s,h=n/2-Math.abs(s),u=this.Lt(t,new m(0,1,0),e,i);return new g(u.x/n*.8*this.Pt,(u.y-h)/n*.8*this.Pt)}Ci(t){let e=new t(new m(0,0,0),1),i=e.rt.map(this._i,this);return e.nt.map((s,r)=>[s.map(n=>i[n]),e.Ce[r]]).filter((s,r)=>{let[n,h]=e.ht[r];return!e.F||n<0&&["x","z"].includes(h)||n>0&&h==="y"})}};var A=class extends G{constructor(e){super(e,new Z(e));this.le=document.getElementById("pause_screen");this._t=document.getElementById("menu_screen");this.dt=this._t.querySelector("#world_list");this.Ei=this._t.querySelector("#world_template");this.qe=document.getElementById("open_room");this.ki=document.getElementById("fps");this.Ft=1;this.zt=Array(this.Ft).fill(0);this.X=0;this.Di=(e,i)=>{this.i.fillStyle=i,this.i.beginPath();let s=e[0];this.i.moveTo(Math.round(s.x+this.h.x),Math.round(this.h.y-s.y));for(let r of e.slice(1))this.i.lineTo(Math.round(r.x+this.h.x),Math.round(this.h.y-r.y));this.i.closePath(),this.i.fill(),this.i.stroke()};this.me=e=>{let i=this.Ii(),s=(e-this.zt[0])/this.Ft;s<=0&&(this.Ft+=5),this.zt.length>=this.Ft&&this.zt.shift(),this.zt.push(e),this.ki.textContent=Math.round(1e3/s).toString(),this.model.status==="running"?(this.model.Si(s),this.ce(),this.Ri(),this.Ti()):i&&this.Fe(),this.X=requestAnimationFrame(this.me)};this.i=A.getContext("canvas"),this.yi()}Te(e){let i=document.body.classList;e?i.add("dark"):i.remove("dark")}Le(){this.model.status==="paused"&&this.ce()}transform(){this.i.resetTransform(),this.i.translate(0,.5),this.i.lineJoin="bevel"}static He(e){let i=document.getElementById(e);if(!(i instanceof HTMLCanvasElement))throw new Error(`The element of id "${e}" is not a HTMLCanvasElement.`);return i}static getContext(e){let i=this.He(e).getContext("2d",{alpha:!1});if(i===null)throw new Error("This browser does not support 2-dimensional canvas rendering contexts.");return i}Ii(){let e=this.i.canvas.clientWidth,i=this.i.canvas.clientHeight;return this.i.canvas.width!=e||this.i.canvas.height!=i?(this.i.canvas.width=e,this.i.canvas.height=i,this.h.x=e/2,this.h.y=i/2,this.resize(e,i),this.transform(),!0):!1}ce(){this.i.clearRect(0,0,this.width,this.height),this.i.lineWidth=.5,this.i.strokeStyle="#444";let[e,i]=this.vi(),s=this.i.createLinearGradient(0,this.h.y-e,0,0);s.addColorStop(0,"#b3bdc1"),s.addColorStop(1,"#80b7de"),this.i.fillStyle=s,this.h.y>e&&this.i.fillRect(0,0,this.width,this.h.y-i),s=this.i.createLinearGradient(0,this.h.y-e,0,this.height),s.addColorStop(0,"#578000"),s.addColorStop(Math.pow(.97,this.model.t.coords.y/o*l.g),"#408000"),this.i.fillStyle=s,e>-this.h.y&&this.i.fillRect(0,this.h.y-i,this.width,this.h.y+i),this.Pi(this.Di),this.i.font="20px Verdana",this.i.fillStyle="white",this.i.strokeStyle="black",this.i.textAlign="center";for(let r of Object.values(this.model.K))if(r.name){let n=this.Bt(r.coords.O().q(2*l.C*o));n instanceof g&&(this.i.fillText(r.name,this.h.x+n.x,this.h.y-n.y),this.i.strokeText(r.name,this.h.x+n.x,this.h.y-n.y))}this.A>0&&(this.i.beginPath(),this.i.moveTo(this.A,this.A),this.i.lineTo(this.width-this.A,this.A),this.i.lineTo(this.width-this.A,this.height-this.A),this.i.lineTo(this.A,this.height-this.A),this.i.closePath(),this.i.stroke())}Ri(){let e=20,i=2;this.i.fillStyle="black",this.i.fillRect(this.h.x-i/2,this.h.y-e/2,i,e),this.i.fillRect(this.h.x-e/2,this.h.y-i/2,e,i)}Ti(){let e=this.height-(this.Pt+1.5*this.vt)-this.De,i=this.Pt+this.vt,s=[0,e,0,e+i],r=this.i.createLinearGradient(...s);r.addColorStop(0,"#bbb"),r.addColorStop(1,"#a0a0a0");let n=this.i.createLinearGradient(...s);n.addColorStop(0,"#ccc"),n.addColorStop(1,"#b0b0b0"),this.i.resetTransform();for(let h of C(10)){let u=this.model.Kt[h];if(this.i.fillStyle=this.model.yt===h?n:r,this.i.lineWidth=this.vt,this.i.strokeStyle="#848999",this.i.beginPath(),this.i.rect(this.h.x+(h-5)*i,e,i,i),this.i.fill(),this.i.stroke(),u){this.i.lineWidth=.5,this.i.strokeStyle="#444";for(let[a,f]of this.Ci(u)){this.i.fillStyle=f,this.i.beginPath();let p=a[0],c=new g(this.h.x+(h-4.5)*i,this.height-this.Pt/2-this.vt-this.De);this.i.moveTo(p.x+c.x,c.y-p.y);for(let d of a.slice(1))this.i.lineTo(d.x+c.x,c.y-d.y);this.i.closePath(),this.i.fill(),this.i.stroke()}}}this.i.lineWidth=this.vt+2,this.i.strokeStyle="#e0dddd",this.i.strokeRect(this.h.x+(this.model.yt-5)*i,e,i,i),this.transform()}Fe(){this.model.status==="paused"&&(this.ce(),this.le.classList.add("active"),this._t.classList.remove("active"))}async Ai(){if(this.model.status==="menu"){this.dt.replaceChildren();for(let[e,i,s]of(await this.model.ue()).sort((r,n)=>new Date(n[2]).getTime()-new Date(r[2]).getTime())){let r=this.Ei.cloneNode(!0);r.childNodes[1].childNodes[0].textContent=i,r.childNodes[1].childNodes[1].textContent=new Date(s).toLocaleString([],{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),r.removeAttribute("id"),r.dataset.id=e.toString(),this.dt.appendChild(r)}if(!this.dt.childElementCount){let e=document.createElement("div");e.appendChild(document.createTextNode("No worlds yet...")),e.setAttribute("id","worlds_placeholder"),this.dt.appendChild(e)}this.le.classList.remove("active"),this._t.classList.add("active")}}start(){this.X||(this.X=requestAnimationFrame(this.me)),this.le.classList.remove("active"),this._t.classList.remove("active")}pause(){this.X||(this.X=requestAnimationFrame(this.me)),this.Fe()}k(){this.X&&cancelAnimationFrame(this.X),this.X=0,this.Ai()}};var tt=class{constructor(t){this.be=!1;this.model=t,this.model.Li(this)}init(){this.model.status==="running"&&this.start(),this.model.status==="paused"&&this.pause(),this.model.status==="menu"&&this.k()}};var et=class extends tt{constructor(e){var s;super(e);this.gt={};this.os=0;this.canvas=A.He("canvas");this.Bi=document.getElementById("menu_return");this.qe=document.getElementById("open_room");this.dt=document.getElementById("world_list");this.Ni=document.getElementById("create_world");this.ze=document.getElementById("world_upload");this.fe=document.getElementById("error_screen");this.Ke=e=>{this.model.turn(e.movementX/100*this.model.l.de,-e.movementY/100*this.model.l.de)};this.We=e=>{e.button===0?this.model.Fi():e.button===2&&this.model.zi()};this.$e=e=>{this.model.Ue(this.model.yt+Math.sign(e.deltaY))};this.Wt=e=>{e.type==="keyup"?(this.gt[e.code]&&delete this.gt[e.code],/^Digit[0-9]$/.test(e.code)&&this.model.Ue((10+parseInt(e.code[5])-1)%10)):(this.gt[e.code]||(this.gt[e.code]=!0),e.code==="Space"&&(this.be=!0))};this.qi(),this.init();let i=new URLSearchParams(window.location.search).keys().next().value;if(e.u&&i){this.fe.style.display="flex";let r=n=>{n&&e.u?e.u.init("client",i,n.slice(0,16),h=>{var u;h instanceof Error&&((u=this.model.W)==null||u.B.Ot("Room Error",h.message,()=>{})),this.fe.style.display="none"}):this.fe.style.display="none"};(s=this.model.W)==null||s.B.ne("Join Room","Choose a name:",r,"Your IP address will be shared with the host")}}Hi(){this.be=!1;let e=["KeyA","KeyD","KeyS","KeyW"];return[["x",-1],["x",1],["z",-1],["z",1]].filter((s,r)=>this.gt[e[r]])}qi(){var e,i,s,r,n;document.addEventListener("pointerlockchange",()=>{document.pointerLockElement&&this.model.status==="paused"?this.model.start():this.model.pause()},!1),(e=this.Bi)==null||e.addEventListener("click",()=>this.model.k()),(i=this.qe)==null||i.addEventListener("click",()=>{var h,u;if(this.model.u)if(this.model.u.isOpen)(h=this.model.W)==null||h.B.Ot("Room URL",`https://0mds.github.io/project-cubes?${this.model.u.pe}`,()=>{},!0);else{let a=f=>{var p;f&&((p=this.model.u)==null||p.init("host","",f.slice(0,16),c=>{var d,y;c instanceof Error?(d=this.model.W)==null||d.B.Ot("Room Error",c.message,()=>{}):(y=this.model.W)==null||y.B.Ot("Room URL",`https://0mds.github.io/project-cubes?${c}`,()=>{},!0)}))};(u=this.model.W)==null||u.B.ne("Open Room","Choose a name:",a,"Your IP address will be shared with connecting peers, and consider backing up your world")}}),(s=this.Ni)==null||s.addEventListener("click",()=>this.model.ye()),(r=this.ze)==null||r.addEventListener("change",async()=>{var u;let h=(u=this.ze)==null?void 0:u.files;if(!(h.length<=0))for(let a of h)a.type==="application/json"&&this.model.ge(JSON.parse(await a.text()))}),(n=this.dt)==null||n.addEventListener("click",async h=>{let u=h.target,a=u.closest(".world");if(u.tagName!=="A"&&a&&(u=a),u.classList.contains("world")&&u.dataset.id)this.model.Ki(parseInt(u.dataset.id));else if(u.classList.contains("remove")&&a.dataset.id)this.model.we(parseInt(a.dataset.id));else if(u.classList.contains("export")&&a.dataset.id){let f=await this.model.Me(parseInt(a.dataset.id)),p=new Blob([JSON.stringify(f)],{type:"application/json"}),c=URL.createObjectURL(p),d=document.createElement("a");d.href=c,d.download=`[ProjectCubes] ${f.name.replace(/[\/\\:*?"<>]/g,"")}.json`,d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(c)}else u.classList.contains("rename")&&a.dataset.id&&this.model.Ve(parseInt(a.dataset.id))}),document.querySelectorAll(".settings").forEach(h=>h.addEventListener("click",this.model.St))}start(){document.addEventListener("mousemove",this.Ke,!1),document.addEventListener("mousedown",this.We,!1),document.addEventListener("wheel",this.$e,!1),this.canvas.addEventListener("keyup",this.Wt),this.canvas.addEventListener("keydown",this.Wt),this.canvas.removeEventListener("click",this.canvas.requestPointerLock)}pause(){this.gt={},document.removeEventListener("mousemove",this.Ke,!1),document.removeEventListener("mousedown",this.We,!1),document.removeEventListener("wheel",this.$e,!1),this.canvas.removeEventListener("keyup",this.Wt),this.canvas.removeEventListener("keydown",this.Wt),this.canvas.addEventListener("click",this.canvas.requestPointerLock)}k(){this.canvas.removeEventListener("click",this.canvas.requestPointerLock)}};var it=class{};var st=class extends it{constructor(){super();this.ready=new Promise((e,i)=>{let s=indexedDB.open("WorldsDB");s.onerror=r=>{console.error(`IndexedDB error: ${s.error}`,r),i(s.error)},s.onsuccess=r=>{this.db=r.target.result,e()},s.onupgradeneeded=r=>{this.db=r.target.result,this.db.onerror=h=>{console.error(`Database error: ${h.target.errorCode}`)},this.db.createObjectStore("worlds",{keyPath:"id",autoIncrement:!0});let n=this.db.createObjectStore("settings",{autoIncrement:!1});n.transaction.oncomplete=()=>{let h=this.db.transaction("settings","readwrite").objectStore("settings").add({},1);h.onerror=()=>i(h.error),h.onsuccess=()=>e()}}})}async ue(){return new Promise((e,i)=>{let s=this.db.transaction("worlds").objectStore("worlds").getAll();s.onerror=()=>i(s.error),s.onsuccess=()=>e(s.result.map(r=>[r.id,r.name,r.lastPlayed]))})}async Ye(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds").objectStore("worlds").get(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i([r.result.pos,r.result.yVelocity,r.result.yaw,r.result.pitch,Object.entries(r.result.objects)])})}async xe(e,i,s,r,n){let h=this.db.transaction("worlds","readwrite").objectStore("worlds");h.get(e).onsuccess=u=>{let a=u.target.result;a.lastPlayed=new Date().toISOString(),a.pos=i.toString(),a.yVelocity=s,a.yaw=r.angle,a.pitch=n.angle,h.put(a)}}async Wi(e,i,s){let r=this.db.transaction("worlds","readwrite").objectStore("worlds");r.get(e).onsuccess=n=>{let h=n.target.result;h.objects[i.toString()]=T.indexOf(s),r.put(h)}}async $i(e,i){let s=this.db.transaction("worlds","readwrite").objectStore("worlds");s.get(e).onsuccess=r=>{let n=r.target.result;delete n.objects[i.toString()],s.put(n)}}async ye(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").add({name:"New World",lastPlayed:new Date().toISOString(),pos:e.toString(),yVelocity:0,yaw:0,pitch:0,objects:{}});r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async we(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").delete(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async Ve(e,i){return new Promise((s,r)=>{let n=this.db.transaction("worlds","readwrite").objectStore("worlds"),h=n.get(e);h.onerror=()=>r(h.error),h.onsuccess=u=>{let a=u.target.result;a.name=i.slice(0,69);let f=n.put(a);f.onerror=()=>r(f.error),f.onsuccess=()=>s()}})}async Me(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds").objectStore("worlds").get(e);r.onerror=()=>s(r.error),r.onsuccess=()=>{delete r.result.id,i(r.result)}})}async ge(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").add(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async Ui(e){let i=this.db.transaction("settings","readwrite").objectStore("settings");i.get(1).onsuccess=s=>{let r=s.target.result;for(let[n,h]of Object.entries(e))r[n]=h;i.put(r,1)}}async getSettings(){return new Promise((e,i)=>{let s=this.db.transaction("settings").objectStore("settings").get(1);s.onerror=()=>i(s.error),s.onsuccess=()=>e(s.result)})}};var gt=Peer;var rt=class{constructor(t){this.$t="0";this.$={};this.name="";this.Et=!1;this.wt=[];this.Ut=(t,e)=>{var i;if(this.Zi(t))if(this.type==="host"&&this.Xe(t,e),t.type==="init"&&this.type==="client")this.$t=t.idInRoom,delete t.players[this.$t],this.model.Qe(new l(t.player),t.objects,Object.fromEntries(Object.entries(t.players).map(([s,r])=>[s,new U(r)]))),this.send(this.Ct,{type:"rename",origin:this.$t,name:this.name}),this.tt(this.id);else if(t.type==="player_join")this.model.K[t.id]=new U(t.player);else if(t.type==="player_leave")delete this.model.K[t.id];else if(t.type==="update"){if(t.player&&(this.model.K[t.origin].t=new l(t.player)),t.objects)for(let[s,r]of t.objects)r>=0?this.model.Ze(m.parse(s),(i=T[r])!=null?i:M):this.model.Ge(m.parse(s))}else t.type==="rename"&&(this.model.K[t.origin].name=t.name.slice(0,16))};this.model=t}init(t,e,i,s){this.type=t,this.$={},this.Ct=void 0,this.Et=!1,this.name=i,t==="host"&&s?(this.Yi(),s(this.id),this.pe=this.id):e&&(this.tt=s,this.Ct=this.connect(e),this.pe=e)}Ji(){this.model.status!=="menu"&&(this.model.pause(),this.model.k())}async Xi(t){if(Object.keys(this.$).length>=16)return this.reject(t);let e=Object.keys(this.$),i=e.length?parseInt(e[e.length-1])+1:1,s=new l;for(s.coords.N(.5*o).U(.5*o);D(this.model.Je(s.coords.y/o)).some((r,n)=>this.model.M[this.model.et(s.coords.O().q((n-l.g)*o)).toString()]);)s.coords.N(o);this.Ut({type:"player_join",id:i.toString(),player:s.G}),this.$[i]=t,this.send(t,{type:"init",idInRoom:i.toString(),player:s.G,objects:(await this.model.db.Ye(this.model.S))[4],players:{0:{name:this.name,...this.model.t.G},...Object.fromEntries(Object.entries(this.model.K).map(([r,n])=>[r,n.G]))}})}Qi(t){let e=Object.keys(this.$)[Object.values(this.$).indexOf(t)];delete this.$[e],this.Ut({type:"player_leave",id:e})}Zi(t){return!!t&&typeof t=="object"&&(t.type==="init"&&typeof t.idInRoom=="string"&&typeof t.player=="object"&&typeof t.objects=="object"&&typeof t.players=="object"||t.type==="player_join"&&typeof t.id=="string"&&typeof t.player=="object"||t.type==="player_leave"&&typeof t.id=="string"||t.type==="update"&&typeof t.origin=="string"&&(!("player"in t)||typeof t.player=="object")&&(!("objects"in t)||typeof t.objects=="object")||t.type==="rename"&&typeof t.origin=="string"&&typeof t.name=="string")}Xe(t,e){for(let i of Object.values(this.$))i!==e&&this.send(i,t)}Gi(){if(!this.Et&&!this.wt.length)return;let t={type:"update",origin:this.$t};this.Et&&(t.player=this.model.t.G),this.wt.length&&(t.objects=this.wt),this.Et=!1,this.wt=[],this.type==="host"?this.Xe(t):this.send(this.Ct,t)}};var nt=class extends rt{init(e,i,s,r){this.disconnect(),this._=new gt,this._.on("open",()=>super.init(e,i,s,r)),this._.on("close",this.Ji,this),this._.on("error",n=>{this.disconnect(),r(n)})}get isOpen(){return this._&&this._.open}get isActive(){return this.isOpen&&(!!this.Ct||Object.keys(this.$).length>0)}get id(){return this._.id}Yi(){this._.on("connection",e=>{e.on("open",()=>this.Xi(e)),e.on("data",i=>this.Ut(i,e)),e.on("close",()=>this.Qi(e))}),this._.on("disconnected",()=>{this.isOpen&&this._.reconnect()})}reject(e){e.close()}connect(e){var i=this._.connect(e);return i.on("data",this.Ut),i.on("close",this.disconnect,this),i.on("error",s=>{this.disconnect(),this.tt(s)}),i}disconnect(){this._&&this._.destroy()}send(e,i){e.send(i)}};var ht=class{constructor(t){this.de=0;this.oe=0;this.Ae=!1;this.ts=0;this.v=0;this.bt={de:{name:"Sensitivity",At:"Mouse sensitivity when looking around",type:"number",min:.1,max:10,round:!1,default:1},oe:{name:"Render Distance",At:"Distance in which objects are visible (in worlds with more than 512 cubes)",type:"number",min:10,max:30,round:!0,default:18,Yt:()=>this.model.views.forEach(t=>t.Le())},Ae:{name:"Dark Mode",At:"Like night and day",type:"boolean",default:!1,Yt:t=>this.model.views.forEach(e=>e.Te(t))},ts:{name:"FOV",At:"Field of view of character",type:"number",min:30,max:60,round:!0,default:45,Yt:t=>{this.v=(1-t/100)*o,this.model.views.forEach(e=>e.gi())}}};this.es=Object.fromEntries(Object.entries(this.bt).map(([t,e])=>[e.name,t]));this.set=(t,e=!0)=>{if(!t)return;let i=!1;for(let[s,r]of Object.entries(t)){let n=this.bt[s];if(n&&typeof r===n.type){if(this[s]===r)continue;if(n.type==="number")if((!n.min||r>=n.min)&&(!n.max||r<=n.max))this[s]=n.round?Math.ceil(r):r;else continue;else this[s]=r;i=!0,n.Yt&&n.Yt(r)}}e&&i&&this.model.db.Ui(Object.fromEntries(Object.entries(this.get()).map(([s,r])=>[this.bt[s].name,r])))};this.model=t,this.reset(!1)}reset(t=!0){this.set(Object.fromEntries(Object.entries(this.bt).map(([e,i])=>[e,i.default])),t)}get(){return Object.fromEntries(Object.keys(this.bt).map(t=>[t,this[t]]))}};var ot=class{constructor(t){this.t=new l;this.I=m.it();this.K={};this.Kt=[N,q,H,F,L,z];this.yt=0;this.M={};this.status="menu";this.views=[];this.Mt=[];this.S=-1;this.l=new ht(this);this.St=()=>{var t;(t=this.W)==null||t.B.St(this.l.get(),this.l.set)};this.ti=t=>{let e=t.x%o/o-Math.sign(t.x)*.5,i=t.z%o/o-Math.sign(t.z)*.5,s=[this.et(t)];return Math.abs(e)>.5-l.P&&s.push(s[0].O().N(Math.sign(e))),Math.abs(i)>.5-l.P&&s.push(s[0].O().U(Math.sign(i))),Math.abs(e)>.5-l.P&&Math.abs(i)>.5-l.P&&s.push(s[0].O().N(Math.sign(e)).U(Math.sign(i))),s};this.db=t,this.db.getSettings().then(e=>this.l.set(Object.fromEntries(Object.entries(e).map(([i,s])=>[this.l.es[i],s])),!1))}ss(t){this.u=t}get W(){if(this.views.length)return this.views[0]}async ue(){return await this.db.ue()}Qe(t,e,i={}){var s;this.t=t,this.I=this.et(this.t.coords),this.K=i;for(let[r,n]of e)this.M[r]=new((s=T[n])!=null?s:M)(m.parse(r));this.pause()}async Ki(t){this.S=t;let[e,i,s,r,n]=await this.db.Ye(t),h=m.parse(e);this.Qe(new l({yaw:s,pitch:r,x:h.x,y:h.y,z:h.z,yVelocity:i}),n)}rs(){this.S=-1,this.M={},this.u&&this.u.disconnect()}async ye(){await this.db.ye(new m(0,l.g*o,0)),this.views.forEach(t=>t.k())}async we(t){var i;let e=async s=>{s&&(await this.db.we(t),this.views.forEach(r=>r.k()))};(i=this.W)==null||i.B.Ot("Delete World","Are you sure you want to delete this world?",e)}async Ve(t){var i;let e=async s=>{s&&(await this.db.Ve(t,s.toString()),this.views.forEach(r=>r.k()))};(i=this.W)==null||i.B.ne("Rename World","New name:",e)}Me(t){return this.db.Me(t)}async ge(t){try{if(!yt(Object.keys(t),["name","lastPlayed","pos","yVelocity","yaw","pitch","objects"]))throw new Error("Corrupt File");if(!(typeof t.name=="string"&&t.name.length>0&&t.name.length<=69))throw new Error("Invalid name");if(!(typeof t.lastPlayed=="string"&&t.lastPlayed.length===24&&(e=>!isNaN(e)&&e.toISOString()===t.lastPlayed)(new Date(t.lastPlayed))))throw new Error("Invalid lastPlayed");if(!(m.je(t.pos)&&parseInt(t.pos.split("_")[1])>=l.g*o))throw new Error("Invalid pos");if(typeof t.yVelocity!="number")throw new Error("Invalid yVelocity");if(!(typeof t.yaw=="number"&&t.yaw<=2*Math.PI&&t.yaw>=-2*Math.PI))throw new Error("Invalid yaw");if(!(typeof t.pitch=="number"&&t.pitch<=Math.PI/2&&t.pitch>=-Math.PI/2))throw new Error("Invalid pitch");if(!(typeof t.objects=="object"&&Object.keys(t.objects).every(e=>m.je(e))&&Object.values(t.objects).every(e=>typeof e=="number"&&e===Math.floor(e)&&e>=0&&e<T.length)))throw new Error("Invalid objects");await this.db.ge(t),this.views.forEach(e=>e.k())}catch(e){console.error(`Import Error: ${e}`)}}pi(t){this.views.push(t)}Li(t){this.Mt.push(t)}Si(t){this.move(t),this.u&&this.u.isActive&&this.u.Gi()}start(){this.status!=="running"&&(this.status="running",this.Mt.forEach(t=>t.start()),this.views.forEach(t=>t.start()))}pause(){this.status!=="paused"&&(this.S>=0&&this.db.xe(this.S,this.t.coords,this.t.p,this.t.m,this.t.pitch),this.status="paused",this.Mt.forEach(t=>t.pause()),this.views.forEach(t=>t.pause()))}k(){this.status==="paused"&&(this.status="menu",this.rs(),this.Mt.forEach(t=>t.k()),this.views.forEach(t=>t.k()))}Ne(t){return t.map(e=>e*o)}et(t){return t.map(e=>Math.floor(e/o))}Je(t){return Math.floor(t+l.C)-Math.floor(t-l.g)+1}Vt(t){let e=t.y-l.g*o;return this.t.p<=0&&e%o===0&&(e===0||this.ti(new m(t.x,e,t.z)).some(i=>this.M[i.q(-1).toString()]))}ei(t,e,i,s,r){if(this.Vt(new m(s,this.t.coords.y,r)))return this.t.coords.y;let n=(i-t)*e/1e3;return Math.round(this.t.coords.y+.5*l.Z*Math.pow(n,2)+this.t.p*n)}ii(t,e,i,s,r){let n;if(this.Vt(new m(s,this.t.coords.y,r)))n=[s,r].map((h,u)=>((1+Math.sign(i.values[2*u])*l.P)%1*o-(o+h)%o)/i.values[2*u]);else{let h=(Math.floor(this.t.coords.y/o+l.C)+1)*o,u=Math.floor((this.t.coords.y-1)/o-l.g)*o,a=Math.sqrt(Math.pow(this.t.p/l.Z,2)-2*(this.t.coords.y+l.C*o-h)/l.Z);(isNaN(a)||this.t.p<0)&&(a=Math.sqrt(Math.pow(this.t.p/l.Z,2)-2*(this.t.coords.y-l.g*o-u)/l.Z)),n=[-1,1].map(f=>1e3*(-this.t.p/l.Z+f*a)/e)}return{axis:1,L:Math.min(...n.filter(h=>h>=0))+t}}ns(t){return isNaN(t)?1/0:t}move(t){let e=this.t.coords.O(),i=this.Mt.some(c=>c.be),[s,r]=this.Mt.map(c=>c.Hi()).flat().reduce(([c,d],[y,w])=>y==="x"?[c+w,d]:[c,d+w],[0,0]);t=o*Math.min(1/Math.sqrt(Math.pow(s,2)+Math.pow(r,2)),t*l.te/o)/l.te;let n=t*l.te,h=new m(s*this.t.m.cos-r*this.t.m.sin,0,s*this.t.m.sin+r*this.t.m.cos).map(c=>c*n|0);i&&this.Vt(this.t.coords)&&(this.t.p=l.mi);let u=this.t.coords.x+h.values[0],a=this.t.coords.z+h.values[2],f=0,p=[0,2].map(c=>({axis:c,L:this.ns(((Math.sign(this.t.coords.values[c])-Math.sign(h.values[c])*l.P)%1*o-this.t.coords.values[c]%o)/h.values[c])}));for(p.push(this.ii(f,t,h,this.t.coords.x,this.t.coords.z)),p.sort(({L:c},{L:d})=>c-d);p.length&&p[0].L<=1;){let{axis:c,L:d}=p.shift();if(d<0)continue;let y=u===this.t.coords.x+h.values[0]?this.t.coords.x+d*h.values[0]:u,w=a===this.t.coords.z+h.values[2]?this.t.coords.z+d*h.values[2]:a,j=this.ei(f,t,d,y,w);if(c!=1){let k=c===0?w:y,O=k%o/o-Math.sign(k)*.5,I=this.Je(j/o),v=this.et(new m(k,j-l.g*o,this.t.coords.values[c])).q(-1).U(Math.sign(h.values[c])),V=v.O().N(Math.sign(O)),_=[v];Math.abs(O)>.5-l.P&&_.push(V),D(I).some((at,K)=>_.some(B=>this.M[c==0?`${B.z}_${B.y+K+1}_${B.x}`:B.q(1).toString()]))?c==0?u=y:a=w:Math.abs(O)===.5-l.P&&Math.sign(O)*h.values[2-c]>0&&D(I).some((at,K)=>this.M[c==0?`${V.z}_${V.y+K+1}_${V.x}`:V.q(1).toString()])&&(c==2?u=y:a=w)}else{let k=this.t.p<0&&this.Vt(new m(y,j,w)),O=this.t.p>0&&this.ti(new m(y,j+l.C*o,w)).some(v=>this.M[v.toString()]),I=this.t.p===0&&!this.Vt(new m(y,j,w));(k||O||I)&&(f=d,this.t.p=0,this.t.coords.y=j,p.push(this.ii(f,t,h,y,w)),p.sort(({L:v},{L:V})=>v-V))}}this.t.coords.x=u,this.t.coords.z=a,this.t.coords.y=this.ei(f,t,1,this.t.coords.x,this.t.coords.z),this.Vt(this.t.coords)||(this.t.p+=l.Z*(1-f)*t/1e3),!e.isEqual(this.t.coords)&&this.u&&this.u.isActive&&(this.u.Et=!0),this.I=this.et(this.t.coords)}turn(t,e){this.t.m.set((this.t.m.angle-t)%(2*Math.PI)),this.t.pitch.set(Math.max(Math.min(this.t.pitch.angle+e,1/2*Math.PI),-1/2*Math.PI))}he(){let t=m.angle(this.t.m,this.t.pitch).o(l.ui);return[0,1,2].map(e=>{let i=(o-Math.sign(t.values[e])*(this.t.coords.values[e]%o))%o/Math.abs(t.values[e]),s=Math.floor((1-i)*Math.abs(t.values[e])/o);return i<=1?D(s+1).map((r,n)=>({axis:e,L:i+n*o/Math.abs(t.values[e])})):[]}).flat().sort(({L:e},{L:i})=>e-i).map(({axis:e,L:i})=>({D:this.et(this.t.coords.add(t.o(i)).map(Math.round)).map((s,r)=>r==e&&t.values[r]<0?s-1:s),axis:e,dir:-Math.sign(t.values[e])})).find(({D:e})=>e.y<0||this.M[e.toString()])}Ue(t){t>=0&&t<this.Kt.length&&(this.yt=Math.floor(t))}hs(t,e){return!(t.coords.x<=(e.x-l.P)*o||t.coords.x>=(e.x+1+l.P)*o||t.coords.z<=(e.z-l.P)*o||t.coords.z>=(e.z+1+l.P)*o||t.coords.y<=(e.y-l.C)*o||t.coords.y>=(e.y+1+l.g)*o)}Ge(t){this.M[t.toString()]&&(delete this.M[t.toString()],this.S>=0&&(this.db.$i(this.S,t),this.db.xe(this.S,this.t.coords,this.t.p,this.t.m,this.t.pitch)))}Fi(){let t=this.he();t&&(this.Ge(t.D),this.u&&this.u.isActive&&this.u.wt.push([t.D.toString(),-1]))}Ze(t,e){this.M[t.toString()]||(this.M[t.toString()]=new e(t),this.S>=0&&(this.db.Wi(this.S,t,e),this.db.xe(this.S,this.t.coords,this.t.p,this.t.m,this.t.pitch)))}zi(){let t=this.he();if(t){t.D.values[t.axis]+=t.dir;let e=t.D;[this.t,...Object.values(this.K)].some(i=>this.hs(i,e))||(this.Ze(t.D,this.Kt[this.yt]),this.u&&this.u.isActive&&this.u.wt.push([e.toString(),T.indexOf(this.Kt[this.yt])]))}}};var wt=document.getElementById("error_screen"),Mt=new st;Mt.ready.then(()=>{let b=new ot(Mt);b.ss(new nt(b)),new A(b),new et(b)}).catch(b=>{console.error(b),wt.querySelector("div").textContent="IDB Error: Please try deactivating private browsing or updating your browser",wt.style.display="flex"});})();
