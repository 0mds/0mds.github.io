//! Copyright 2023 0mds
"use strict";(()=>{var j=class{constructor(t){this.angle=0;this.sin=0;this.cos=1;this.tan=0;this.set(t)}set(t){this.angle=t,this.sin=Math.sin(t),this.cos=Math.cos(t),this.tan=Math.tan(t)}};function mt(b,t,e){return t<b.length?b.reduce((i,s,r)=>(r!=t?i.push(s):i.push(e,s),i),[]):[...b,e]}function bt(b,t){let e=b.slice(t,b.length);return e.push(...b.slice(0,t)),e}var ft=1e-5;function dt(b,t){return b===t?!0:b==null||t==null||b.length!==t.length?!1:(b=[...b].sort(),t=[...t].sort(),b.every((e,i)=>e===t[i]))}function z(b,t){return Math.abs(b-t)<ft}function ot(b,t){return b<=t+ft}var W=class{constructor(...t){let e=this.constructor.dimensions;if(e>0&&t.length!=e)throw new Error("Invalid number of dimensions");this.values=t}Ct(t){return new this.constructor(...t)}static parse(t){return new this(...t.split("_").map(e=>parseInt(e)))}static wt(t=0){return new this(...Array(this.dimensions||t).fill(0))}static ge(t){let e=t.split("_").map(i=>parseInt(i));return typeof t=="string"&&(this.dimensions<=0||e.length===this.dimensions)&&e.every(i=>!isNaN(i))}_(){return this.Ct(this.values)}map(t){return this.Ct(this.values.map(t))}u(t){return this.map(e=>t*e)}add(t){if(this.values.length!=t.values.length)throw new Error("Vectors of differing dimensionality");return this.Ct(this.values.map((e,i)=>e+t.values[i]))}W(t){if(this.values.length!=t.values.length)throw new Error("Vectors of differing dimensionality");return t.add(this.u(-1))}isEqual(t){return this.values.length===t.values.length&&this.values.every((e,i)=>z(e,t.values[i]))}get length(){return Math.sqrt(this.values.reduce((t,e)=>t+Math.pow(e,2),0))}get $t(){return Math.max(...this.values.map(Math.abs))}toString(){return this.values.join("_")}};W.dimensions=0;var g=class extends W{get x(){return this.values[0]}set x(t){this.values[0]=t}get y(){return this.values[1]}set y(t){this.values[1]=t}};g.dimensions=2;var m=class extends W{static angle(t,e){return new this(-t.sin*e.cos,e.sin,t.cos*e.cos)}Qe(t){return this.Ct([this.values[1]*t.values[2]-this.values[2]*t.values[1],this.values[2]*t.values[0]-this.values[0]*t.values[2],this.values[0]*t.values[1]-this.values[1]*t.values[0]])}Ze(t,e){let i=this._();return i[t]+=e,i}G(t){return this.x+=t,this}tt(t){return this.y+=t,this}et(t){return this.z+=t,this}get x(){return this.values[0]}set x(t){this.values[0]=t}get y(){return this.values[1]}set y(t){this.values[1]=t}get z(){return this.values[2]}set z(t){this.values[2]=t}};m.dimensions=3;var R=class{constructor(t,e){this.range=[0,1];this.start=t,this.end=e,this.M=t.W(e)}Ge(t,e){return this.range=[t,e],this}Kt(t){return t>=this.range[0]&&t<=this.range[1]}u(t){return this.start.add(this.M.u(t))}we(t){let e=[...Array(3).keys()].find((s,r)=>!z(this.M.values[r],0));if(typeof e!="number")return!1;let i=(t.values[e]-this.start.values[e])/this.M.values[e];return this.Kt(i)&&this.u(i).isEqual(t)}ti(t){let e=[...Array(3).keys()].find((r,n,h)=>n<h.length-1&&!z(this.M.values[n+1]*t.M.values[n],this.M.values[n]*t.M.values[n+1]));if(typeof e!="number")return!1;let i=(this.M.values[e]*(t.start.values[e+1]-this.start.values[e+1])-this.M.values[e+1]*(t.start.values[e]-this.start.values[e]))/(this.M.values[e+1]*t.M.values[e]-this.M.values[e]*t.M.values[e+1]),s=t.u(i);return t.Kt(i)&&this.we(s)?s:!1}Me(t){let e=t.kt(this.start.W(t.start))/t.kt(this.M);return this.Kt(e)?this.u(e):!1}ei(t){let e=this.Me(t.Ut);return e&&t.ii(e)?e:!1}},I=class{constructor(t,e,i){this.start=t,this.Ve=[e,i],this.Yt=this.Ve.map(t.W,t),this.xe=this.Yt[0].Qe(this.Yt[1])}kt(t){return this.xe.values.reduce((e,i,s)=>e+i*t.values[s],0)}si(t){return z(this.kt(t),this.kt(this.start))}},U=class{constructor(...t){if(t.length<3)throw new Error("Not enough vertices");this.Jt=t.map((e,i,s)=>new R(e,s[(i+1)%s.length])),this.Ut=new I(t[1],t[0],t[2]),this.h=t.reduce((e,i)=>e.add(i),t[0].u(0)).u(1/t.length)}ii(t){let e=new R(t,this.h);return e.range=[0,1/0],this.Ut.si(t)&&(this.Jt.some(i=>i.we(t))||!!this.Jt.reduce((i,s)=>s.ti(e)?i^1:i,0))}};var o=1024,P=class{constructor(t,e=o){this.it=[];this.position=t}get st(){return this.constructor.st}get rt(){return this.constructor.rt}get je(){return this.constructor.B}get q(){return this.constructor.q}};P.$=[[0,0,0],[1,0,0],[0,0,1],[1,0,1],[0,1,0],[1,1,0],[0,1,1],[1,1,1]],P.st=[],P.rt=[],P.B=[],P.q=!0;var E=class extends P{};E.st=[[0,1,2,3],[3,2,5,4],[4,5,6,7],[7,6,1,0],[7,0,3,4],[1,6,5,2]],E.rt=[[-1,"y"],[1,"x"],[1,"y"],[-1,"x"],[1,"z"],[-1,"z"]],E.B=Array(6).fill("rgb(0, 150, 255)"),E.q=!0;var M=class extends P{constructor(t,e=o){super(t);let i=t.x*e,s=t.y*e,r=t.z*e;this.it=[new m(i,s,r+e),new m(i,s,r),new m(i+e,s,r),new m(i+e,s,r+e),new m(i+e,s+e,r+e),new m(i+e,s+e,r),new m(i,s+e,r),new m(i,s+e,r+e)]}};M.st=[[0,1,2,3],[3,2,5,4],[4,5,6,7],[7,6,1,0],[7,0,3,4],[1,6,5,2]],M.rt=[[-1,"y"],[1,"x"],[1,"y"],[-1,"x"],[1,"z"],[-1,"z"]],M.B=Array(6).fill("#cc0066"),M.q=!0;var L=class extends M{};L.B=["rgb(107, 84, 40)","rgb(107, 84, 40)","#408000","rgb(107, 84, 40)","rgb(107, 84, 40)","rgb(107, 84, 40)"];var B=class extends M{};B.B=Array(6).fill("rgb(140, 140, 140)");var T=class extends M{};T.B=Array(6).fill("rgba(0, 0, 0, 0.15)"),T.q=!1;var q=class extends M{};q.B=Array(6).fill("#c4ac5c");var N=class extends M{};N.B=Array(6).fill("#a32929");var H=class extends M{};H.B=Array(6).fill("#1d161d");var D=[L,B,T,q,N,H];var at=class{constructor(t={yaw:0,pitch:0,x:0,y:at.g*o,z:0,yVelocity:0}){this.m=new j(t.yaw),this.pitch=new j(t.pitch),this.coords=new m(t.x,t.y,t.z),this.p=t.yVelocity}get J(){return{yaw:this.m.angle,pitch:this.pitch.angle,x:this.coords.x,y:this.coords.y,z:this.coords.z,yVelocity:this.p}}set t(t){this.m=t.m,this.pitch=t.pitch,this.coords=t.coords,this.p=t.p}},a=at;a.g=1.75,a.I=.125,a.V=1/8,a.Xt=3*o/1e3,a.Y=-12*o,a.ri=5*o,a.ni=5.25*o;var $=class extends a{constructor(e){var i;super(e);this.X=new E(this.coords.u(1/o)),this.name=(i=e.name)!=null?i:"Peer",this.Oe()}Oe(){let e=a.V*o;this.X.it=[new m(this.coords.x-e,this.coords.y-a.g*o,this.coords.z+e),new m(this.coords.x-e,this.coords.y-a.g*o,this.coords.z-e),new m(this.coords.x+e,this.coords.y-a.g*o,this.coords.z-e),new m(this.coords.x+e,this.coords.y-a.g*o,this.coords.z+e),new m(this.coords.x+e,this.coords.y+a.I*o,this.coords.z+e),new m(this.coords.x+e,this.coords.y+a.I*o,this.coords.z-e),new m(this.coords.x-e,this.coords.y+a.I*o,this.coords.z-e),new m(this.coords.x-e,this.coords.y+a.I*o,this.coords.z+e)],this.X.position=this.coords.u(1/o)}get J(){return{...super.J,name:this.name}}set t(e){super.t=e,this.Oe()}};var Y=class{constructor(t){this.model=t}};var J=class extends Y{constructor(e){super(e);this.nt=document.getElementById("info-modal");this.hi=this.nt.querySelector(".close");this.oi=document.getElementById("modal-cancel");this.ht=document.getElementById("modal-confirm");this.Qt=document.getElementById("modal-reset");this.It=document.getElementById("modal-text");this.ot=document.getElementById("modal-input");this.Mt=document.getElementById("modal-copy");this.Dt=document.getElementById("modal-settings");this.ai={number:this.nt.querySelector(".template.input"),boolean:this.nt.querySelector(".template.check")};this.Zt=document.querySelector("#modal-warning > span");this.mode="confirm";this.Z=()=>{};this.Pe=()=>{this.ht.classList.contains("disabled")||(this.mode==="confirm"?this.ct(!0):this.mode==="input"?this.ct(this.ot.value):this.mode==="settings"&&(this.Z(Object.fromEntries(this.Gt().map(([e,i])=>[e,i.type==="range"?parseFloat(i.value):i.checked]))),this.ht.classList.add("disabled")))};this.ve=e=>{e.key==="Escape"?this.ct(!1):e.key==="Enter"&&this.Pe()};for(let[i,s]of Object.entries(this.model.o.lt)){let r=this.ai[s.type].cloneNode(!0);if(r.childNodes[0].childNodes[0].textContent=s.name,r.childNodes[0].childNodes[1].textContent=s.At,s.type==="number"){let n=r.childNodes[1].childNodes[0];n.min=s.min.toString(),n.max=s.max.toString(),n.step=(s.round?1:.05).toString()}r.dataset.id=i,r.classList.remove("template"),this.Dt.appendChild(r)}this.hi.addEventListener("click",()=>this.ct(!1)),this.oi.addEventListener("click",()=>this.ct(!1)),this.Qt.addEventListener("click",()=>{this.model.o.reset(),this.model.Rt()}),window.addEventListener("click",i=>{i.target==this.nt&&this.ct(!1)}),[this.ot,...this.Gt().map(i=>i[1])].forEach(i=>{i.addEventListener("input",()=>this.ht.classList.remove("disabled"))}),this.ht.addEventListener("click",this.Pe),this.Mt.addEventListener("click",()=>{let i=this.It.textContent;i&&navigator.clipboard.writeText(i).then(()=>this.Vt()).catch(()=>{this.Mt.style.setProperty("background-image","linear-gradient(to right, red, red)","important"),setTimeout(()=>{this.Mt.style.backgroundImage=""},250)})})}Gt(){return[...this.Dt.querySelectorAll("div.setting[data-id]")].map(e=>[e.dataset.id,e.querySelector("input")])}ct(e){this.Z(e),this.Vt()}te(e,i,s,r,n){this.mode=e,this.Z=r,document.getElementById("modal-title").textContent=i,this.It.textContent=s,this.mode!="confirm"&&this.ht.classList.add("disabled"),n&&(this.Zt.textContent=n,this.Zt.parentElement.style.display="flex"),this.nt.style.display="flex",document.addEventListener("keydown",this.ve)}xt(e,i,s,r=!1,n){this.Vt(),r&&(this.Mt.style.display="block"),this.te("confirm",e,i,s,n)}ee(e,i,s,r){this.Vt(),this.ot.style.display="block",this.te("input",e,i,s,r),this.ot.focus()}Rt(e,i,s){this.Vt(),this.It.style.display="none";for(let[r,n]of this.Gt())n.type==="checkbox"?n.checked=e[r]:n.value=e[r],n.type==="range"&&(n.nextElementSibling.textContent=e[r]);this.Qt.style.display="block",this.Dt.style.display="block",this.te("settings","Settings","",i,s)}Vt(){this.nt.style.display="none",this.It.style.display="block",this.ot.style.display="none",this.ot.value="",this.Mt.style.display="none",this.Dt.style.display="none",this.Qt.style.display="none",this.ht.classList.remove("disabled"),this.Zt.parentElement.style.display="none",document.removeEventListener("keydown",this.ve)}};var X=class{constructor(t,e){this.width=16;this.height=9;this.D=this.width/2;this.A=this.height/2;this.h=new g(0,0);this.jt=60;this.Ot=3;this._e=10;this.R=0;this.Ee=[];this.$=[];this.model=t,this.L=e,this.model.li(this),this.Ce(this.model.o.ke),this.resize(16,9)}ci(){this.model.status==="running"&&this.start(),this.model.status==="paused"&&this.pause(),this.model.status==="menu"&&this.C()}Ie(){let t=new m(-this.D,this.A,this.model.o.P),e=new m(this.D,this.A,this.model.o.P),i=new m(this.D,-this.A,this.model.o.P),s=new m(-this.D,-this.A,this.model.o.P);this.Ee=[new I(m.wt(),t,e),new I(m.wt(),e,i),new I(m.wt(),i,s),new I(m.wt(),s,t)];let r=[[-1,1],[1,1],[1,-1],[-1,-1]].map(n=>new g(n[0]*this.D,n[1]*this.A));this.$=r.map((n,h)=>({K:n,e:new R(m.wt(),new m(n.x,n.y,this.model.o.P)).Ge(0,1/0),j:h}))}resize(t,e){this.width=t,this.height=e,this.D=t/2-this.R,this.A=e/2-this.R,this.Ie()}ui(){this.Ie(),this.De()}Tt(t,e=this.model.t.coords,i=this.model.t.m,s=this.model.t.pitch){let r=new m(t.x-e.x,t.y-e.y,t.z-e.z);return new m(r.x*i.cos+r.z*i.sin,r.x*i.sin*s.sin+r.y*s.cos-r.z*i.cos*s.sin,-r.x*i.sin*s.cos+r.y*s.sin+r.z*i.cos*s.cos)}mi(t){return t.x>-this.D&&t.x<this.D&&t.y>-this.A&&t.y<this.A}St(t,e=!1,i=!0){let s=e?t:this.Tt(t),r=this.model.o.P/s.z,n=new g(s.x*r,s.y*r);return i&&(r<0||!this.mi(n))?s:n}bi(t,e){return this.Ee.reduce((i,s,r)=>{let n=t.Me(s);if(n&&n.z>=0){let h=n.z/this.model.o.P;ot(Math.abs(n.x),h*this.D)&&ot(Math.abs(n.y),h*this.A)&&i.push({K:n,j:r,fi:e})}return i},[]).sort(({K:i},{K:s})=>i.W(t.start).length-s.W(t.start).length).map(({K:i,j:s,fi:r},n,h)=>({K:this.St(i,!0,!1),j:s,di:r||h.length%2===0&&n%2===1}))}yi(t,e){let i=t.map((r,n)=>({Lt:r,j:n})).filter(({Lt:r})=>!(r instanceof g));i.length&&!i[0].Lt.di&&i.unshift(i.pop());let s=[];return i.forEach(({Lt:r,j:n},h,c)=>{if(h%2)return;let l=c[h+1].Lt;if(r.j==l.j)return;let d=bt(this.$,(r.j+1)%this.$.length),y=[...Array(2)].map(()=>(d.reverse(),d.slice(0,[...Array(d.length).keys()].find(u=>l.j==d[u].j||(l.j+1)%this.$.length==d[u].j)+1))).find(u=>u.every(f=>e[f.j]));y&&s.push(...y.map(u=>({c:u.K,j:n+1})))}),s.reduce((r,{c:n,j:h},c)=>mt(r,h+c,n),t).map(r=>r instanceof g?r:r.K)}Ae(t,e,i){let s=t.map(l=>i[l]);if(s.every(l=>l instanceof g))return s;let r=s.map((l,d)=>l instanceof m?l:this.Tt(e[t[d]])),n=new U(...r),h=this.$.map(({e:l})=>!!l.ei(n)),c=s.map((l,d,y)=>{let u=y[(d+1)%y.length];if(l instanceof g&&u instanceof g)return[l];let f=new R(r[d],r[(d+1)%r.length]),p=l instanceof g?[l]:[];return p.push(...this.bi(f,l instanceof g)),p}).flat();return c.length?this.yi(c,h):h.every(Boolean)?this.$.map(({K:l})=>l):[]}pi(t){if(P.$.every(s=>this.Tt(this.model.Re(t.position.map((r,n)=>r+s[n]))).z<0))return[];let e=t.it.map(s=>this.St(s)),i=[];return t.st.filter((s,r)=>{let[n,h]=t.rt[r];if(t.q&&this.model.t.coords[h]*n<t.it[s[0]][h]*n)return!1;let c=this.model.O[t.position.Ze(h,n).toString()];return!(t instanceof E)&&c&&t.q===c.q?!1:(i.push(t.je[r]),!0)}).map((s,r)=>[this.Ae(s,t.it,e),i[r]]).filter(([s])=>s.length)}gi(t){let e=this.model.Pt(this.model.t.coords),i=[...Object.values(this.model.N)].map(r=>{let n=r.X.position._().G(Math.sign(this.model.t.coords.x/o-r.X.position.x)*a.V).et(Math.sign(this.model.t.coords.z/o-r.X.position.z)*a.V),h=Math.floor(n.y+a.I)-Math.floor(n.y-a.g)+1;return[Math.min(...[...Array(h)].map((l,d)=>e.W(n._().tt(d-a.g).map(Math.floor)).length)),r.X]}),s=this.model.ie();if(s&&s.k.y<0){s.k.values[s.axis]+=s.dir;let r=[s.k,s.k._().G(1),s.k._().G(1).et(1),s.k._().et(1)].map(this.model.Re);t(this.Ae([0,1,2,3],r,r.map(n=>this.St(n))),"transparent")}if(Object.keys(this.model.O).length>512){let r=new j(this.model.t.m.angle+Math.PI/2),n=new j(this.model.t.pitch.angle+Math.PI/2),h=m.angle(this.model.t.m,this.model.t.pitch),c=m.angle(r,new j(0)),l=m.angle(this.model.t.m,n),d=new j(this.model.t.m.angle-Math.floor((2*Math.PI+this.model.t.m.angle+Math.PI/4)%(2*Math.PI)/(Math.PI/2))*(Math.PI/2)),y=o/c.$t,u,f,p,w;Math.abs(this.model.t.pitch.angle)<=Math.PI/4?(u=d.cos*o*this.model.t.pitch.cos,f=o/l.$t,p=d.tan/this.model.t.pitch.cos*u/o,w=this.model.t.pitch.tan*u/o):(u=o/h.$t,f=d.cos*o*Math.abs(this.model.t.pitch.sin),p=-Math.sign(this.model.t.pitch.angle)*d.tan/Math.abs(this.model.t.pitch.sin)*f/o,w=Math.sign(this.model.t.pitch.angle)*Math.tan(Math.PI/2-Math.abs(this.model.t.pitch.angle))*f/o);let x=Math.ceil(this.model.o.se*o/u),C=this.D/this.model.o.P*x*u,O=this.A/this.model.o.P*x*u;for(let[k]of Array(x+2).entries()){let v=(x-k)*u,V=this.D/this.model.o.P*v+3*o,_=this.A/this.model.o.P*v+3*o;Math.abs(this.model.t.pitch.angle)<=Math.PI/4&&(V+=(y+(C+k*p*o-V)%y)%y,_+=(f+(O+k*w*o-_)%f)%f);let nt=this.model.t.coords.add(h.u(v)).add(l.u(_)).add(c.u(V)),F=Math.ceil(2*V/y)+1,S=Math.ceil(2*_/f)+1;for(let[ht]of Array(S).entries()){let K=nt.add(l.u(-ht*f));if(Math.abs(this.model.t.pitch.angle)>Math.PI/4&&(K=K.add(c.u((y+((Math.floor((O-_)/f)+ht)*p*o+C-V)%y)%y)).add(h.u((u+(Math.floor((O-_)/f)+ht)*w*o%u)%u)).add(l.u((f+(O-_)%f)%f))),K.y<0)break;for(let[wt]of Array(F).entries()){let Mt=K.add(c.u(-wt*y)),lt=this.model.Pt(Mt),ct=lt.W(e).length;if(ct>this.model.o.se)continue;let ut=this.model.O[lt.toString()];ut&&i.push([ct,ut])}}}}else i.push(...Object.values(this.model.O).map(r=>[e.W(r.position).length,r]));for(let[r,n]of i.sort((h,c)=>c[0]-h[0]))for(let[h,c]of this.pi(n))t(h,c)}wi(){let t=-this.model.t.pitch.tan*this.model.o.P;return[t,Math.max(Math.min(t,this.height/2),-this.height/2)]}Mi(t){let e=new j(-Math.PI/4),i=new j(-Math.PI/6),s=-i.cos,n=(e.sin-e.cos)*i.sin-s,h=n/2-Math.abs(s),c=this.Tt(t,new m(0,1,0),e,i);return new g(c.x/n*.8*this.jt,(c.y-h)/n*.8*this.jt)}Vi(t){let e=new t(new m(0,0,0),1),i=e.it.map(this.Mi,this);return e.st.map((s,r)=>[s.map(n=>i[n]),e.je[r]]).filter((s,r)=>{let[n,h]=e.rt[r];return!e.q||n<0&&["x","z"].includes(h)||n>0&&h==="y"})}};var A=class extends X{constructor(e){super(e,new J(e));this.re=document.getElementById("pause_screen");this.vt=document.getElementById("menu_screen");this.ut=this.vt.querySelector("#world_list");this.xi=this.vt.querySelector("#world_template");this.Te=document.getElementById("open_room");this.ji=document.getElementById("fps");this.Bt=1;this.qt=Array(this.Bt).fill(0);this.U=0;this.Pi=(e,i)=>{this.i.fillStyle=i,this.i.beginPath();let s=e[0];this.i.moveTo(Math.round(s.x+this.h.x),Math.round(this.h.y-s.y));for(let r of e.slice(1))this.i.lineTo(Math.round(r.x+this.h.x),Math.round(this.h.y-r.y));this.i.closePath(),this.i.fill(),this.i.stroke()};this.oe=e=>{let i=this.Oi(),s=(e-this.qt[0])/this.Bt;s<=0&&(this.Bt+=5),this.qt.length>=this.Bt&&this.qt.shift(),this.qt.push(e),this.ji.textContent=Math.round(1e3/s).toString(),this.model.status==="running"?(this.model.Ci(s),this.ne(),this.vi(),this._i()):i&&this.Le(),this.U=requestAnimationFrame(this.oe)};this.i=A.getContext("canvas"),this.ci()}Ce(e){let i=document.body.classList;e?i.add("dark"):i.remove("dark")}De(){this.model.status==="paused"&&this.ne()}transform(){this.i.resetTransform(),this.i.translate(0,.5),this.i.lineJoin="bevel"}static Se(e){let i=document.getElementById(e);if(!(i instanceof HTMLCanvasElement))throw new Error(`The element of id "${e}" is not a HTMLCanvasElement.`);return i}static getContext(e){let i=this.Se(e).getContext("2d");if(i===null)throw new Error("This browser does not support 2-dimensional canvas rendering contexts.");return i}Oi(){let e=this.i.canvas.clientWidth,i=this.i.canvas.clientHeight;return this.i.canvas.width!=e||this.i.canvas.height!=i?(this.i.canvas.width=e,this.i.canvas.height=i,this.h.x=e/2,this.h.y=i/2,this.resize(e,i),this.transform(),!0):!1}ne(){this.i.clearRect(0,0,this.width,this.height),this.i.lineWidth=.5,this.i.strokeStyle="#444";let[e,i]=this.wi(),s=this.i.createLinearGradient(0,this.h.y-e,0,0);s.addColorStop(0,"#b3bdc1"),s.addColorStop(1,"#80b7de"),this.i.fillStyle=s,this.h.y>e&&this.i.fillRect(0,0,this.width,this.h.y-i),s=this.i.createLinearGradient(0,this.h.y-e,0,this.height),s.addColorStop(0,"#578000"),s.addColorStop(Math.pow(.97,this.model.t.coords.y/o*a.g),"#408000"),this.i.fillStyle=s,e>-this.h.y&&this.i.fillRect(0,this.h.y-i,this.width,this.h.y+i),this.gi(this.Pi),this.i.font="20px Verdana",this.i.fillStyle="white",this.i.strokeStyle="black",this.i.textAlign="center";for(let r of Object.values(this.model.N))if(r.name){let n=this.St(r.coords._().tt(2*a.I*o));n instanceof g&&(this.i.fillText(r.name,this.h.x+n.x,this.h.y-n.y),this.i.strokeText(r.name,this.h.x+n.x,this.h.y-n.y))}this.R>0&&(this.i.beginPath(),this.i.moveTo(this.R,this.R),this.i.lineTo(this.width-this.R,this.R),this.i.lineTo(this.width-this.R,this.height-this.R),this.i.lineTo(this.R,this.height-this.R),this.i.closePath(),this.i.stroke())}vi(){let e=20,i=2;this.i.fillStyle="black",this.i.fillRect(this.h.x-i/2,this.h.y-e/2,i,e),this.i.fillRect(this.h.x-e/2,this.h.y-i/2,e,i)}_i(){let e=this.height-(this.jt+1.5*this.Ot)-this._e,i=this.jt+this.Ot,s=[0,e,0,e+i],r=this.i.createLinearGradient(...s);r.addColorStop(0,"#bbb"),r.addColorStop(1,"#a0a0a0");let n=this.i.createLinearGradient(...s);n.addColorStop(0,"#ccc"),n.addColorStop(1,"#b0b0b0"),this.i.resetTransform();for(let[h]of Array(10).entries()){let c=this.model.Nt[h];if(this.i.fillStyle=this.model.bt===h?n:r,this.i.lineWidth=this.Ot,this.i.strokeStyle="#848999",this.i.beginPath(),this.i.rect(this.h.x+(h-5)*i,e,i,i),this.i.fill(),this.i.stroke(),c){this.i.lineWidth=.5,this.i.strokeStyle="#444";for(let[l,d]of this.Vi(c)){this.i.fillStyle=d,this.i.beginPath();let y=l[0],u=new g(this.h.x+(h-4.5)*i,this.height-this.jt/2-this.Ot-this._e);this.i.moveTo(y.x+u.x,u.y-y.y);for(let f of l.slice(1))this.i.lineTo(f.x+u.x,u.y-f.y);this.i.closePath(),this.i.fill(),this.i.stroke()}}}this.i.lineWidth=this.Ot+2,this.i.strokeStyle="#e0dddd",this.i.strokeRect(this.h.x+(this.model.bt-5)*i,e,i,i),this.transform()}Le(){this.model.status==="paused"&&(this.ne(),this.re.classList.add("active"),this.vt.classList.remove("active"))}async Ei(){if(this.model.status==="menu"){this.ut.replaceChildren();for(let[e,i,s]of(await this.model.he()).sort((r,n)=>new Date(n[2]).getTime()-new Date(r[2]).getTime())){let r=this.xi.cloneNode(!0);r.childNodes[1].childNodes[0].textContent=i,r.childNodes[1].childNodes[1].textContent=new Date(s).toLocaleString([],{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),r.removeAttribute("id"),r.dataset.id=e.toString(),this.ut.appendChild(r)}if(!this.ut.childElementCount){let e=document.createElement("div");e.appendChild(document.createTextNode("No worlds yet...")),e.setAttribute("id","worlds_placeholder"),this.ut.appendChild(e)}this.re.classList.remove("active"),this.vt.classList.add("active")}}start(){this.U||(this.U=requestAnimationFrame(this.oe)),this.re.classList.remove("active"),this.vt.classList.remove("active")}pause(){this.U||(this.U=requestAnimationFrame(this.oe)),this.Le()}C(){this.U&&cancelAnimationFrame(this.U),this.U=0,this.Ei()}};var Q=class{constructor(t){this.ae=!1;this.model=t,this.model.ki(this)}init(){this.model.status==="running"&&this.start(),this.model.status==="paused"&&this.pause(),this.model.status==="menu"&&this.C()}};var Z=class extends Q{constructor(e){var s;super(e);this.ft={};this.Gi=0;this.canvas=A.Se("canvas");this.Ii=document.getElementById("menu_return");this.Te=document.getElementById("open_room");this.ut=document.getElementById("world_list");this.Di=document.getElementById("create_world");this.Be=document.getElementById("world_upload");this.le=document.getElementById("error_screen");this.qe=e=>{this.model.turn(e.movementX/100*this.model.o.ce,-e.movementY/100*this.model.o.ce)};this.Ne=e=>{e.button===0?this.model.Ti():e.button===2&&this.model.Si()};this.He=e=>{this.model.Fe(this.model.bt-Math.sign(e.deltaY))};this.Ht=e=>{e.type==="keyup"?(this.ft[e.code]&&delete this.ft[e.code],/^Digit[0-9]$/.test(e.code)&&this.model.Fe((10+parseInt(e.code[5])-1)%10)):(this.ft[e.code]||(this.ft[e.code]=!0),e.code==="Space"&&(this.ae=!0))};this.Ai(),this.init();let i=new URLSearchParams(window.location.search).keys().next().value;if(e.l&&i){this.le.style.display="flex";let r=n=>{n&&e.l?e.l.init("client",i,n.slice(0,16),h=>{var c;h instanceof Error&&((c=this.model.H)==null||c.L.xt("Room Error",h.message,()=>{})),this.le.style.display="none"}):this.le.style.display="none"};(s=this.model.H)==null||s.L.ee("Join Room","Choose a name:",r,"Your IP address will be shared with the host")}}Ri(){this.ae=!1;let e=["KeyA","KeyD","KeyS","KeyW"];return[["x",-1],["x",1],["z",-1],["z",1]].filter((s,r)=>this.ft[e[r]])}Ai(){var e,i,s,r,n;document.addEventListener("pointerlockchange",()=>{document.pointerLockElement&&this.model.status==="paused"?this.model.start():this.model.pause()},!1),(e=this.Ii)==null||e.addEventListener("click",()=>this.model.C()),(i=this.Te)==null||i.addEventListener("click",()=>{var h,c;if(this.model.l)if(this.model.l.isOpen)(h=this.model.H)==null||h.L.xt("Room URL",`https://0mds.github.io/project-cubes?${this.model.l.ue}`,()=>{},!0);else{let l=d=>{var y;d&&((y=this.model.l)==null||y.init("host","",d.slice(0,16),u=>{var f,p;u instanceof Error?(f=this.model.H)==null||f.L.xt("Room Error",u.message,()=>{}):(p=this.model.H)==null||p.L.xt("Room URL",`https://0mds.github.io/project-cubes?${u}`,()=>{},!0)}))};(c=this.model.H)==null||c.L.ee("Open Room","Choose a name:",l,"Your IP address will be shared with connecting peers, and consider backing up your world")}}),(s=this.Di)==null||s.addEventListener("click",()=>this.model.me()),(r=this.Be)==null||r.addEventListener("change",async()=>{var c;let h=(c=this.Be)==null?void 0:c.files;if(!(h.length<=0))for(let l of h)l.type==="application/json"&&this.model.be(JSON.parse(await l.text()))}),(n=this.ut)==null||n.addEventListener("click",async h=>{let c=h.target,l=c.closest(".world");if(c.tagName!=="A"&&l&&(c=l),c.classList.contains("world")&&c.dataset.id)this.model.Li(parseInt(c.dataset.id));else if(c.classList.contains("remove")&&l.dataset.id)this.model.fe(parseInt(l.dataset.id));else if(c.classList.contains("export")&&l.dataset.id){let d=await this.model.de(parseInt(l.dataset.id)),y=new Blob([JSON.stringify(d)],{type:"application/json"}),u=URL.createObjectURL(y),f=document.createElement("a");f.href=u,f.download=`[ProjectCubes] ${d.name.replace(/[\/\\:*?"<>]/g,"")}.json`,f.style.display="none",document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(u)}else c.classList.contains("rename")&&l.dataset.id&&this.model.ye(parseInt(l.dataset.id))}),document.querySelectorAll(".settings").forEach(h=>h.addEventListener("click",this.model.Rt))}start(){document.addEventListener("mousemove",this.qe,!1),document.addEventListener("mousedown",this.Ne,!1),document.addEventListener("wheel",this.He,!1),this.canvas.addEventListener("keyup",this.Ht),this.canvas.addEventListener("keydown",this.Ht),this.canvas.removeEventListener("click",this.canvas.requestPointerLock)}pause(){this.ft={},document.removeEventListener("mousemove",this.qe,!1),document.removeEventListener("mousedown",this.Ne,!1),document.removeEventListener("wheel",this.He,!1),this.canvas.removeEventListener("keyup",this.Ht),this.canvas.removeEventListener("keydown",this.Ht),this.canvas.addEventListener("click",this.canvas.requestPointerLock)}C(){this.canvas.removeEventListener("click",this.canvas.requestPointerLock)}};var G=class{};var tt=class extends G{constructor(){super();this.ready=new Promise((e,i)=>{let s=indexedDB.open("WorldsDB");s.onerror=r=>{console.error(`IndexedDB error: ${s.error}`,r),i(s.error)},s.onsuccess=r=>{this.db=r.target.result,e()},s.onupgradeneeded=r=>{this.db=r.target.result,this.db.onerror=h=>{console.error(`Database error: ${h.target.errorCode}`)},this.db.createObjectStore("worlds",{keyPath:"id",autoIncrement:!0});let n=this.db.createObjectStore("settings",{autoIncrement:!1});n.transaction.oncomplete=()=>{let h=this.db.transaction("settings","readwrite").objectStore("settings").add({},1);h.onerror=()=>i(h.error),h.onsuccess=()=>e()}}})}async he(){return new Promise((e,i)=>{let s=this.db.transaction("worlds").objectStore("worlds").getAll();s.onerror=()=>i(s.error),s.onsuccess=()=>e(s.result.map(r=>[r.id,r.name,r.lastPlayed]))})}async ze(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds").objectStore("worlds").get(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i([r.result.pos,r.result.yVelocity,r.result.yaw,r.result.pitch,Object.entries(r.result.objects)])})}async pe(e,i,s,r,n){let h=this.db.transaction("worlds","readwrite").objectStore("worlds");h.get(e).onsuccess=c=>{let l=c.target.result;l.lastPlayed=new Date().toISOString(),l.pos=i.toString(),l.yVelocity=s,l.yaw=r.angle,l.pitch=n.angle,h.put(l)}}async Bi(e,i,s){let r=this.db.transaction("worlds","readwrite").objectStore("worlds");r.get(e).onsuccess=n=>{let h=n.target.result;h.objects[i.toString()]=D.indexOf(s),r.put(h)}}async qi(e,i){let s=this.db.transaction("worlds","readwrite").objectStore("worlds");s.get(e).onsuccess=r=>{let n=r.target.result;delete n.objects[i.toString()],s.put(n)}}async me(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").add({name:"New World",lastPlayed:new Date().toISOString(),pos:e.toString(),yVelocity:0,yaw:0,pitch:0,objects:{}});r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async fe(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").delete(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async ye(e,i){return new Promise((s,r)=>{let n=this.db.transaction("worlds","readwrite").objectStore("worlds"),h=n.get(e);h.onerror=()=>r(h.error),h.onsuccess=c=>{let l=c.target.result;l.name=i.slice(0,69);let d=n.put(l);d.onerror=()=>r(d.error),d.onsuccess=()=>s()}})}async de(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds").objectStore("worlds").get(e);r.onerror=()=>s(r.error),r.onsuccess=()=>{delete r.result.id,i(r.result)}})}async be(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").add(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async Ni(e){let i=this.db.transaction("settings","readwrite").objectStore("settings");i.get(1).onsuccess=s=>{let r=s.target.result;for(let[n,h]of Object.entries(e))r[n]=h;i.put(r,1)}}async getSettings(){return new Promise((e,i)=>{let s=this.db.transaction("settings").objectStore("settings").get(1);s.onerror=()=>i(s.error),s.onsuccess=()=>e(s.result)})}};var yt=Peer;var et=class{constructor(t){this.Ft="0";this.F={};this.name="";this.Et=!1;this.dt=[];this.zt=(t,e)=>{var i;if(this.$i(t))if(this.type==="host"&&this.We(t,e),t.type==="init"&&this.type==="client")this.Ft=t.idInRoom,delete t.players[this.Ft],this.model.$e(new a(t.player),t.objects,Object.fromEntries(Object.entries(t.players).map(([s,r])=>[s,new $(r)]))),this.send(this._t,{type:"rename",origin:this.Ft,name:this.name}),this.Z(this.id);else if(t.type==="player_join")this.model.N[t.id]=new $(t.player);else if(t.type==="player_leave")delete this.model.N[t.id];else if(t.type==="update"){if(t.player&&(this.model.N[t.origin].t=new a(t.player)),t.objects)for(let[s,r]of t.objects)r>=0?this.model.Ke(m.parse(s),(i=D[r])!=null?i:M):this.model.Ue(m.parse(s))}else t.type==="rename"&&(this.model.N[t.origin].name=t.name.slice(0,16))};this.model=t}init(t,e,i,s){this.type=t,this.F={},this._t=void 0,this.Et=!1,this.name=i,t==="host"&&s?(this.Hi(),s(this.id),this.ue=this.id):e&&(this.Z=s,this._t=this.connect(e),this.ue=e)}Fi(){this.model.status!=="menu"&&(this.model.pause(),this.model.C())}async zi(t){if(Object.keys(this.F).length>=16)return this.reject(t);let e=Object.keys(this.F),i=e.length?parseInt(e[e.length-1])+1:1,s=new a;this.zt({type:"player_join",id:i.toString(),player:s.J}),this.F[i]=t;let r=this.model.t.J;r.name=this.name,this.send(t,{type:"init",idInRoom:i.toString(),player:s.J,objects:(await this.model.db.ze(this.model.T))[4],players:{0:r,...Object.fromEntries(Object.entries(this.model.N).map(([n,h])=>[n,h.J]))}})}Wi(t){let e=Object.keys(this.F)[Object.values(this.F).indexOf(t)];delete this.F[e],this.zt({type:"player_leave",id:e})}$i(t){return!!t&&typeof t=="object"&&(t.type==="init"&&typeof t.idInRoom=="string"&&typeof t.player=="object"&&typeof t.objects=="object"&&typeof t.players=="object"||t.type==="player_join"&&typeof t.id=="string"&&typeof t.player=="object"||t.type==="player_leave"&&typeof t.id=="string"||t.type==="update"&&typeof t.origin=="string"&&(!("player"in t)||typeof t.player=="object")&&(!("objects"in t)||typeof t.objects=="object")||t.type==="rename"&&typeof t.origin=="string"&&typeof t.name=="string")}We(t,e){for(let i of Object.values(this.F))i!==e&&this.send(i,t)}Ki(){if(!this.Et&&!this.dt.length)return;let t={type:"update",origin:this.Ft};this.Et&&(t.player=this.model.t.J),this.dt.length&&(t.objects=this.dt),this.Et=!1,this.dt=[],this.type==="host"?this.We(t):this.send(this._t,t)}};var it=class extends et{init(e,i,s,r){this.disconnect(),this.v=new yt,this.v.on("open",()=>super.init(e,i,s,r)),this.v.on("close",this.Fi,this),this.v.on("error",n=>{this.disconnect(),r(n)})}get isOpen(){return this.v&&this.v.open}get isActive(){return this.isOpen&&(!!this._t||Object.keys(this.F).length>0)}get id(){return this.v.id}Hi(){this.v.on("connection",e=>{e.on("open",()=>this.zi(e)),e.on("data",i=>this.zt(i,e)),e.on("close",()=>this.Wi(e))}),this.v.on("disconnected",()=>{this.isOpen&&this.v.reconnect()})}reject(e){e.close()}connect(e){var i=this.v.connect(e);return i.on("data",this.zt),i.on("close",this.disconnect,this),i.on("error",s=>{this.disconnect(),this.Z(s)}),i}disconnect(){this.v&&this.v.destroy()}send(e,i){e.send(i)}};var st=class{constructor(t){this.ce=0;this.se=0;this.ke=!1;this.Ui=0;this.P=0;this.lt={ce:{name:"Sensitivity",At:"Mouse sensitivity when looking around",type:"number",min:.1,max:10,round:!1,default:1},se:{name:"Render Distance",At:"Distance in which objects are visible (in worlds with more than 512 cubes)",type:"number",min:10,max:30,round:!0,default:18,Wt:()=>this.model.views.forEach(t=>t.De())},ke:{name:"Dark Mode",At:"Like night and day",type:"boolean",default:!1,Wt:t=>this.model.views.forEach(e=>e.Ce(t))},Ui:{name:"FOV",At:"Field of view of character",type:"number",min:30,max:60,round:!0,default:45,Wt:t=>{this.P=(1-t/100)*o,this.model.views.forEach(e=>e.ui())}}};this.Yi=Object.fromEntries(Object.entries(this.lt).map(([t,e])=>[e.name,t]));this.set=(t,e=!0)=>{if(!t)return;let i=!1;for(let[s,r]of Object.entries(t)){let n=this.lt[s];if(n&&typeof r===n.type){if(this[s]===r)continue;if(n.type==="number")if((!n.min||r>=n.min)&&(!n.max||r<=n.max))this[s]=n.round?Math.ceil(r):r;else continue;else this[s]=r;i=!0,n.Wt&&n.Wt(r)}}e&&i&&this.model.db.Ni(Object.fromEntries(Object.entries(this.get()).map(([s,r])=>[this.lt[s].name,r])))};this.model=t,this.reset(!1)}reset(t=!0){this.set(Object.fromEntries(Object.entries(this.lt).map(([e,i])=>[e,i.default])),t)}get(){return Object.fromEntries(Object.keys(this.lt).map(t=>[t,this[t]]))}};var rt=class{constructor(t){this.t=new a;this.N={};this.Nt=[L,B,q,N,T,H];this.bt=0;this.O={};this.status="menu";this.views=[];this.yt=[];this.T=-1;this.o=new st(this);this.Rt=()=>{var t;(t=this.H)==null||t.L.Rt(this.o.get(),this.o.set)};this.Ye=t=>{let e=t.x%o/o-Math.sign(t.x)*.5,i=t.z%o/o-Math.sign(t.z)*.5,s=[this.Pt(t)];return Math.abs(e)>.5-a.V&&s.push(s[0]._().G(Math.sign(e))),Math.abs(i)>.5-a.V&&s.push(s[0]._().et(Math.sign(i))),Math.abs(e)>.5-a.V&&Math.abs(i)>.5-a.V&&s.push(s[0]._().G(Math.sign(e)).et(Math.sign(i))),s};this.db=t,this.db.getSettings().then(e=>this.o.set(Object.fromEntries(Object.entries(e).map(([i,s])=>[this.o.Yi[i],s])),!1))}Ji(t){this.l=t}get H(){if(this.views.length)return this.views[0]}async he(){return await this.db.he()}$e(t,e,i={}){var s;this.t=t,this.N=i;for(let[r,n]of e)this.O[r]=new((s=D[n])!=null?s:M)(m.parse(r));this.pause()}async Li(t){this.T=t;let[e,i,s,r,n]=await this.db.ze(t),h=m.parse(e);this.$e(new a({yaw:s,pitch:r,x:h.x,y:h.y,z:h.z,yVelocity:i}),n)}Xi(){this.T=-1,this.O={},this.l&&this.l.disconnect()}async me(){await this.db.me(new m(0,a.g*o,0)),this.views.forEach(t=>t.C())}async fe(t){var i;let e=async s=>{s&&(await this.db.fe(t),this.views.forEach(r=>r.C()))};(i=this.H)==null||i.L.xt("Delete World","Are you sure you want to delete this world?",e)}async ye(t){var i;let e=async s=>{s&&(await this.db.ye(t,s.toString()),this.views.forEach(r=>r.C()))};(i=this.H)==null||i.L.ee("Rename World","New name:",e)}de(t){return this.db.de(t)}async be(t){try{if(!dt(Object.keys(t),["name","lastPlayed","pos","yVelocity","yaw","pitch","objects"]))throw new Error("Corrupt File");if(!(typeof t.name=="string"&&t.name.length>0&&t.name.length<=69))throw new Error("Invalid name");if(!(typeof t.lastPlayed=="string"&&t.lastPlayed.length===24&&(e=>!isNaN(e)&&e.toISOString()===t.lastPlayed)(new Date(t.lastPlayed))))throw new Error("Invalid lastPlayed");if(!(m.ge(t.pos)&&parseInt(t.pos.split("_")[1])>=a.g*o))throw new Error("Invalid pos");if(typeof t.yVelocity!="number")throw new Error("Invalid yVelocity");if(!(typeof t.yaw=="number"&&t.yaw<=2*Math.PI&&t.yaw>=-2*Math.PI))throw new Error("Invalid yaw");if(!(typeof t.pitch=="number"&&t.pitch<=Math.PI/2&&t.pitch>=-Math.PI/2))throw new Error("Invalid pitch");if(!(typeof t.objects=="object"&&Object.keys(t.objects).every(e=>m.ge(e))&&Object.values(t.objects).every(e=>typeof e=="number"&&e===Math.floor(e)&&e>=0&&e<D.length)))throw new Error("Invalid objects");await this.db.be(t),this.views.forEach(e=>e.C())}catch(e){console.error(`Import Error: ${e}`)}}li(t){this.views.push(t)}ki(t){this.yt.push(t)}Ci(t){this.move(t),this.l&&this.l.isActive&&this.l.Ki()}start(){this.status!=="running"&&(this.status="running",this.yt.forEach(t=>t.start()),this.views.forEach(t=>t.start()))}pause(){this.status!=="paused"&&(this.T>=0&&this.db.pe(this.T,this.t.coords,this.t.p,this.t.m,this.t.pitch),this.status="paused",this.yt.forEach(t=>t.pause()),this.views.forEach(t=>t.pause()))}C(){this.status==="paused"&&(this.status="menu",this.Xi(),this.yt.forEach(t=>t.C()),this.views.forEach(t=>t.C()))}Re(t){return t.map(e=>e*o)}Pt(t){return t.map(e=>Math.floor(e/o))}gt(t){let e=t.y-a.g*o;return this.t.p<=0&&e%o===0&&(e===0||this.Ye(new m(t.x,e,t.z)).some(i=>this.O[i.tt(-1).toString()]))}Je(t,e,i,s,r){if(this.gt(new m(s,this.t.coords.y,r)))return this.t.coords.y;let n=(i-t)*e/1e3;return Math.round(this.t.coords.y+.5*a.Y*Math.pow(n,2)+this.t.p*n)}Xe(t,e,i,s,r){let n;if(this.gt(new m(s,this.t.coords.y,r)))n=[s,r].map((h,c)=>((1+Math.sign(i.values[2*c])*a.V)%1*o-(o+h)%o)/i.values[2*c]);else{let h=(Math.floor(this.t.coords.y/o+a.I)+1)*o,c=Math.floor((this.t.coords.y-1)/o-a.g)*o,l=Math.sqrt(Math.pow(this.t.p/a.Y,2)-2*(this.t.coords.y+a.I*o-h)/a.Y);(isNaN(l)||this.t.p<0)&&(l=Math.sqrt(Math.pow(this.t.p/a.Y,2)-2*(this.t.coords.y-a.g*o-c)/a.Y)),n=[-1,1].map(d=>1e3*(-this.t.p/a.Y+d*l)/e)}return{axis:1,S:Math.min(...n.filter(h=>h>=0))+t}}Qi(t){return isNaN(t)?1/0:t}move(t){let e=this.t.coords._(),i=this.yt.some(u=>u.ae),[s,r]=this.yt.map(u=>u.Ri()).flat().reduce(([u,f],[p,w])=>p==="x"?[u+w,f]:[u,f+w],[0,0]);t=o*Math.min(1/Math.sqrt(Math.pow(s,2)+Math.pow(r,2)),t*a.Xt/o)/a.Xt;let n=t*a.Xt,h=new m(s*this.t.m.cos-r*this.t.m.sin,0,s*this.t.m.sin+r*this.t.m.cos).map(u=>~~(u*n));i&&this.gt(this.t.coords)&&(this.t.p=a.ni);let c=this.t.coords.x+h.values[0],l=this.t.coords.z+h.values[2],d=0,y=[0,2].map(u=>({axis:u,S:this.Qi(((Math.sign(this.t.coords.values[u])-Math.sign(h.values[u])*a.V)%1*o-this.t.coords.values[u]%o)/h.values[u])}));for(y.push(this.Xe(d,t,h,this.t.coords.x,this.t.coords.z)),y.sort(({S:u},{S:f})=>u-f);y.length&&y[0].S<=1;){let{axis:u,S:f}=y.shift();if(f<0)continue;let p=c===this.t.coords.x+h.values[0]?this.t.coords.x+f*h.values[0]:c,w=l===this.t.coords.z+h.values[2]?this.t.coords.z+f*h.values[2]:l,x=this.Je(d,t,f,p,w);if(u!=1){let C=u===0?w:p,O=C%o/o-Math.sign(C)*.5,k=Math.floor(x/o+a.I)-Math.floor(x/o-a.g)+1,v=this.Pt(new m(C,x-a.g*o,this.t.coords.values[u])).tt(-1).et(Math.sign(h.values[u])),V=v._().G(Math.sign(O)),_=[v];Math.abs(O)>.5-a.V&&_.push(V),[...Array(k)].some((nt,F)=>_.some(S=>this.O[u==0?`${S.z}_${S.y+F+1}_${S.x}`:S.tt(1).toString()]))?u==0?c=p:l=w:Math.abs(O)===.5-a.V&&Math.sign(O)*h.values[2-u]>0&&[...Array(k)].some((nt,F)=>this.O[u==0?`${V.z}_${V.y+F+1}_${V.x}`:V.tt(1).toString()])&&(u==2?c=p:l=w)}else{let C=this.t.p<0&&this.gt(new m(p,x,w)),O=this.t.p>0&&this.Ye(new m(p,x+a.I*o,w)).some(v=>this.O[v.toString()]),k=this.t.p===0&&!this.gt(new m(p,x,w));(C||O||k)&&(d=f,this.t.p=0,this.t.coords.y=x,y.push(this.Xe(d,t,h,p,w)),y.sort(({S:v},{S:V})=>v-V))}}this.t.coords.x=c,this.t.coords.z=l,this.t.coords.y=this.Je(d,t,1,this.t.coords.x,this.t.coords.z),this.gt(this.t.coords)||(this.t.p+=a.Y*(1-d)*t/1e3),!e.isEqual(this.t.coords)&&this.l&&this.l.isActive&&(this.l.Et=!0)}turn(t,e){this.t.m.set((this.t.m.angle-t)%(2*Math.PI)),this.t.pitch.set(Math.max(Math.min(this.t.pitch.angle+e,1/2*Math.PI),-1/2*Math.PI))}ie(){let t=m.angle(this.t.m,this.t.pitch).u(a.ri);return[0,1,2].map(e=>{let i=(o-Math.sign(t.values[e])*(this.t.coords.values[e]%o))%o/Math.abs(t.values[e]),s=Math.floor((1-i)*Math.abs(t.values[e])/o);return i<=1?[...Array(s+1)].map((r,n)=>({axis:e,S:i+n*o/Math.abs(t.values[e])})):[]}).flat().sort(({S:e},{S:i})=>e-i).map(({axis:e,S:i})=>({k:this.Pt(this.t.coords.add(t.u(i)).map(Math.round)).map((s,r)=>r==e&&t.values[r]<0?s-1:s),axis:e,dir:-Math.sign(t.values[e])})).find(({k:e})=>e.y<0||this.O[e.toString()])}Fe(t){t>=0&&t<this.Nt.length&&(this.bt=Math.floor(t))}Zi(t,e){return!(t.coords.x<=(e.x-a.V)*o||t.coords.x>=(e.x+1+a.V)*o||t.coords.z<=(e.z-a.V)*o||t.coords.z>=(e.z+1+a.V)*o||t.coords.y<=(e.y-a.I)*o||t.coords.y>=(e.y+1+a.g)*o)}Ue(t){this.O[t.toString()]&&(delete this.O[t.toString()],this.T>=0&&(this.db.qi(this.T,t),this.db.pe(this.T,this.t.coords,this.t.p,this.t.m,this.t.pitch)))}Ti(){let t=this.ie();t&&(this.Ue(t.k),this.l&&this.l.isActive&&this.l.dt.push([t.k.toString(),-1]))}Ke(t,e){this.O[t.toString()]||(this.O[t.toString()]=new e(t),this.T>=0&&(this.db.Bi(this.T,t,e),this.db.pe(this.T,this.t.coords,this.t.p,this.t.m,this.t.pitch)))}Si(){let t=this.ie();if(t){t.k.values[t.axis]+=t.dir;let e=t.k;[this.t,...Object.values(this.N)].some(i=>this.Zi(i,e))||(this.Ke(t.k,this.Nt[this.bt]),this.l&&this.l.isActive&&this.l.dt.push([e.toString(),D.indexOf(this.Nt[this.bt])]))}}};var pt=document.getElementById("error_screen"),gt=new tt;gt.ready.then(()=>{let b=new rt(gt);b.Ji(new it(b)),new A(b),new Z(b)}).catch(b=>{console.error(b),pt.querySelector("div").textContent="IDB Error: Please try deactivating private browsing or updating your browser",pt.style.display="flex"});})();
