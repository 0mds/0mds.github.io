//! Copyright 2023 0mds
"use strict";(()=>{var x=class{constructor(t){this.angle=0;this.sin=0;this.cos=1;this.tan=0;this.set(t)}set(t){this.angle=t,this.sin=Math.sin(t),this.cos=Math.cos(t),this.tan=Math.tan(t)}};function mt(b,t,e){return t<b.length?b.reduce((i,s,r)=>(r!=t?i.push(s):i.push(e,s),i),[]):[...b,e]}function bt(b,t){let e=b.slice(t,b.length);return e.push(...b.slice(0,t)),e}var ft=1e-5;function dt(b,t){return b===t?!0:b==null||t==null||b.length!==t.length?!1:(b=[...b].sort(),t=[...t].sort(),b.every((e,i)=>e===t[i]))}function z(b,t){return Math.abs(b-t)<ft}function ot(b,t){return b<=t+ft}var K=class{constructor(...t){let e=this.constructor.dimensions;if(e>0&&t.length!=e)throw new Error("Invalid number of dimensions");this.values=t}Ct(t){return new this.constructor(...t)}static parse(t){return new this(...t.split("_").map(e=>parseInt(e)))}static Mt(t=0){return new this(...Array(this.dimensions||t).fill(0))}static we(t){let e=t.split("_").map(i=>parseInt(i));return typeof t=="string"&&(this.dimensions<=0||e.length===this.dimensions)&&e.every(i=>!isNaN(i))}P(){return this.Ct(this.values)}map(t){return this.Ct(this.values.map(t))}u(t){return this.map(e=>t*e)}add(t){if(this.values.length!=t.values.length)throw new Error("Vectors of differing dimensionality");return this.Ct(this.values.map((e,i)=>e+t.values[i]))}W(t){if(this.values.length!=t.values.length)throw new Error("Vectors of differing dimensionality");return t.add(this.u(-1))}isEqual(t){return this.values.length===t.values.length&&this.values.every((e,i)=>z(e,t.values[i]))}get length(){return Math.sqrt(this.values.reduce((t,e)=>t+Math.pow(e,2),0))}get Wt(){return Math.max(...this.values.map(Math.abs))}toString(){return this.values.join("_")}};K.dimensions=0;var g=class extends K{get x(){return this.values[0]}set x(t){this.values[0]=t}get y(){return this.values[1]}set y(t){this.values[1]=t}};g.dimensions=2;var m=class extends K{static angle(t,e){return new this(-t.sin*e.cos,e.sin,t.cos*e.cos)}Ze(t){return this.Ct([this.values[1]*t.values[2]-this.values[2]*t.values[1],this.values[2]*t.values[0]-this.values[0]*t.values[2],this.values[0]*t.values[1]-this.values[1]*t.values[0]])}Ge(t,e){let i=this.P();return i[t]+=e,i}$(t){return this.x+=t,this}X(t){return this.y+=t,this}Z(t){return this.z+=t,this}get x(){return this.values[0]}set x(t){this.values[0]=t}get y(){return this.values[1]}set y(t){this.values[1]=t}get z(){return this.values[2]}set z(t){this.values[2]=t}};m.dimensions=3;var T=class{constructor(t,e){this.range=[0,1];this.start=t,this.end=e,this.V=t.W(e)}ti(t,e){return this.range=[t,e],this}$t(t){return t>=this.range[0]&&t<=this.range[1]}u(t){return this.start.add(this.V.u(t))}Me(t){let e=[...Array(3).keys()].find((s,r)=>!z(this.V.values[r],0));if(typeof e!="number")return!1;let i=(t.values[e]-this.start.values[e])/this.V.values[e];return this.$t(i)&&this.u(i).isEqual(t)}ei(t){let e=[...Array(3).keys()].find((r,n,h)=>n<h.length-1&&!z(this.V.values[n+1]*t.V.values[n],this.V.values[n]*t.V.values[n+1]));if(typeof e!="number")return!1;let i=(this.V.values[e]*(t.start.values[e+1]-this.start.values[e+1])-this.V.values[e+1]*(t.start.values[e]-this.start.values[e]))/(this.V.values[e+1]*t.V.values[e]-this.V.values[e]*t.V.values[e+1]),s=t.u(i);return t.$t(i)&&this.Me(s)?s:!1}Ve(t){let e=t.kt(this.start.W(t.start))/t.kt(this.V);return this.$t(e)?this.u(e):!1}ii(t){let e=this.Ve(t.Ut);return e&&t.si(e)?e:!1}},I=class{constructor(t,e,i){this.start=t,this.xe=[e,i],this.Yt=this.xe.map(t.W,t),this.je=this.Yt[0].Ze(this.Yt[1])}kt(t){return this.je.values.reduce((e,i,s)=>e+i*t.values[s],0)}ri(t){return z(this.kt(t),this.kt(this.start))}},U=class{constructor(...t){if(t.length<3)throw new Error("Not enough vertices");this.Jt=t.map((e,i,s)=>new T(e,s[(i+1)%s.length])),this.Ut=new I(t[1],t[0],t[2]),this.h=t.reduce((e,i)=>e.add(i),t[0].u(0)).u(1/t.length)}si(t){let e=new T(t,this.h);return e.range=[0,1/0],this.Ut.ri(t)&&(this.Jt.some(i=>i.Me(t))||!!this.Jt.reduce((i,s)=>s.ei(e)?i^1:i,0))}};var o=1024,P=class{constructor(t,e=o){this.it=[];this.position=t}get st(){return this.constructor.st}get rt(){return this.constructor.rt}get Oe(){return this.constructor.B}get q(){return this.constructor.q}};P.U=[[0,0,0],[1,0,0],[0,0,1],[1,0,1],[0,1,0],[1,1,0],[0,1,1],[1,1,1]],P.st=[],P.rt=[],P.B=[],P.q=!0;var E=class extends P{};E.st=[[0,1,2,3],[3,2,5,4],[4,5,6,7],[7,6,1,0],[7,0,3,4],[1,6,5,2]],E.rt=[[-1,"y"],[1,"x"],[1,"y"],[-1,"x"],[1,"z"],[-1,"z"]],E.B=Array(6).fill("rgb(0, 150, 255)"),E.q=!0;var M=class extends P{constructor(t,e=o){super(t);let i=t.x*e,s=t.y*e,r=t.z*e;this.it=[new m(i,s,r+e),new m(i,s,r),new m(i+e,s,r),new m(i+e,s,r+e),new m(i+e,s+e,r+e),new m(i+e,s+e,r),new m(i,s+e,r),new m(i,s+e,r+e)]}};M.st=[[0,1,2,3],[3,2,5,4],[4,5,6,7],[7,6,1,0],[7,0,3,4],[1,6,5,2]],M.rt=[[-1,"y"],[1,"x"],[1,"y"],[-1,"x"],[1,"z"],[-1,"z"]],M.B=Array(6).fill("#cc0066"),M.q=!0;var L=class extends M{};L.B=["rgb(107, 84, 40)","rgb(107, 84, 40)","#408000","rgb(107, 84, 40)","rgb(107, 84, 40)","rgb(107, 84, 40)"];var B=class extends M{};B.B=Array(6).fill("rgb(140, 140, 140)");var R=class extends M{};R.B=Array(6).fill("rgba(0, 0, 0, 0.15)"),R.q=!1;var q=class extends M{};q.B=Array(6).fill("#c4ac5c");var N=class extends M{};N.B=Array(6).fill("#a32929");var H=class extends M{};H.B=Array(6).fill("#1d161d");var D=[L,B,R,q,N,H];var at=class{constructor(t={yaw:0,pitch:0,x:0,y:at.g*o,z:0,yVelocity:0}){this.m=new x(t.yaw),this.pitch=new x(t.pitch),this.coords=new m(t.x,t.y,t.z),this.p=t.yVelocity}get tt(){return{yaw:this.m.angle,pitch:this.pitch.angle,x:this.coords.x,y:this.coords.y,z:this.coords.z,yVelocity:this.p}}set t(t){this.m=t.m,this.pitch=t.pitch,this.coords=t.coords,this.p=t.p}},a=at;a.g=1.75,a.I=.125,a.j=1/8,a.Xt=3*o/1e3,a.G=-12*o,a.ni=5*o,a.hi=5.25*o;var W=class extends a{constructor(e){var i;super(e);this.N=new E(this.coords.u(1/o)),this.name=(i=e.name)!=null?i:"Peer",this.Pe()}Pe(){let e=a.j*o;this.N.it=[new m(this.coords.x-e,this.coords.y-a.g*o,this.coords.z+e),new m(this.coords.x-e,this.coords.y-a.g*o,this.coords.z-e),new m(this.coords.x+e,this.coords.y-a.g*o,this.coords.z-e),new m(this.coords.x+e,this.coords.y-a.g*o,this.coords.z+e),new m(this.coords.x+e,this.coords.y+a.I*o,this.coords.z+e),new m(this.coords.x+e,this.coords.y+a.I*o,this.coords.z-e),new m(this.coords.x-e,this.coords.y+a.I*o,this.coords.z-e),new m(this.coords.x-e,this.coords.y+a.I*o,this.coords.z+e)],this.N.position=this.coords.u(1/o)}get tt(){return{...super.tt,name:this.name}}set t(e){super.t=e,this.Pe()}};var Y=class{constructor(t){this.model=t}};var J=class extends Y{constructor(e){super(e);this.nt=document.getElementById("info-modal");this.oi=this.nt.querySelector(".close");this.ai=document.getElementById("modal-cancel");this.ht=document.getElementById("modal-confirm");this.Qt=document.getElementById("modal-reset");this.It=document.getElementById("modal-text");this.ot=document.getElementById("modal-input");this.Vt=document.getElementById("modal-copy");this.Dt=document.getElementById("modal-settings");this.li={number:this.nt.querySelector(".template.input"),boolean:this.nt.querySelector(".template.check")};this.Zt=document.querySelector("#modal-warning > span");this.mode="confirm";this.et=()=>{};this.ve=()=>{this.ht.classList.contains("disabled")||(this.mode==="confirm"?this.ct(!0):this.mode==="input"?this.ct(this.ot.value):this.mode==="settings"&&(this.et(Object.fromEntries(this.Gt().map(([e,i])=>[e,i.type==="range"?parseFloat(i.value):i.checked]))),this.ht.classList.add("disabled")))};this._e=e=>{e.key==="Escape"?this.ct(!1):e.key==="Enter"&&this.ve()};for(let[i,s]of Object.entries(this.model.o.lt)){let r=this.li[s.type].cloneNode(!0);if(r.childNodes[0].childNodes[0].textContent=s.name,r.childNodes[0].childNodes[1].textContent=s.At,s.type==="number"){let n=r.childNodes[1].childNodes[0];n.min=s.min.toString(),n.max=s.max.toString(),n.step=(s.round?1:.05).toString()}r.dataset.id=i,r.classList.remove("template"),this.Dt.appendChild(r)}this.oi.addEventListener("click",()=>this.ct(!1)),this.ai.addEventListener("click",()=>this.ct(!1)),this.Qt.addEventListener("click",()=>{this.model.o.reset(),this.model.Tt()}),window.addEventListener("click",i=>{i.target==this.nt&&this.ct(!1)}),[this.ot,...this.Gt().map(i=>i[1])].forEach(i=>{i.addEventListener("input",()=>this.ht.classList.remove("disabled"))}),this.ht.addEventListener("click",this.ve),this.Vt.addEventListener("click",()=>{let i=this.It.textContent;i&&navigator.clipboard.writeText(i).then(()=>this.xt()).catch(()=>{this.Vt.style.setProperty("background-image","linear-gradient(to right, red, red)","important"),setTimeout(()=>{this.Vt.style.backgroundImage=""},250)})})}Gt(){return[...this.Dt.querySelectorAll("div.setting[data-id]")].map(e=>[e.dataset.id,e.querySelector("input")])}ct(e){this.et(e),this.xt()}te(e,i,s,r,n){this.mode=e,this.et=r,document.getElementById("modal-title").textContent=i,this.It.textContent=s,this.mode!="confirm"&&this.ht.classList.add("disabled"),n&&(this.Zt.textContent=n,this.Zt.parentElement.style.display="flex"),this.nt.style.display="flex",document.addEventListener("keydown",this._e)}jt(e,i,s,r=!1,n){this.xt(),r&&(this.Vt.style.display="block"),this.te("confirm",e,i,s,n)}ee(e,i,s,r){this.xt(),this.ot.style.display="block",this.te("input",e,i,s,r),this.ot.focus()}Tt(e,i,s){this.xt(),this.It.style.display="none";for(let[r,n]of this.Gt())n.type==="checkbox"?n.checked=e[r]:n.value=e[r],n.type==="range"&&(n.nextElementSibling.textContent=e[r]);this.Qt.style.display="block",this.Dt.style.display="block",this.te("settings","Settings","",i,s)}xt(){this.nt.style.display="none",this.It.style.display="block",this.ot.style.display="none",this.ot.value="",this.Vt.style.display="none",this.Dt.style.display="none",this.Qt.style.display="none",this.ht.classList.remove("disabled"),this.Zt.parentElement.style.display="none",document.removeEventListener("keydown",this._e)}};var X=class{constructor(t,e){this.width=16;this.height=9;this.D=this.width/2;this.A=this.height/2;this.h=new g(0,0);this.Ot=60;this.Pt=3;this.Ee=10;this.T=0;this.Ce=[];this.U=[];this.model=t,this.L=e,this.model.ci(this),this.ke(this.model.o.Ie),this.resize(16,9)}ui(){this.model.status==="running"&&this.start(),this.model.status==="paused"&&this.pause(),this.model.status==="menu"&&this.C()}De(){let t=new m(-this.D,this.A,this.model.o.v),e=new m(this.D,this.A,this.model.o.v),i=new m(this.D,-this.A,this.model.o.v),s=new m(-this.D,-this.A,this.model.o.v);this.Ce=[new I(m.Mt(),t,e),new I(m.Mt(),e,i),new I(m.Mt(),i,s),new I(m.Mt(),s,t)];let r=[[-1,1],[1,1],[1,-1],[-1,-1]].map(n=>new g(n[0]*this.D,n[1]*this.A));this.U=r.map((n,h)=>({Y:n,e:new T(m.Mt(),new m(n.x,n.y,this.model.o.v)).ti(0,1/0),O:h}))}resize(t,e){this.width=t,this.height=e,this.D=t/2-this.T,this.A=e/2-this.T,this.De()}mi(){this.De(),this.Ae()}Rt(t,e=this.model.t.coords,i=this.model.t.m,s=this.model.t.pitch){let r=new m(t.x-e.x,t.y-e.y,t.z-e.z);return new m(r.x*i.cos+r.z*i.sin,r.x*i.sin*s.sin+r.y*s.cos-r.z*i.cos*s.sin,-r.x*i.sin*s.cos+r.y*s.sin+r.z*i.cos*s.cos)}bi(t){return t.x>-this.D&&t.x<this.D&&t.y>-this.A&&t.y<this.A}St(t,e=!1,i=!0){let s=e?t:this.Rt(t),r=this.model.o.v/s.z,n=new g(s.x*r,s.y*r);return i&&(r<0||!this.bi(n))?s:n}fi(t,e){return this.Ce.reduce((i,s,r)=>{let n=t.Ve(s);if(n&&n.z>=0){let h=n.z/this.model.o.v;ot(Math.abs(n.x),h*this.D)&&ot(Math.abs(n.y),h*this.A)&&i.push({Y:n,O:r,di:e})}return i},[]).sort(({Y:i},{Y:s})=>i.W(t.start).length-s.W(t.start).length).map(({Y:i,O:s,di:r},n,h)=>({Y:this.St(i,!0,!1),O:s,yi:r||h.length%2===0&&n%2===1}))}pi(t,e){let i=t.map((r,n)=>({Lt:r,O:n})).filter(({Lt:r})=>!(r instanceof g));i.length&&!i[0].Lt.yi&&i.unshift(i.pop());let s=[];return i.forEach(({Lt:r,O:n},h,c)=>{if(h%2)return;let l=c[h+1].Lt;if(r.O==l.O)return;let d=bt(this.U,(r.O+1)%this.U.length),y=[...Array(2)].map(()=>(d.reverse(),d.slice(0,[...Array(d.length).keys()].find(u=>l.O==d[u].O||(l.O+1)%this.U.length==d[u].O)+1))).find(u=>u.every(f=>e[f.O]));y&&s.push(...y.map(u=>({c:u.Y,O:n+1})))}),s.reduce((r,{c:n,O:h},c)=>mt(r,h+c,n),t).map(r=>r instanceof g?r:r.Y)}Te(t,e,i){let s=t.map(l=>i[l]);if(s.every(l=>l instanceof g))return s;let r=s.map((l,d)=>l instanceof m?l:this.Rt(e[t[d]])),n=new U(...r),h=this.U.map(({e:l})=>!!l.ii(n)),c=s.map((l,d,y)=>{let u=y[(d+1)%y.length];if(l instanceof g&&u instanceof g)return[l];let f=new T(r[d],r[(d+1)%r.length]),p=l instanceof g?[l]:[];return p.push(...this.fi(f,l instanceof g)),p}).flat();return c.length?this.pi(c,h):h.every(Boolean)?this.U.map(({Y:l})=>l):[]}gi(t){if(P.U.every(s=>this.Rt(this.model.Re(t.position.map((r,n)=>r+s[n]))).z<0))return[];let e=t.it.map(s=>this.St(s)),i=[];return t.st.filter((s,r)=>{let[n,h]=t.rt[r];if(t.q&&this.model.t.coords[h]*n<t.it[s[0]][h]*n)return!1;let c=this.model.M[t.position.Ge(h,n).toString()];return!(t instanceof E)&&c&&t.q===c.q?!1:(i.push(t.Oe[r]),!0)}).map((s,r)=>[this.Te(s,t.it,e),i[r]]).filter(([s])=>s.length)}wi(t){let e=this.model.ut(this.model.t.coords),i=[...Object.values(this.model.H)].map(r=>{let n=r.N.position.y-a.g<=this.model.t.coords.y/o&&r.N.position.y+a.I>=this.model.t.coords.y/o?1:-1,h=r.N.position.P().$(n*Math.sign(this.model.t.coords.x/o-r.N.position.x)*a.j).Z(n*Math.sign(this.model.t.coords.z/o-r.N.position.z)*a.j);return[Math.min(...[...Array(this.model.ie(h.y))].map((l,d)=>e.W(h.P().X(d-a.g).map(Math.floor)).length)),r.N]}),s=this.model.se();if(s&&s.k.y<0){s.k.values[s.axis]+=s.dir;let r=[s.k,s.k.P().$(1),s.k.P().$(1).Z(1),s.k.P().Z(1)].map(this.model.Re);t(this.Te([0,1,2,3],r,r.map(n=>this.St(n))),"transparent")}if(Object.keys(this.model.M).length>512){let r=new x(this.model.t.m.angle+Math.PI/2),n=new x(this.model.t.pitch.angle+Math.PI/2),h=m.angle(this.model.t.m,this.model.t.pitch),c=m.angle(r,new x(0)),l=m.angle(this.model.t.m,n),d=new x(this.model.t.m.angle-Math.floor((2*Math.PI+this.model.t.m.angle+Math.PI/4)%(2*Math.PI)/(Math.PI/2))*(Math.PI/2)),y=o/c.Wt,u,f,p,w;Math.abs(this.model.t.pitch.angle)<=Math.PI/4?(u=d.cos*o*this.model.t.pitch.cos,f=o/l.Wt,p=d.tan/this.model.t.pitch.cos*u/o,w=this.model.t.pitch.tan*u/o):(u=o/h.Wt,f=d.cos*o*Math.abs(this.model.t.pitch.sin),p=-Math.sign(this.model.t.pitch.angle)*d.tan/Math.abs(this.model.t.pitch.sin)*f/o,w=Math.sign(this.model.t.pitch.angle)*Math.tan(Math.PI/2-Math.abs(this.model.t.pitch.angle))*f/o);let j=Math.ceil(this.model.o.re*o/u),C=this.D/this.model.o.v*j*u,O=this.A/this.model.o.v*j*u;for(let[k]of Array(j+2).entries()){let v=(j-k)*u,V=this.D/this.model.o.v*v+3*o,_=this.A/this.model.o.v*v+3*o;Math.abs(this.model.t.pitch.angle)<=Math.PI/4&&(V+=(y+(C+k*p*o-V)%y)%y,_+=(f+(O+k*w*o-_)%f)%f);let nt=this.model.t.coords.add(h.u(v)).add(l.u(_)).add(c.u(V)),F=Math.ceil(2*V/y)+1,S=Math.ceil(2*_/f)+1;for(let[ht]of Array(S).entries()){let $=nt.add(l.u(-ht*f));if(Math.abs(this.model.t.pitch.angle)>Math.PI/4&&($=$.add(c.u((y+((Math.floor((O-_)/f)+ht)*p*o+C-V)%y)%y)).add(h.u((u+(Math.floor((O-_)/f)+ht)*w*o%u)%u)).add(l.u((f+(O-_)%f)%f))),$.y<0)break;for(let[wt]of Array(F).entries()){let Mt=$.add(c.u(-wt*y)),lt=this.model.ut(Mt),ct=lt.W(e).length;if(ct>this.model.o.re)continue;let ut=this.model.M[lt.toString()];ut&&i.push([ct,ut])}}}}else i.push(...Object.values(this.model.M).map(r=>[e.W(r.position).length,r]));for(let[r,n]of i.sort((h,c)=>c[0]-h[0]))for(let[h,c]of this.gi(n))t(h,c)}Mi(){let t=-this.model.t.pitch.tan*this.model.o.v;return[t,Math.max(Math.min(t,this.height/2),-this.height/2)]}Vi(t){let e=new x(-Math.PI/4),i=new x(-Math.PI/6),s=-i.cos,n=(e.sin-e.cos)*i.sin-s,h=n/2-Math.abs(s),c=this.Rt(t,new m(0,1,0),e,i);return new g(c.x/n*.8*this.Ot,(c.y-h)/n*.8*this.Ot)}xi(t){let e=new t(new m(0,0,0),1),i=e.it.map(this.Vi,this);return e.st.map((s,r)=>[s.map(n=>i[n]),e.Oe[r]]).filter((s,r)=>{let[n,h]=e.rt[r];return!e.q||n<0&&["x","z"].includes(h)||n>0&&h==="y"})}};var A=class extends X{constructor(e){super(e,new J(e));this.ne=document.getElementById("pause_screen");this.vt=document.getElementById("menu_screen");this.bt=this.vt.querySelector("#world_list");this.ji=this.vt.querySelector("#world_template");this.Se=document.getElementById("open_room");this.Oi=document.getElementById("fps");this.Bt=1;this.qt=Array(this.Bt).fill(0);this.J=0;this.vi=(e,i)=>{this.i.fillStyle=i,this.i.beginPath();let s=e[0];this.i.moveTo(Math.round(s.x+this.h.x),Math.round(this.h.y-s.y));for(let r of e.slice(1))this.i.lineTo(Math.round(r.x+this.h.x),Math.round(this.h.y-r.y));this.i.closePath(),this.i.fill(),this.i.stroke()};this.ae=e=>{let i=this.Pi(),s=(e-this.qt[0])/this.Bt;s<=0&&(this.Bt+=5),this.qt.length>=this.Bt&&this.qt.shift(),this.qt.push(e),this.Oi.textContent=Math.round(1e3/s).toString(),this.model.status==="running"?(this.model.ki(s),this.he(),this._i(),this.Ei()):i&&this.Be(),this.J=requestAnimationFrame(this.ae)};this.i=A.getContext("canvas"),this.ui()}ke(e){let i=document.body.classList;e?i.add("dark"):i.remove("dark")}Ae(){this.model.status==="paused"&&this.he()}transform(){this.i.resetTransform(),this.i.translate(0,.5),this.i.lineJoin="bevel"}static Le(e){let i=document.getElementById(e);if(!(i instanceof HTMLCanvasElement))throw new Error(`The element of id "${e}" is not a HTMLCanvasElement.`);return i}static getContext(e){let i=this.Le(e).getContext("2d");if(i===null)throw new Error("This browser does not support 2-dimensional canvas rendering contexts.");return i}Pi(){let e=this.i.canvas.clientWidth,i=this.i.canvas.clientHeight;return this.i.canvas.width!=e||this.i.canvas.height!=i?(this.i.canvas.width=e,this.i.canvas.height=i,this.h.x=e/2,this.h.y=i/2,this.resize(e,i),this.transform(),!0):!1}he(){this.i.clearRect(0,0,this.width,this.height),this.i.lineWidth=.5,this.i.strokeStyle="#444";let[e,i]=this.Mi(),s=this.i.createLinearGradient(0,this.h.y-e,0,0);s.addColorStop(0,"#b3bdc1"),s.addColorStop(1,"#80b7de"),this.i.fillStyle=s,this.h.y>e&&this.i.fillRect(0,0,this.width,this.h.y-i),s=this.i.createLinearGradient(0,this.h.y-e,0,this.height),s.addColorStop(0,"#578000"),s.addColorStop(Math.pow(.97,this.model.t.coords.y/o*a.g),"#408000"),this.i.fillStyle=s,e>-this.h.y&&this.i.fillRect(0,this.h.y-i,this.width,this.h.y+i),this.wi(this.vi),this.i.font="20px Verdana",this.i.fillStyle="white",this.i.strokeStyle="black",this.i.textAlign="center";for(let r of Object.values(this.model.H))if(r.name){let n=this.St(r.coords.P().X(2*a.I*o));n instanceof g&&(this.i.fillText(r.name,this.h.x+n.x,this.h.y-n.y),this.i.strokeText(r.name,this.h.x+n.x,this.h.y-n.y))}this.T>0&&(this.i.beginPath(),this.i.moveTo(this.T,this.T),this.i.lineTo(this.width-this.T,this.T),this.i.lineTo(this.width-this.T,this.height-this.T),this.i.lineTo(this.T,this.height-this.T),this.i.closePath(),this.i.stroke())}_i(){let e=20,i=2;this.i.fillStyle="black",this.i.fillRect(this.h.x-i/2,this.h.y-e/2,i,e),this.i.fillRect(this.h.x-e/2,this.h.y-i/2,e,i)}Ei(){let e=this.height-(this.Ot+1.5*this.Pt)-this.Ee,i=this.Ot+this.Pt,s=[0,e,0,e+i],r=this.i.createLinearGradient(...s);r.addColorStop(0,"#bbb"),r.addColorStop(1,"#a0a0a0");let n=this.i.createLinearGradient(...s);n.addColorStop(0,"#ccc"),n.addColorStop(1,"#b0b0b0"),this.i.resetTransform();for(let[h]of Array(10).entries()){let c=this.model.Nt[h];if(this.i.fillStyle=this.model.ft===h?n:r,this.i.lineWidth=this.Pt,this.i.strokeStyle="#848999",this.i.beginPath(),this.i.rect(this.h.x+(h-5)*i,e,i,i),this.i.fill(),this.i.stroke(),c){this.i.lineWidth=.5,this.i.strokeStyle="#444";for(let[l,d]of this.xi(c)){this.i.fillStyle=d,this.i.beginPath();let y=l[0],u=new g(this.h.x+(h-4.5)*i,this.height-this.Ot/2-this.Pt-this.Ee);this.i.moveTo(y.x+u.x,u.y-y.y);for(let f of l.slice(1))this.i.lineTo(f.x+u.x,u.y-f.y);this.i.closePath(),this.i.fill(),this.i.stroke()}}}this.i.lineWidth=this.Pt+2,this.i.strokeStyle="#e0dddd",this.i.strokeRect(this.h.x+(this.model.ft-5)*i,e,i,i),this.transform()}Be(){this.model.status==="paused"&&(this.he(),this.ne.classList.add("active"),this.vt.classList.remove("active"))}async Ci(){if(this.model.status==="menu"){this.bt.replaceChildren();for(let[e,i,s]of(await this.model.oe()).sort((r,n)=>new Date(n[2]).getTime()-new Date(r[2]).getTime())){let r=this.ji.cloneNode(!0);r.childNodes[1].childNodes[0].textContent=i,r.childNodes[1].childNodes[1].textContent=new Date(s).toLocaleString([],{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),r.removeAttribute("id"),r.dataset.id=e.toString(),this.bt.appendChild(r)}if(!this.bt.childElementCount){let e=document.createElement("div");e.appendChild(document.createTextNode("No worlds yet...")),e.setAttribute("id","worlds_placeholder"),this.bt.appendChild(e)}this.ne.classList.remove("active"),this.vt.classList.add("active")}}start(){this.J||(this.J=requestAnimationFrame(this.ae)),this.ne.classList.remove("active"),this.vt.classList.remove("active")}pause(){this.J||(this.J=requestAnimationFrame(this.ae)),this.Be()}C(){this.J&&cancelAnimationFrame(this.J),this.J=0,this.Ci()}};var Q=class{constructor(t){this.le=!1;this.model=t,this.model.Ii(this)}init(){this.model.status==="running"&&this.start(),this.model.status==="paused"&&this.pause(),this.model.status==="menu"&&this.C()}};var Z=class extends Q{constructor(e){var s;super(e);this.dt={};this.ts=0;this.canvas=A.Le("canvas");this.Di=document.getElementById("menu_return");this.Se=document.getElementById("open_room");this.bt=document.getElementById("world_list");this.Ai=document.getElementById("create_world");this.qe=document.getElementById("world_upload");this.ce=document.getElementById("error_screen");this.Ne=e=>{this.model.turn(e.movementX/100*this.model.o.ue,-e.movementY/100*this.model.o.ue)};this.He=e=>{e.button===0?this.model.Si():e.button===2&&this.model.Li()};this.Fe=e=>{this.model.ze(this.model.ft+Math.sign(e.deltaY))};this.Ht=e=>{e.type==="keyup"?(this.dt[e.code]&&delete this.dt[e.code],/^Digit[0-9]$/.test(e.code)&&this.model.ze((10+parseInt(e.code[5])-1)%10)):(this.dt[e.code]||(this.dt[e.code]=!0),e.code==="Space"&&(this.le=!0))};this.Ti(),this.init();let i=new URLSearchParams(window.location.search).keys().next().value;if(e.l&&i){this.ce.style.display="flex";let r=n=>{n&&e.l?e.l.init("client",i,n.slice(0,16),h=>{var c;h instanceof Error&&((c=this.model.F)==null||c.L.jt("Room Error",h.message,()=>{})),this.ce.style.display="none"}):this.ce.style.display="none"};(s=this.model.F)==null||s.L.ee("Join Room","Choose a name:",r,"Your IP address will be shared with the host")}}Ri(){this.le=!1;let e=["KeyA","KeyD","KeyS","KeyW"];return[["x",-1],["x",1],["z",-1],["z",1]].filter((s,r)=>this.dt[e[r]])}Ti(){var e,i,s,r,n;document.addEventListener("pointerlockchange",()=>{document.pointerLockElement&&this.model.status==="paused"?this.model.start():this.model.pause()},!1),(e=this.Di)==null||e.addEventListener("click",()=>this.model.C()),(i=this.Se)==null||i.addEventListener("click",()=>{var h,c;if(this.model.l)if(this.model.l.isOpen)(h=this.model.F)==null||h.L.jt("Room URL",`https://0mds.github.io/project-cubes?${this.model.l.me}`,()=>{},!0);else{let l=d=>{var y;d&&((y=this.model.l)==null||y.init("host","",d.slice(0,16),u=>{var f,p;u instanceof Error?(f=this.model.F)==null||f.L.jt("Room Error",u.message,()=>{}):(p=this.model.F)==null||p.L.jt("Room URL",`https://0mds.github.io/project-cubes?${u}`,()=>{},!0)}))};(c=this.model.F)==null||c.L.ee("Open Room","Choose a name:",l,"Your IP address will be shared with connecting peers, and consider backing up your world")}}),(s=this.Ai)==null||s.addEventListener("click",()=>this.model.be()),(r=this.qe)==null||r.addEventListener("change",async()=>{var c;let h=(c=this.qe)==null?void 0:c.files;if(!(h.length<=0))for(let l of h)l.type==="application/json"&&this.model.fe(JSON.parse(await l.text()))}),(n=this.bt)==null||n.addEventListener("click",async h=>{let c=h.target,l=c.closest(".world");if(c.tagName!=="A"&&l&&(c=l),c.classList.contains("world")&&c.dataset.id)this.model.Bi(parseInt(c.dataset.id));else if(c.classList.contains("remove")&&l.dataset.id)this.model.de(parseInt(l.dataset.id));else if(c.classList.contains("export")&&l.dataset.id){let d=await this.model.ye(parseInt(l.dataset.id)),y=new Blob([JSON.stringify(d)],{type:"application/json"}),u=URL.createObjectURL(y),f=document.createElement("a");f.href=u,f.download=`[ProjectCubes] ${d.name.replace(/[\/\\:*?"<>]/g,"")}.json`,f.style.display="none",document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(u)}else c.classList.contains("rename")&&l.dataset.id&&this.model.pe(parseInt(l.dataset.id))}),document.querySelectorAll(".settings").forEach(h=>h.addEventListener("click",this.model.Tt))}start(){document.addEventListener("mousemove",this.Ne,!1),document.addEventListener("mousedown",this.He,!1),document.addEventListener("wheel",this.Fe,!1),this.canvas.addEventListener("keyup",this.Ht),this.canvas.addEventListener("keydown",this.Ht),this.canvas.removeEventListener("click",this.canvas.requestPointerLock)}pause(){this.dt={},document.removeEventListener("mousemove",this.Ne,!1),document.removeEventListener("mousedown",this.He,!1),document.removeEventListener("wheel",this.Fe,!1),this.canvas.removeEventListener("keyup",this.Ht),this.canvas.removeEventListener("keydown",this.Ht),this.canvas.addEventListener("click",this.canvas.requestPointerLock)}C(){this.canvas.removeEventListener("click",this.canvas.requestPointerLock)}};var G=class{};var tt=class extends G{constructor(){super();this.ready=new Promise((e,i)=>{let s=indexedDB.open("WorldsDB");s.onerror=r=>{console.error(`IndexedDB error: ${s.error}`,r),i(s.error)},s.onsuccess=r=>{this.db=r.target.result,e()},s.onupgradeneeded=r=>{this.db=r.target.result,this.db.onerror=h=>{console.error(`Database error: ${h.target.errorCode}`)},this.db.createObjectStore("worlds",{keyPath:"id",autoIncrement:!0});let n=this.db.createObjectStore("settings",{autoIncrement:!1});n.transaction.oncomplete=()=>{let h=this.db.transaction("settings","readwrite").objectStore("settings").add({},1);h.onerror=()=>i(h.error),h.onsuccess=()=>e()}}})}async oe(){return new Promise((e,i)=>{let s=this.db.transaction("worlds").objectStore("worlds").getAll();s.onerror=()=>i(s.error),s.onsuccess=()=>e(s.result.map(r=>[r.id,r.name,r.lastPlayed]))})}async Ke(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds").objectStore("worlds").get(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i([r.result.pos,r.result.yVelocity,r.result.yaw,r.result.pitch,Object.entries(r.result.objects)])})}async ge(e,i,s,r,n){let h=this.db.transaction("worlds","readwrite").objectStore("worlds");h.get(e).onsuccess=c=>{let l=c.target.result;l.lastPlayed=new Date().toISOString(),l.pos=i.toString(),l.yVelocity=s,l.yaw=r.angle,l.pitch=n.angle,h.put(l)}}async qi(e,i,s){let r=this.db.transaction("worlds","readwrite").objectStore("worlds");r.get(e).onsuccess=n=>{let h=n.target.result;h.objects[i.toString()]=D.indexOf(s),r.put(h)}}async Ni(e,i){let s=this.db.transaction("worlds","readwrite").objectStore("worlds");s.get(e).onsuccess=r=>{let n=r.target.result;delete n.objects[i.toString()],s.put(n)}}async be(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").add({name:"New World",lastPlayed:new Date().toISOString(),pos:e.toString(),yVelocity:0,yaw:0,pitch:0,objects:{}});r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async de(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").delete(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async pe(e,i){return new Promise((s,r)=>{let n=this.db.transaction("worlds","readwrite").objectStore("worlds"),h=n.get(e);h.onerror=()=>r(h.error),h.onsuccess=c=>{let l=c.target.result;l.name=i.slice(0,69);let d=n.put(l);d.onerror=()=>r(d.error),d.onsuccess=()=>s()}})}async ye(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds").objectStore("worlds").get(e);r.onerror=()=>s(r.error),r.onsuccess=()=>{delete r.result.id,i(r.result)}})}async fe(e){return new Promise((i,s)=>{let r=this.db.transaction("worlds","readwrite").objectStore("worlds").add(e);r.onerror=()=>s(r.error),r.onsuccess=()=>i()})}async Hi(e){let i=this.db.transaction("settings","readwrite").objectStore("settings");i.get(1).onsuccess=s=>{let r=s.target.result;for(let[n,h]of Object.entries(e))r[n]=h;i.put(r,1)}}async getSettings(){return new Promise((e,i)=>{let s=this.db.transaction("settings").objectStore("settings").get(1);s.onerror=()=>i(s.error),s.onsuccess=()=>e(s.result)})}};var yt=Peer;var et=class{constructor(t){this.Ft="0";this.K={};this.name="";this.Et=!1;this.yt=[];this.zt=(t,e)=>{var i;if(this.$i(t))if(this.type==="host"&&this.We(t,e),t.type==="init"&&this.type==="client")this.Ft=t.idInRoom,delete t.players[this.Ft],this.model.$e(new a(t.player),t.objects,Object.fromEntries(Object.entries(t.players).map(([s,r])=>[s,new W(r)]))),this.send(this._t,{type:"rename",origin:this.Ft,name:this.name}),this.et(this.id);else if(t.type==="player_join")this.model.H[t.id]=new W(t.player);else if(t.type==="player_leave")delete this.model.H[t.id];else if(t.type==="update"){if(t.player&&(this.model.H[t.origin].t=new a(t.player)),t.objects)for(let[s,r]of t.objects)r>=0?this.model.Ue(m.parse(s),(i=D[r])!=null?i:M):this.model.Ye(m.parse(s))}else t.type==="rename"&&(this.model.H[t.origin].name=t.name.slice(0,16))};this.model=t}init(t,e,i,s){this.type=t,this.K={},this._t=void 0,this.Et=!1,this.name=i,t==="host"&&s?(this.Fi(),s(this.id),this.me=this.id):e&&(this.et=s,this._t=this.connect(e),this.me=e)}zi(){this.model.status!=="menu"&&(this.model.pause(),this.model.C())}async Ki(t){if(Object.keys(this.K).length>=16)return this.reject(t);let e=Object.keys(this.K),i=e.length?parseInt(e[e.length-1])+1:1,s=new a;for(s.coords.$(.5*o).Z(.5*o);[...Array(this.model.ie(s.coords.y/o))].some((r,n)=>this.model.M[this.model.ut(s.coords.P().X((n-a.g)*o)).toString()]);)s.coords.$(o);this.zt({type:"player_join",id:i.toString(),player:s.tt}),this.K[i]=t,this.send(t,{type:"init",idInRoom:i.toString(),player:s.tt,objects:(await this.model.db.Ke(this.model.R))[4],players:{0:{name:this.name,...this.model.t.tt},...Object.fromEntries(Object.entries(this.model.H).map(([r,n])=>[r,n.tt]))}})}Wi(t){let e=Object.keys(this.K)[Object.values(this.K).indexOf(t)];delete this.K[e],this.zt({type:"player_leave",id:e})}$i(t){return!!t&&typeof t=="object"&&(t.type==="init"&&typeof t.idInRoom=="string"&&typeof t.player=="object"&&typeof t.objects=="object"&&typeof t.players=="object"||t.type==="player_join"&&typeof t.id=="string"&&typeof t.player=="object"||t.type==="player_leave"&&typeof t.id=="string"||t.type==="update"&&typeof t.origin=="string"&&(!("player"in t)||typeof t.player=="object")&&(!("objects"in t)||typeof t.objects=="object")||t.type==="rename"&&typeof t.origin=="string"&&typeof t.name=="string")}We(t,e){for(let i of Object.values(this.K))i!==e&&this.send(i,t)}Ui(){if(!this.Et&&!this.yt.length)return;let t={type:"update",origin:this.Ft};this.Et&&(t.player=this.model.t.tt),this.yt.length&&(t.objects=this.yt),this.Et=!1,this.yt=[],this.type==="host"?this.We(t):this.send(this._t,t)}};var it=class extends et{init(e,i,s,r){this.disconnect(),this._=new yt,this._.on("open",()=>super.init(e,i,s,r)),this._.on("close",this.zi,this),this._.on("error",n=>{this.disconnect(),r(n)})}get isOpen(){return this._&&this._.open}get isActive(){return this.isOpen&&(!!this._t||Object.keys(this.K).length>0)}get id(){return this._.id}Fi(){this._.on("connection",e=>{e.on("open",()=>this.Ki(e)),e.on("data",i=>this.zt(i,e)),e.on("close",()=>this.Wi(e))}),this._.on("disconnected",()=>{this.isOpen&&this._.reconnect()})}reject(e){e.close()}connect(e){var i=this._.connect(e);return i.on("data",this.zt),i.on("close",this.disconnect,this),i.on("error",s=>{this.disconnect(),this.et(s)}),i}disconnect(){this._&&this._.destroy()}send(e,i){e.send(i)}};var st=class{constructor(t){this.ue=0;this.re=0;this.Ie=!1;this.Yi=0;this.v=0;this.lt={ue:{name:"Sensitivity",At:"Mouse sensitivity when looking around",type:"number",min:.1,max:10,round:!1,default:1},re:{name:"Render Distance",At:"Distance in which objects are visible (in worlds with more than 512 cubes)",type:"number",min:10,max:30,round:!0,default:18,Kt:()=>this.model.views.forEach(t=>t.Ae())},Ie:{name:"Dark Mode",At:"Like night and day",type:"boolean",default:!1,Kt:t=>this.model.views.forEach(e=>e.ke(t))},Yi:{name:"FOV",At:"Field of view of character",type:"number",min:30,max:60,round:!0,default:45,Kt:t=>{this.v=(1-t/100)*o,this.model.views.forEach(e=>e.mi())}}};this.Ji=Object.fromEntries(Object.entries(this.lt).map(([t,e])=>[e.name,t]));this.set=(t,e=!0)=>{if(!t)return;let i=!1;for(let[s,r]of Object.entries(t)){let n=this.lt[s];if(n&&typeof r===n.type){if(this[s]===r)continue;if(n.type==="number")if((!n.min||r>=n.min)&&(!n.max||r<=n.max))this[s]=n.round?Math.ceil(r):r;else continue;else this[s]=r;i=!0,n.Kt&&n.Kt(r)}}e&&i&&this.model.db.Hi(Object.fromEntries(Object.entries(this.get()).map(([s,r])=>[this.lt[s].name,r])))};this.model=t,this.reset(!1)}reset(t=!0){this.set(Object.fromEntries(Object.entries(this.lt).map(([e,i])=>[e,i.default])),t)}get(){return Object.fromEntries(Object.keys(this.lt).map(t=>[t,this[t]]))}};var rt=class{constructor(t){this.t=new a;this.H={};this.Nt=[L,B,q,N,R,H];this.ft=0;this.M={};this.status="menu";this.views=[];this.gt=[];this.R=-1;this.o=new st(this);this.Tt=()=>{var t;(t=this.F)==null||t.L.Tt(this.o.get(),this.o.set)};this.Je=t=>{let e=t.x%o/o-Math.sign(t.x)*.5,i=t.z%o/o-Math.sign(t.z)*.5,s=[this.ut(t)];return Math.abs(e)>.5-a.j&&s.push(s[0].P().$(Math.sign(e))),Math.abs(i)>.5-a.j&&s.push(s[0].P().Z(Math.sign(i))),Math.abs(e)>.5-a.j&&Math.abs(i)>.5-a.j&&s.push(s[0].P().$(Math.sign(e)).Z(Math.sign(i))),s};this.db=t,this.db.getSettings().then(e=>this.o.set(Object.fromEntries(Object.entries(e).map(([i,s])=>[this.o.Ji[i],s])),!1))}Xi(t){this.l=t}get F(){if(this.views.length)return this.views[0]}async oe(){return await this.db.oe()}$e(t,e,i={}){var s;this.t=t,this.H=i;for(let[r,n]of e)this.M[r]=new((s=D[n])!=null?s:M)(m.parse(r));this.pause()}async Bi(t){this.R=t;let[e,i,s,r,n]=await this.db.Ke(t),h=m.parse(e);this.$e(new a({yaw:s,pitch:r,x:h.x,y:h.y,z:h.z,yVelocity:i}),n)}Qi(){this.R=-1,this.M={},this.l&&this.l.disconnect()}async be(){await this.db.be(new m(0,a.g*o,0)),this.views.forEach(t=>t.C())}async de(t){var i;let e=async s=>{s&&(await this.db.de(t),this.views.forEach(r=>r.C()))};(i=this.F)==null||i.L.jt("Delete World","Are you sure you want to delete this world?",e)}async pe(t){var i;let e=async s=>{s&&(await this.db.pe(t,s.toString()),this.views.forEach(r=>r.C()))};(i=this.F)==null||i.L.ee("Rename World","New name:",e)}ye(t){return this.db.ye(t)}async fe(t){try{if(!dt(Object.keys(t),["name","lastPlayed","pos","yVelocity","yaw","pitch","objects"]))throw new Error("Corrupt File");if(!(typeof t.name=="string"&&t.name.length>0&&t.name.length<=69))throw new Error("Invalid name");if(!(typeof t.lastPlayed=="string"&&t.lastPlayed.length===24&&(e=>!isNaN(e)&&e.toISOString()===t.lastPlayed)(new Date(t.lastPlayed))))throw new Error("Invalid lastPlayed");if(!(m.we(t.pos)&&parseInt(t.pos.split("_")[1])>=a.g*o))throw new Error("Invalid pos");if(typeof t.yVelocity!="number")throw new Error("Invalid yVelocity");if(!(typeof t.yaw=="number"&&t.yaw<=2*Math.PI&&t.yaw>=-2*Math.PI))throw new Error("Invalid yaw");if(!(typeof t.pitch=="number"&&t.pitch<=Math.PI/2&&t.pitch>=-Math.PI/2))throw new Error("Invalid pitch");if(!(typeof t.objects=="object"&&Object.keys(t.objects).every(e=>m.we(e))&&Object.values(t.objects).every(e=>typeof e=="number"&&e===Math.floor(e)&&e>=0&&e<D.length)))throw new Error("Invalid objects");await this.db.fe(t),this.views.forEach(e=>e.C())}catch(e){console.error(`Import Error: ${e}`)}}ci(t){this.views.push(t)}Ii(t){this.gt.push(t)}ki(t){this.move(t),this.l&&this.l.isActive&&this.l.Ui()}start(){this.status!=="running"&&(this.status="running",this.gt.forEach(t=>t.start()),this.views.forEach(t=>t.start()))}pause(){this.status!=="paused"&&(this.R>=0&&this.db.ge(this.R,this.t.coords,this.t.p,this.t.m,this.t.pitch),this.status="paused",this.gt.forEach(t=>t.pause()),this.views.forEach(t=>t.pause()))}C(){this.status==="paused"&&(this.status="menu",this.Qi(),this.gt.forEach(t=>t.C()),this.views.forEach(t=>t.C()))}Re(t){return t.map(e=>e*o)}ut(t){return t.map(e=>Math.floor(e/o))}ie(t){return Math.floor(t+a.I)-Math.floor(t-a.g)+1}wt(t){let e=t.y-a.g*o;return this.t.p<=0&&e%o===0&&(e===0||this.Je(new m(t.x,e,t.z)).some(i=>this.M[i.X(-1).toString()]))}Xe(t,e,i,s,r){if(this.wt(new m(s,this.t.coords.y,r)))return this.t.coords.y;let n=(i-t)*e/1e3;return Math.round(this.t.coords.y+.5*a.G*Math.pow(n,2)+this.t.p*n)}Qe(t,e,i,s,r){let n;if(this.wt(new m(s,this.t.coords.y,r)))n=[s,r].map((h,c)=>((1+Math.sign(i.values[2*c])*a.j)%1*o-(o+h)%o)/i.values[2*c]);else{let h=(Math.floor(this.t.coords.y/o+a.I)+1)*o,c=Math.floor((this.t.coords.y-1)/o-a.g)*o,l=Math.sqrt(Math.pow(this.t.p/a.G,2)-2*(this.t.coords.y+a.I*o-h)/a.G);(isNaN(l)||this.t.p<0)&&(l=Math.sqrt(Math.pow(this.t.p/a.G,2)-2*(this.t.coords.y-a.g*o-c)/a.G)),n=[-1,1].map(d=>1e3*(-this.t.p/a.G+d*l)/e)}return{axis:1,S:Math.min(...n.filter(h=>h>=0))+t}}Zi(t){return isNaN(t)?1/0:t}move(t){let e=this.t.coords.P(),i=this.gt.some(u=>u.le),[s,r]=this.gt.map(u=>u.Ri()).flat().reduce(([u,f],[p,w])=>p==="x"?[u+w,f]:[u,f+w],[0,0]);t=o*Math.min(1/Math.sqrt(Math.pow(s,2)+Math.pow(r,2)),t*a.Xt/o)/a.Xt;let n=t*a.Xt,h=new m(s*this.t.m.cos-r*this.t.m.sin,0,s*this.t.m.sin+r*this.t.m.cos).map(u=>~~(u*n));i&&this.wt(this.t.coords)&&(this.t.p=a.hi);let c=this.t.coords.x+h.values[0],l=this.t.coords.z+h.values[2],d=0,y=[0,2].map(u=>({axis:u,S:this.Zi(((Math.sign(this.t.coords.values[u])-Math.sign(h.values[u])*a.j)%1*o-this.t.coords.values[u]%o)/h.values[u])}));for(y.push(this.Qe(d,t,h,this.t.coords.x,this.t.coords.z)),y.sort(({S:u},{S:f})=>u-f);y.length&&y[0].S<=1;){let{axis:u,S:f}=y.shift();if(f<0)continue;let p=c===this.t.coords.x+h.values[0]?this.t.coords.x+f*h.values[0]:c,w=l===this.t.coords.z+h.values[2]?this.t.coords.z+f*h.values[2]:l,j=this.Xe(d,t,f,p,w);if(u!=1){let C=u===0?w:p,O=C%o/o-Math.sign(C)*.5,k=this.ie(j/o),v=this.ut(new m(C,j-a.g*o,this.t.coords.values[u])).X(-1).Z(Math.sign(h.values[u])),V=v.P().$(Math.sign(O)),_=[v];Math.abs(O)>.5-a.j&&_.push(V),[...Array(k)].some((nt,F)=>_.some(S=>this.M[u==0?`${S.z}_${S.y+F+1}_${S.x}`:S.X(1).toString()]))?u==0?c=p:l=w:Math.abs(O)===.5-a.j&&Math.sign(O)*h.values[2-u]>0&&[...Array(k)].some((nt,F)=>this.M[u==0?`${V.z}_${V.y+F+1}_${V.x}`:V.X(1).toString()])&&(u==2?c=p:l=w)}else{let C=this.t.p<0&&this.wt(new m(p,j,w)),O=this.t.p>0&&this.Je(new m(p,j+a.I*o,w)).some(v=>this.M[v.toString()]),k=this.t.p===0&&!this.wt(new m(p,j,w));(C||O||k)&&(d=f,this.t.p=0,this.t.coords.y=j,y.push(this.Qe(d,t,h,p,w)),y.sort(({S:v},{S:V})=>v-V))}}this.t.coords.x=c,this.t.coords.z=l,this.t.coords.y=this.Xe(d,t,1,this.t.coords.x,this.t.coords.z),this.wt(this.t.coords)||(this.t.p+=a.G*(1-d)*t/1e3),!e.isEqual(this.t.coords)&&this.l&&this.l.isActive&&(this.l.Et=!0)}turn(t,e){this.t.m.set((this.t.m.angle-t)%(2*Math.PI)),this.t.pitch.set(Math.max(Math.min(this.t.pitch.angle+e,1/2*Math.PI),-1/2*Math.PI))}se(){let t=m.angle(this.t.m,this.t.pitch).u(a.ni);return[0,1,2].map(e=>{let i=(o-Math.sign(t.values[e])*(this.t.coords.values[e]%o))%o/Math.abs(t.values[e]),s=Math.floor((1-i)*Math.abs(t.values[e])/o);return i<=1?[...Array(s+1)].map((r,n)=>({axis:e,S:i+n*o/Math.abs(t.values[e])})):[]}).flat().sort(({S:e},{S:i})=>e-i).map(({axis:e,S:i})=>({k:this.ut(this.t.coords.add(t.u(i)).map(Math.round)).map((s,r)=>r==e&&t.values[r]<0?s-1:s),axis:e,dir:-Math.sign(t.values[e])})).find(({k:e})=>e.y<0||this.M[e.toString()])}ze(t){t>=0&&t<this.Nt.length&&(this.ft=Math.floor(t))}Gi(t,e){return!(t.coords.x<=(e.x-a.j)*o||t.coords.x>=(e.x+1+a.j)*o||t.coords.z<=(e.z-a.j)*o||t.coords.z>=(e.z+1+a.j)*o||t.coords.y<=(e.y-a.I)*o||t.coords.y>=(e.y+1+a.g)*o)}Ye(t){this.M[t.toString()]&&(delete this.M[t.toString()],this.R>=0&&(this.db.Ni(this.R,t),this.db.ge(this.R,this.t.coords,this.t.p,this.t.m,this.t.pitch)))}Si(){let t=this.se();t&&(this.Ye(t.k),this.l&&this.l.isActive&&this.l.yt.push([t.k.toString(),-1]))}Ue(t,e){this.M[t.toString()]||(this.M[t.toString()]=new e(t),this.R>=0&&(this.db.qi(this.R,t,e),this.db.ge(this.R,this.t.coords,this.t.p,this.t.m,this.t.pitch)))}Li(){let t=this.se();if(t){t.k.values[t.axis]+=t.dir;let e=t.k;[this.t,...Object.values(this.H)].some(i=>this.Gi(i,e))||(this.Ue(t.k,this.Nt[this.ft]),this.l&&this.l.isActive&&this.l.yt.push([e.toString(),D.indexOf(this.Nt[this.ft])]))}}};var pt=document.getElementById("error_screen"),gt=new tt;gt.ready.then(()=>{let b=new rt(gt);b.Xi(new it(b)),new A(b),new Z(b)}).catch(b=>{console.error(b),pt.querySelector("div").textContent="IDB Error: Please try deactivating private browsing or updating your browser",pt.style.display="flex"});})();
